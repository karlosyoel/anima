try{window||(self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}})}catch(e$$8){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(h,x,t,m,q){function r(a,c){if("object"!==typeof a)return n("enumerator validation failed, invalid type base object."),q;if(c===q)return q;if("number"===typeof c)return c;if("string"===typeof c){var g=parseInt(c,10);if(""!==c&&isFinite(g))return g;g=c.toUpperCase();g=a[g];if(g!==q)return g;n("enumerator validation failed, unknown enum value: "+c);var g="",e;for(e in a)a.hasOwnProperty(e)&&(""!==g&&(g+=", "),g+=e.toLowerCase());n("possible enum values are: "+g)}return q}var b="";try{for(var f=
x.querySelectorAll("script"),a=0,c=f.length;a<c;a++){var d=f[a].src.lastIndexOf("/CubicVR.js");-1<d&&(b=f[a].src.substr(0,d)+"/")}}catch(e){}var g=h.CubicVR={};g.contexts={};var n;try{n=void 0!==console&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(o){n=m}var s={quality:{LOW:0,MEDIUM:1,HIGH:2}};h.cubicvr=s;var E={},w=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],v=function(a){function c(a,g,e){var o=function(){};o.prototype=a.prototype;g.prototype=new o;for(var n in e)g.prototype[n]=
e[n];return g}var e=this,o;a&&(o=a+"",Object.defineProperty(this,"context",{enumerable:!0,configurable:!1,get:function(){return o}}));e.undef=q;e.nop=m;e.scriptLocation=b;e.GLCore=z;e.Textures=[];e.Textures_obj=[];e.Textures_ref=[];e.Images=[];e.ShaderPool=[];e.log=n;e.enums=g.enums;e.MAX_LIGHTS=6;e.extendClassGeneral=c;e.extendClass=function(a,g,e){return c(a,function(){a.apply(this);g.apply(this,arguments)},e)};e.features={};e.quality=g.enums.HIGH;var d={antiAlias:!1,lightPerPixel:!1,lightShadows:!1,
texturePerPixel:!1,postProcess:!1},f={antiAlias:!1,lightPerPixel:!0,lightShadows:!1,texturePerPixel:!1,postProcess:!1},v={antiAlias:!0,lightPerPixel:!0,lightShadows:!0,texturePerPixel:!0,postProcess:!0};e.features=v;var z={CoreShader_vs:null,CoreShader_fs:null,canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,fogLinear:!1,fogExp:!1,fogNoise:!1,fogColor:[1,1,1],fogDensity:0,fogNear:0,fogFar:0,
resize_active:!1,emptyLight:null,resizeList:[],canvasSizeFactor:1,init:function(a,c,o){var d,s=e.util,f=g.enums;if(c&&o){c=s.getScriptContents(c);o=s.getScriptContents(o)}else if(h.CubicVRShader.CubicVRCoreVS&&h.CubicVRShader.CubicVRCoreFS){c=h.CubicVRShader.CubicVRCoreVS;o=h.CubicVRShader.CubicVRCoreFS}else{c=s.getScriptContents(b+"CubicVR_Core.vs");o=s.getScriptContents(b+"CubicVR_Core.fs")}if(a===q){a=x.createElement("canvas");if(!d)try{d=a.getContext("experimental-webgl",{antialias:e.features.antiAlias})}catch(v){return null}z.gl=
d;if(z.fixed_size!==null){z.width=z.fixed_size[0];z.height=z.fixed_size[1];z.resizeElement(a,z.width,z.height)}else{z.addResizeable(a);if(z.canvasSizeFactor!==1&&a.getContext!==q){var s=t.round(h.innerWidth*z.canvasSizeFactor),w=t.round(h.innerHeight*z.canvasSizeFactor);z.resizeElement(a,s,w);a.style.top=h.innerHeight/2-w/2+"px";a.style.left=h.innerWidth/2-s/2+"px";a.style.position="absolute"}else z.resizeElement(a,h.innerWidth,h.innerHeight)}x.body.appendChild(a)}if(a.getContext!==q&&a.width!==q&&
a.height!==q){try{d||(d=a.getContext("experimental-webgl",{antialias:e.features.antiAlias}));d.viewport(0,0,a.width,a.height);z.canvas=a;z.width=a.width;z.height=a.height;d.clearColor(0,0,0,1);d.clearDepth(1);d.enable(d.DEPTH_TEST);d.depthFunc(d.LEQUAL)}catch(E){}if(!d)return null}else d=a;z.gl=d;z.CoreShader_vs=c;z.CoreShader_fs=o;d.enable(d.CULL_FACE);d.cullFace(d.BACK);d.frontFace(d.CCW);for(c=g.enums.light.type.NULL;c<f.light.type.MAX;c++)e.ShaderPool[c]=[];o=new e.Texture;a=new e.Material;for(c=
0;c<f.texture.map.MAX;c++)c!==f.texture.map.BUMP&&a.setTexture(o,c);a.opacity=0.5;for(c=1;;){if(!a.use(f.light.type.POINT,c)||c===8){e.MAX_LIGHTS=c;break}c++}a=z.emptyLight=new e.Light(f.light.type.POINT);a.diffuse=[0,0,0];a.specular=[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;n("Calibrated maximum lights per pass to: "+c);for(c=f.light.type.NULL;c<f.light.type.MAX;c++)e.ShaderPool[c]=[];if(z.resizeList.length){h.addEventListener("resize",function(){e.GLCore.onResize()},false);z.resize_active=true}return d},
addResizeable:function(a){e.GLCore.resizeList.push(a)},onResize:function(){var a=h.innerWidth,c=h.innerHeight;if(z.fixed_size!==null){a=e.GLCore.fixed_size[0];c=e.GLCore.fixed_size[1]}for(var g=0,o=e.GLCore.resizeList.length;g<o;g++)z.resizeElement(e.GLCore.resizeList[g],a,c)},setFixedAspect:function(a){e.GLCore.fixed_aspect=a},setFixedSize:function(a,c){e.GLCore.fixed_size=[a,c]},getCanvas:function(){return e.GLCore.canvas},resizeElement:function(a,c,g){var o=z.gl;if(z.fixed_aspect!==0){var d=c*
(1/e.GLCore.fixed_aspect);if(d>g){d=g;c=g*e.GLCore.fixed_aspect}g=d}if(a.getContext!==q){a.width=c;a.height=g;if(!e.GLCore.fixed_size){a.style.left=(h.innerWidth/2-c/2|0)+"px";a.style.top=(h.innerHeight/2-g/2|0)+"px";a.style.position="absolute"}o.viewport(0,0,c,g)}else a.resize(c,g)},setDepthAlpha:function(a,c,g){z.depth_alpha=a;z.depth_alpha_near=c;z.depth_alpha_far=g},setDefaultFilter:function(a){z.default_filter=r(e.enums.texture.filter,a)},setSoftShadows:function(a){z.soft_shadow=a},setFog:function(a){z.fog_enabled=
a},setFogExp:function(a,c){z.fog_enabled=true;z.fogLinear=false;z.fogExp=true;z.fogColor=a;z.fogDensity=c},setNoise:function(a){z.fogNoise=a},setFogLinear:function(a,c,g){z.fog_enabled=true;z.fogExp=false;z.fogLinear=true;z.fogColor=a;z.fogNear=c;z.fogFar=g},setCanvasSizeFactor:function(a){z.canvasSizeFactor=a},setQuality:function(a){a=r(s.quality,a);if(a===s.quality.HIGH)e.features=v;else if(a===s.quality.MEDIUM)e.features=f;else if(a===s.quality.LOW)e.features=d;e.quality=a;return e.features},getQuality:function(){return e.features}},
F=function(a,c,g){for(var o,d=x.getElementsByTagName("script"),n=0;n<d.length;++n){var s=d[n];if(s.getAttribute("data-cubicvr")){var b=s.getAttribute("src");if(b){var f=new XMLHttpRequest;f.open("GET",b,false);f.send(null);if(f.status===200||f.status===0)s.text=f.responseText}}}if(typeof a==="object")if(a.getContext)o=a;else{o=a.canvas;c=a.vertexShader||c;g=a.fragmentShader||g}else if(a){a[0]=="#"&&(a=a.substr(1));o=x.getElementById(a)}for(var v in E){var a=E[v](e),w;for(w in a)a.hasOwnProperty(w)&&
(e[w]=a[w])}z.init(o,c,g);return z.gl};e.GLCore=z;e.init=F;e.start=function(a,c,g,o,d){typeof a==="string"&&a.toLowerCase()==="auto"&&(a=q);g=g||"Sorry, your browser does not appear to support WebGL :-(";if(a=F(a,o,d)){c&&typeof c==="function"&&c(a,e.getCanvas());return a}if(!a){g&&typeof g==="function"?g():alert(g);return false}};e.addResizeable=z.addResizeable;e.setFixedAspect=z.setFixedAspect;e.setFixedSize=z.setFixedSize;e.setCanvasSizeFactor=z.setCanvasSizeFactor;e.getCanvas=z.getCanvas;e.enums=
s;e.IdentityMatrix=w;e.Textures=e.Textures;e.Textures_obj=e.Textures_obj;e.Images=e.Images;e.globalAmbient=[0.1,0.1,0.1];e.setGlobalAmbient=function(a){e.globalAmbient=a};e.setGlobalDepthAlpha=z.setDepthAlpha;e.setDefaultFilter=z.setDefaultFilter;e.setSoftShadows=z.setSoftShadows;e.setQuality=z.setQuality;e.getQuality=z.getQuality;e.RegisterModule=g.RegisterModule;e.getScriptLocation=g.getScriptLocation;e.setFogExp=z.setFogExp;e.setFogLinear=z.setFogLinear;e.setFogNoise=z.setFogNoise;e.parseEnum=
r};g.init=function(a,c,e){var o;a&&(a.context&&"string"===typeof a.context)&&(o=a.context);o=new v(o);if(o.context)return g.contexts[o.context]=o,o.init(a,c,e),o;h.CubicVR=g=o;o.init(a,c,e);return o.GLCore.gl};g.start=function(a,c,e,o,d){var n=new v;h.CubicVR=g=n;n.start(a,c,e,o,d);return n};g.RegisterModule=function(a,c){E[a]=c};g.getScriptLocation=function(){return b};g.enums=s})(window,window.document,Math,function(){});window.CubicVRShader={};
CubicVR.RegisterModule("Math",function(h){function x(a){return this.clearStack(a)}function t(){1===arguments.length&&(this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3]);4===arguments.length&&(this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3])}var m=h.undef,q=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],r=Math.PI/2,b={length:function(a,c){var d,e,g;c===m?(d=a[0],e=a[1],g=a[2]):(d=c[0]-a[0],e=c[1]-a[1],g=c[2]-a[2]);return Math.sqrt(d*d+e*
e+g*g)},normalize:function(a){var c=a[0],d=a[1],e=a[2];return(c=Math.sqrt(c*c+d*d+e*e))?[a[0]/c,a[1]/c,a[2]/c]:[0,0,0]},dot:function(a,c){return a[0]*c[0]+a[1]*c[1]+a[2]*c[2]},angle:function(a,c){return Math.acos((a[0]*c[0]+a[1]*c[1]+a[2]*c[2])/(Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2])))},cross:function(a,c){return[a[1]*c[2]-c[1]*a[2],a[2]*c[0]-c[2]*a[0],a[0]*c[1]-c[0]*a[1]]},multiply:function(a,c){return[a[0]*c,a[1]*c,a[2]*c]},add:function(a,c){return[a[0]+
c[0],a[1]+c[1],a[2]+c[2]]},subtract:function(a,c){return[a[0]-c[0],a[1]-c[1],a[2]-c[2]]},equal:function(a,c,d){d===m&&(d=1.0E-7);return a===m&&c===m?!0:a===m||c===m?!1:Math.abs(a[0]-c[0])<d&&Math.abs(a[1]-c[1])<d&&Math.abs(a[2]-c[2])<d},moveViewRelative:function(a,c,d,e,g){var n=Math.atan2(e,d),c=Math.atan2(c[2]-a[2],c[0]-a[0]),d=Math.sqrt(d*d+e*e),n=c+n+r;return"object"===typeof g?[g[0]+d*Math.cos(n),g[1],g[2]+d*Math.sin(n)]:[a[0]+d*Math.cos(n),a[1],a[2]+d*Math.sin(n)]},trackTarget:function(a,c,
d,e){var c=b.subtract(c,a),g=b.length(c),n;n=b.normalize(c);n=b.multiply(n,d*(1/(1/(g-e))));g>e?a=b.add(a,n):g<e?(n=b.normalize(c),n=b.multiply(n,d*(1/(1/Math.abs(g-e)))),a=b.subtract(a,n)):a=[a[0],a[1]+n[2],a[2]];return a},getClosestTo:function(a,c,d){c=b.subtract(c,a);d=b.subtract(d,a);return b.add(b.multiply(c,b.dot(c,d)/b.dot(c,c)),a)},linePlaneIntersect:function(a,c,d,e){var g=-a[0]*c[0]-a[1]*c[1]-a[2]*c[2],c=a[0]*(e[0]-d[0])+a[1]*(e[1]-d[1])+a[2]*(e[2]-d[2]);if(0.0010>Math.abs(c))return!1;a=
-(g+a[0]*d[0]+a[1]*d[1]+a[2]*d[2])/c;return[d[0]+a*(e[0]-d[0]),d[1]+a*(e[1]-d[1]),d[2]+a*(e[2]-d[2])]}},f={lookat:function(a,c,d,e,g,n,o,s,f){var w=[],v=[],m=[],v=[];w[0]=e-a;w[1]=g-c;w[2]=n-d;m[0]=o;m[1]=s;m[2]=f;w=b.normalize(w);v=b.cross(w,m);v=b.normalize(v);m=b.cross(v,w);v=[v[0],m[0],-w[0],0,v[1],m[1],-w[1],0,v[2],m[2],-w[2],0,0,0,0,1];e=new h.Transform(v);e.translate([-a,-c,-d]);return e.getResult()},multiply:function(a,c,d){d===m&&(d=[]);d[0]=a[0]*c[0]+a[4]*c[1]+a[8]*c[2]+a[12]*c[3];d[1]=
a[1]*c[0]+a[5]*c[1]+a[9]*c[2]+a[13]*c[3];d[2]=a[2]*c[0]+a[6]*c[1]+a[10]*c[2]+a[14]*c[3];d[3]=a[3]*c[0]+a[7]*c[1]+a[11]*c[2]+a[15]*c[3];d[4]=a[0]*c[4]+a[4]*c[5]+a[8]*c[6]+a[12]*c[7];d[5]=a[1]*c[4]+a[5]*c[5]+a[9]*c[6]+a[13]*c[7];d[6]=a[2]*c[4]+a[6]*c[5]+a[10]*c[6]+a[14]*c[7];d[7]=a[3]*c[4]+a[7]*c[5]+a[11]*c[6]+a[15]*c[7];d[8]=a[0]*c[8]+a[4]*c[9]+a[8]*c[10]+a[12]*c[11];d[9]=a[1]*c[8]+a[5]*c[9]+a[9]*c[10]+a[13]*c[11];d[10]=a[2]*c[8]+a[6]*c[9]+a[10]*c[10]+a[14]*c[11];d[11]=a[3]*c[8]+a[7]*c[9]+a[11]*c[10]+
a[15]*c[11];d[12]=a[0]*c[12]+a[4]*c[13]+a[8]*c[14]+a[12]*c[15];d[13]=a[1]*c[12]+a[5]*c[13]+a[9]*c[14]+a[13]*c[15];d[14]=a[2]*c[12]+a[6]*c[13]+a[10]*c[14]+a[14]*c[15];d[15]=a[3]*c[12]+a[7]*c[13]+a[11]*c[14]+a[15]*c[15];return d},vec4_multiply:function(a,c,d){d===m&&(d=[]);d[0]=c[0]*a[0]+c[4]*a[1]+c[8]*a[2]+c[12]*a[3];d[1]=c[1]*a[0]+c[5]*a[1]+c[9]*a[2]+c[13]*a[3];d[2]=c[2]*a[0]+c[6]*a[1]+c[10]*a[2]+c[14]*a[3];d[3]=c[3]*a[0]+c[7]*a[1]+c[11]*a[2]+c[15]*a[3];return d},vec3_multiply:function(a,c,d){d===
m&&(d=[]);d[0]=c[0]*a[0]+c[4]*a[1]+c[8]*a[2]+c[12];d[1]=c[1]*a[0]+c[5]*a[1]+c[9]*a[2]+c[13];d[2]=c[2]*a[0]+c[6]*a[1]+c[10]*a[2]+c[14];return d},perspective:function(a,c,d,e){a=Math.tan(a*Math.PI/360);return[1/(a*c),0,0,0,0,1/a,0,0,0,0,-(e+d)/(e-d),-1,0,0,-(2*e*d)/(e-d),0]},ortho:function(a,c,d,e,g,n){return[2/(c-a),0,0,0,0,2/(e-d),0,0,0,0,-2/(n-g),0,-(a+c)/(c-a),-(e+d)/(e-d),-(n+g)/(n-g),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*
a[15]-a[11]*a[13])+(a[0]*a[7]-a[3]*a[4])*(a[9]*a[14]-a[10]*a[13])+(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var c=[],d=a[0],e=a[1],g=a[2],n=a[4],o=a[5],s=a[6],b=a[8],f=a[9],a=a[10],v=a*o-s*f,m=-a*n+s*b,q=f*n-o*b,h=d*v+e*m+g*q;if(!h)return null;
h=1/h;c[0]=v*h;c[1]=(-a*e+g*f)*h;c[2]=(s*e-g*o)*h;c[3]=m*h;c[4]=(a*d-g*b)*h;c[5]=(-s*d+g*n)*h;c[6]=q*h;c[7]=(-f*d+e*b)*h;c[8]=(o*d-e*n)*h;return c},inverse:function(a,c){var d=a[0]*a[5]-a[1]*a[4],e=a[0]*a[6]-a[2]*a[4],g=a[0]*a[7]-a[3]*a[4],n=a[1]*a[6]-a[2]*a[5],o=a[1]*a[7]-a[3]*a[5],s=a[2]*a[7]-a[3]*a[6],b=a[8]*a[13]-a[9]*a[12],f=a[8]*a[14]-a[10]*a[12],v=a[8]*a[15]-a[11]*a[12],q=a[9]*a[14]-a[10]*a[13],h=a[9]*a[15]-a[11]*a[13],r=a[10]*a[15]-a[11]*a[14],t=d*r-e*h+g*q+n*v-o*f+s*b;return 0!==t?(c===m&&
(c=[]),c[0]=0+a[5]*r-a[6]*h+a[7]*q,c[4]=0-a[4]*r+a[6]*v-a[7]*f,c[8]=0+a[4]*h-a[5]*v+a[7]*b,c[12]=0-a[4]*q+a[5]*f-a[6]*b,c[1]=0-a[1]*r+a[2]*h-a[3]*q,c[5]=0+a[0]*r-a[2]*v+a[3]*f,c[9]=0-a[0]*h+a[1]*v-a[3]*b,c[13]=0+a[0]*q-a[1]*f+a[2]*b,c[2]=0+a[13]*s-a[14]*o+a[15]*n,c[6]=0-a[12]*s+a[14]*g-a[15]*e,c[10]=0+a[12]*o-a[13]*g+a[15]*d,c[14]=0-a[12]*n+a[13]*e-a[14]*d,c[3]=0-a[9]*s+a[10]*o-a[11]*n,c[7]=0+a[8]*s-a[10]*g+a[11]*e,c[11]=0-a[8]*o+a[9]*g-a[11]*d,c[15]=0+a[8]*n-a[9]*e+a[10]*d,d=1/t,c[0]*=d,c[1]*=d,
c[2]*=d,c[3]*=d,c[4]*=d,c[5]*=d,c[6]*=d,c[7]*=d,c[8]*=d,c[9]*=d,c[10]*=d,c[11]*=d,c[12]*=d,c[13]*=d,c[14]*=d,c[15]*=d,c):null},identity:function(a){if(a==m)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1},translate:function(a,c,d,e){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,c,d,1];if(e===m)return a;f.multiply(e.slice(0),a,e)},rotateAxis:function(a,c,d,e,g){var n=Math.sin(a*(Math.PI/180)),a=Math.cos(a*
(Math.PI/180)),c=[a+c*c*(1-a),c*d*(1-a)-e*n,c*e*(1-a)+d*n,0,d*c*(1-a)+e*n,a+d*d*(1-a),d*e*(1-a)-c*n,0,e*c*(1-a)-d*n,e*d*(1-a)+c*n,a+e*e*(1-a),0,0,0,0,1];if(g===m)return c;f.multiply(g.slice(0),c,g)},rotate:function(a,c,d,e){var g;e===m&&(e=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);0!==d&&(g=Math.sin(d*(Math.PI/180)),d=Math.cos(d*(Math.PI/180)),f.multiply(e.slice(0),[d,g,0,0,-g,d,0,0,0,0,1,0,0,0,0,1],e));0!==c&&(g=Math.sin(c*(Math.PI/180)),d=Math.cos(c*(Math.PI/180)),f.multiply(e.slice(0),[d,0,-g,0,0,1,0,
0,g,0,d,0,0,0,0,1],e));0!==a&&(g=Math.sin(a*(Math.PI/180)),d=Math.cos(a*(Math.PI/180)),f.multiply(e.slice(0),[1,0,0,0,0,d,g,0,0,-g,d,0,0,0,0,1],e));return e},scale:function(a,c,d,e){if(e===m)return[a,0,0,0,0,c,0,0,0,0,d,0,0,0,0,1];f.multiply(e.slice(0),[a,0,0,0,0,c,0,0,0,0,d,0,0,0,0,1],e)},transform:function(a,c,d){var e=f.identity();a&&f.translate(a[0],a[1],a[2],e);c&&(0===c[0]&&0===c[1]&&0===c[2]||f.rotate(c[0],c[1],c[2],e));d&&(1===d[0]&&1===d[1]&&1===d[2]||f.scale(d[0],d[1],d[2],e));return e}};
x.prototype={setIdentity:function(){this.m_stack[this.c_stack]=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=0;this.result=null;return this},getResult:function(){var a=h.mat4;if(!this.c_stack)return this.m_stack[0];var c=q;this.valid>this.c_stack-1&&(this.valid=this.c_stack-1);for(var d=this.valid;d<this.c_stack+1;d++)c=a.multiply(c,this.m_stack[d]),
this.m_cache[d]=c;this.valid=this.c_stack-1;return this.result=this.m_cache[this.c_stack]},pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:q;return this},popMatrix:function(){if(0!==this.c_stack)return this.c_stack--,this},clearStack:function(a){this.m_stack=[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;a!==m?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,c,d){var e=h.mat4;if("object"===typeof a)return this.translate(a[0],a[1],a[2]);var g=
this.getIdentity();g[12]=a;g[13]=c;g[14]=d;this.m_stack[this.c_stack]=e.multiply(this.m_stack[this.c_stack],g);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,c,d){var e=h.mat4;if("object"===typeof a)return this.scale(a[0],a[1],a[2]);var g=this.getIdentity();g[0]=a;g[5]=c;g[10]=d;this.m_stack[this.c_stack]=e.multiply(this.m_stack[this.c_stack],g);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},rotate:function(a,c,d,e){var g=h.mat4;if("object"===
typeof a)return this.rotate(a[0],1,0,0),this.rotate(a[1],0,1,0),this.rotate(a[2],0,0,1),this;var n,o;if(c||d||e)n=Math.sin(-a*(Math.PI/180)),o=Math.cos(-a*(Math.PI/180));c&&(a=this.getIdentity(),a[5]=o*c,a[9]=n*c,a[6]=-n*c,a[10]=o*c,this.m_stack[this.c_stack]=g.multiply(a,this.m_stack[this.c_stack]));d&&(c=this.getIdentity(),c[0]=o*d,c[8]=-n*d,c[2]=n*d,c[10]=o*d,this.m_stack[this.c_stack]=g.multiply(c,this.m_stack[this.c_stack]));e&&(d=this.getIdentity(),d[0]=o*e,d[4]=n*e,d[1]=-n*e,d[5]=o*e,this.m_stack[this.c_stack]=
g.multiply(d,this.m_stack[this.c_stack]));this.valid===this.c_stack&&this.c_stack&&this.valid--;return this}};t.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromMatrix:function(a){var c=1+a[0]+a[5]+a[10],d,e,g;1.0E-8<c?(d=2*Math.sqrt(c),c=(a[9]-a[6])/d,e=(a[2]-a[8])/d,g=(a[4]-a[1])/d,a=0.25*d):a[0]>a[5]&&a[0]>a[10]?(d=2*Math.sqrt(1+a[0]-a[5]-a[10]),
c=0.25*d,e=(a[4]+a[1])/d,g=(a[2]+a[8])/d,a=(a[9]-a[6])/d):a[5]>a[10]?(d=2*Math.sqrt(1+a[5]-a[0]-a[10]),c=(a[4]+a[1])/d,e=0.25*d,g=(a[9]+a[6])/d,a=(a[2]-a[8])/d):(d=2*Math.sqrt(1+a[10]-a[0]-a[5]),c=(a[2]+a[8])/d,e=(a[9]+a[6])/d,g=0.25*d,a=(a[4]-a[1])/d);this.x=c;this.y=e;this.z=g;this.w=a},fromEuler:function(a,c,d){var e=Math.cos(Math.PI/180*c/2),c=Math.sin(Math.PI/180*c/2),g=Math.cos(Math.PI/180*d/2),d=Math.sin(Math.PI/180*d/2),n=Math.cos(Math.PI/180*a/2),a=Math.sin(Math.PI/180*a/2),o=e*g,s=c*d;this.w=
o*n-s*a;this.x=o*a+s*n;this.y=c*g*n+e*d*a;this.z=e*d*n-c*g*a},toEuler:function(){var a=this.w*this.w,c=this.x*this.x,d=this.y*this.y,e=this.z*this.z,g=180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-c-d+e+a),n=180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*this.w)),a=180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),c-d-e+a);return[g,n,a]},multiply:function(a,c){c===m&&(c=a,a=this);return new t(a.x*c.w+a.w*c.x+a.y*c.z-a.z*c.y,a.y*c.w+a.w*c.y+a.z*c.x-a.x*c.z,a.z*c.w+a.w*c.z+a.x*c.y-a.y*
c.x,a.w*c.w-a.x*c.x-a.y*c.y-a.z*c.z)}};return{vec2:{equal:function(a,c,d){d===m&&(d=1.0E-8);return a===m&&c===m?!0:a===m||c===m?!1:Math.abs(a[0]-c[0])<d&&Math.abs(a[1]-c[1])<d},onLine:function(a,c,d){var e=a[1]<c[1]?a[1]:c[1],g=a[0]>c[0]?a[0]:c[0],n=a[1]>c[1]?a[1]:c[1];return(a[0]<c[0]?a[0]:c[0])<=d[0]&&d[0]<=g&&e<=d[1]&&d[1]<=n?!0:!1},lineIntersect:function(a,c,d,e){var g=a[0],a=a[1],n=c[0],c=c[1],o=d[0],d=d[1],s=e[0],e=e[1],b=(g-n)*(d-e)-(a-c)*(o-s);return 0===b?!1:[((o-s)*(g*c-a*n)-(g-n)*(o*e-
d*s))/b,((d-e)*(g*c-a*n)-(a-c)*(o*e-d*s))/b]},add:function(a,c){return[a[0]+c[0],a[1]+c[1]]},subtract:function(a,c){return[a[0]-c[0],a[1]-c[1]]},length:function(a,c){if(c===m)return Math.sqrt(a[0]*a[0]+a[1]*a[1]);var d=[a[0]-c[0],a[1]-c[1]];return Math.sqrt(d[0]*d[0]+d[1]*d[1])}},vec3:b,mat3:{transpose_inline:function(a){var c=a[1],d=a[2],e=a[5];a[1]=a[3];a[2]=a[6];a[3]=c;a[5]=a[7];a[6]=d;a[7]=e},vec3_multiply:function(a,c,d){d===m&&(d=[]);d[0]=c[0]*a[0]+c[3]*a[1]+c[6]*a[2];d[1]=c[1]*a[0]+c[4]*a[1]+
c[7]*a[2];d[2]=c[2]*a[0]+c[5]*a[1]+c[8]*a[2];return d}},mat4:f,aabb:{engulf:function(a,c){a[0][0]>c[0]&&(a[0][0]=c[0]);a[0][1]>c[1]&&(a[0][1]=c[1]);a[0][2]>c[2]&&(a[0][2]=c[2]);a[1][0]<c[0]&&(a[1][0]=c[0]);a[1][1]<c[1]&&(a[1][1]=c[1]);a[1][2]<c[2]&&(a[1][2]=c[2])},reset:function(a,c){void 0===c&&(c=[0,0,0]);a[0][0]=c[0];a[0][1]=c[1];a[0][2]=c[2];a[1][0]=c[0];a[1][1]=c[1];a[1][2]=c[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],
a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]}},plane:{classifyPoint:function(a,c){var d=a[0]*c[0]+a[1]*c[1]+a[2]*c[2]+a[3];return 0>d?-1:0<d?1:0},normalize:function(a){var c=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=c;a[1]/=c;a[2]/=c;a[3]/=c}},sphere:{intersects:function(a,c){var d=h.vec3.subtract([a[0],a[1],a[2]],[c[0],c[1],c[2]]),d=Math.sqrt(d[0]*d[0]+d[1]*d[1]+d[2]*d[2]),e=a[3]+c[3];return d*d<e*e?!0:!1}},triangle:{normal:function(a,c,d,e){e===m&&(e=[]);var g=a[0]-c[0],n=a[1]-c[1],a=a[2]-
c[2],o=c[0]-d[0],s=c[1]-d[1],c=c[2]-d[2];e[0]=n*c-a*s;e[1]=a*o-g*c;e[2]=g*s-n*o;return e}},Transform:x,Quaternion:t}});
CubicVR.RegisterModule("Utility",function(h){var x=h.undef,t=h.log,m={},q={},r={multiSplit:function(b,f){for(var a=b.split(f[0]),c=1,d=f.length;c<d;c++)for(var e=f[c],g=0,n=a.length;g<n;g++){var o=a[g].trim().split(e),s=!0;if(1<o.length)for(var E=0;E<o.length;E++)""!==o[E].trim()&&(a.splice(g+E,0===E?1:0,o[E]),E&&n++,s=!1);else a[g]=a[g].trim().replace(e,""),""!==a[g]&&(s=!1);s&&(a.splice(g,1),n--,g--)}return a},getJSONScriptObj:function(b,f){if("string"===typeof b&&0<b.length&&"#"===b.charAt(0)){var a=
document.getElementById(b.substr(1));if(a)return a=JSON.parse(a.innerHTML||a.text),f&&f(a),a}return b},getScriptContents:function(b){var f=document.getElementById(b),a="",c="";if(f){if(""!==f.src||f.attributes.srcUrl!==x)c=""!==f.src?f.src:f.attributes.srcUrl.value}else c=b;if(0!==c.length){if(b=new XMLHttpRequest,b.overrideMimeType&&b.overrideMimeType("application/json"),b.open("GET",c,!1),b.send(null),200===b.status||0===b.status)a=b.responseText}else for(c=f.firstChild;c;)3===c.nodeType&&(a+=c.textContent),
c=c.nextSibling;return a},xmlNeedsBadgerFish:function(b){for(b=[b];b.length;){var f=b.pop();if(f.attributes&&f.attributes.length)return!0;for(var a=0,c=f.childNodes.length;a<c;a++)b.push(f.childNodes[a])}return!1},getFirstEntry:function(b){for(var f in b)if(b.hasOwnProperty(f))return b[f]},getURIFileType:function(b){function f(a){for(var c in d)if(d.hasOwnProperty(c)&&-1!==d[c].indexOf(a))return c;return x}var a=b.toLowerCase(),c=["_ext","ext"],d={json:["js","javascript","json"],xml:["xml"]};if(-1!==
a.indexOf("?")){var e=a.split("?"),a=e[0];if(e[1])for(var e=-1===e[1].indexOf("&")?[e[1]]:e[1].split("&"),g=0,n=e.length;g<n;g++){var o=e[g];if(-1!==o.indexOf("=")&&(o=o.split("="),-1!==c.indexOf(o[0]))){var s=f(o[1]);if(s)return s;t("Unable to determine extension type '"+o[1]+"' provided for URI: ["+b+"], falling back to filename part.")}}}return-1!==a.indexOf(".")?(b=a.split("."),f(b[b.length-1])):x},get:function(b,f){var a=null,c=null,d=null,f=f||null;if(b===x)return x;if(isFinite(b))return b;
"function"===typeof b&&(b=b(f));if("object"===typeof b)return f&&!(b instanceof f)?new f(b):b;if("string"==typeof b){if(-1!==b.indexOf("\n"))return b;"#"==b[0]&&(a=b.substr(1),(d=document.getElementById(a))&&(c=d.src||null));!d&&(!a&&!c&&b)&&(c=b)}if(d&&!c)return CubicVR.util.collectTextNode(d);if(c){var a=null,e=q[c]||null;if(!e){var g=r.getURIFileType(c);if(g===x&&!d)return c;"json"===g?e=CubicVR.util.getJSON(c):a="xml"===g?CubicVR.util.getXML(c):CubicVR.util.getURL(c);a&&a.childNodes?e=r.getFirstEntry(r.xml2json(a)):
a&&(e=a)}e&&q[c]===x&&(q[c]=e);if(f){if(m[c]&&m[c]instanceof f)return m[c];if(e)return m[c]=new f(e),m[c]}else if(e)return e;return c}a&&!d&&console.log("Unable to retrieve requested ID: '"+b+"'");return x},clearCache:function(){m={};q={}},getURL:function(b){try{var f=new XMLHttpRequest;f.open("GET",b,!1);f.send(null);if(200===f.status||0===f.status){if(f.responseText.length)return f.responseText;if(f.responseXML)return f.responseXML}}catch(a){alert(b+" failed to load.")}return null},getXML:function(b){try{var f=
new XMLHttpRequest;f.open("GET",b,!1);f.overrideMimeType("application/xml");f.send(null);if(200===f.status||0===f.status)return f.responseXML}catch(a){try{alert(b+" failed to load.")}catch(c){throw a;}}return null},getJSON:function(b){try{var f=new XMLHttpRequest;f.open("GET",b,!1);f.overrideMimeType("application/json");f.send(null);if(200===f.status||0===f.status)return eval("("+f.responseText+")")}catch(a){try{alert(b+" failed to load.")}catch(c){throw a;}}return null},repackArray:function(b,f,
a){b.length!==parseInt(f,10)*parseInt(a,10)&&t("array repack error, data size !== stride*count: data.length="+b.length+" stride="+f+" count="+a);for(var a=[],c=0,d=0,e=b.length;d<e;d++){var g=d%f;0===g&&(a[c]=[]);a[c][g]=b[d];g===f-1&&c++}return a},collectTextNode:function(b){if(!b)return"";for(var f="",b=b.childNodes,a=0,c=b.length;a<c;a++)f+=b[a].nodeValue;return f},floatDelimArray:function(b,f){"\n"!=f&&(b=b.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=b.split(f?f:","),c=0,d=a.length;c<
d;c++)a[c]=parseFloat(a[c]);a[a.length-1]!==a[a.length-1]&&a.pop();return a},intDelimArray:function(b,f){"\n"!=f&&(b=b.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=b.split(f?f:","),c=0,d=a.length;c<d;c++)a[c]=parseInt(a[c],10);a[a.length-1]!==a[a.length-1]&&a.pop();return a},textDelimArray:function(b,f){"\n"!=f&&(b=b.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=b.split(f?f:","),c=0,d=a.length;c<d;c++)a[c]=a[c];return a},xmlstring2json:function(b){for(var b=b.replace(/<\!--.*?--\>/gm,
"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),f=/^\s+$/gm,a,c=[],d=[],e={},g=e,n=0,o=b.length;n<o;n++){var s=b[n];if(!(f.test(s)||""===s)&&!/<\?\s?xml[^>]*>/.test(s))if(/<.*?>/.test(s)){a=s.split(/<([^>]*?)(.*)?>/g)[2];if("/"!==a[0]&&(s=a.split(" "),a=s[0],s=s.slice(1).join(" "),c.push(a),d.push(e),e[a]&&!(e[a]instanceof Array)?e[a]=[e[a]]:(e[a]||(e[a]={}),e=e[a]),e instanceof Array&&(e.push({}),e=e[e.length-1]),"/"===a.substr(a.length-1)||"/"===s.substr(s.length-1)))a="/"+a;if("/"===a[0]){a=
a.substr(1);if(c.length&&c[c.length-1]!==a)return console.log("Unmatched tag, aborting: "+a),!1;c.pop();e=d.length?d[d.length-1]:null;d.pop()}}else{var E=d[d.length-1][a];E instanceof Array?(E.pop(),E.push(r.parseNumeric(s))):d[d.length-1][a]=r.parseNumeric(s)}}return g},xmlstring2badgerfish:function(b){for(var b=b.replace(/<\!--.*?--\>/gm,"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),f=/^\s+$/gm,a,c=[],d=[],e={},g=e,n=0,o=b.length;n<o;n++)if(a=b[n],!(f.test(a)||""===a)&&!/<\?\s?xml[^>]*>/.test(a))if(/<.*?>/.test(a)){a=
a.split(/<([^>]*?)(.*)?>/g)[2];if("/"!==a[0]){var s=a.split(" ");a=s[0];s=s.slice(1).join(" ");c.push(a);d.push(e);e[a]&&!(e[a]instanceof Array)?e[a]=[e[a]]:e[a]||(e[a]={});e=e[a];e instanceof Array&&(e.push({}),e=e[e.length-1]);if("/"===a.substr(a.length-1)||"/"===s.substr(s.length-1))a="/"+a;for(var s=r.multiSplit(s,"= "),E="",w=0;w<s.length;w++){var v=s[w];"/"===v[v.length-1]&&(v=v.substr(0,v.length-1));if(1===w%2){if("'"===v[0]||'"'===v[0]){for(var m=v[0],v=v.substr(1);v[v.length-1]!==m&&s.length+
1<w;)v+=s.splice(w+1,1);v[v.length-1]===m&&(v=v.substr(0,v.length-1))}e["@"+E]=v}else E=v}}if("/"===a[0]){a=a.substr(1);if(c.length&&c[c.length-1]!==a)return console.log("Unmatched tag, aborting: "+c[c.length-1]),!1;c.pop();e=d.length?d[d.length-1]:null;d.pop()}}else e.$=a;return g},xml2badgerfish:function(b){var f={},a=[],c,d,e,g,n,o=/^\s+|\s+$/g;b.jsonParent=f;for(a.push(b);a.length;){d=a.pop();var s=null;e=d.jsonParent;b=0;for(c=d.childNodes.length;b<c;b++)g=d.childNodes[b],n=g.tagName,n!==x&&
(s=s||{},s[n]=s[n]||0,s[n]++);if(d.attributes&&d.attributes.length){b=0;for(c=d.attributes.length;b<c;b++)g=d.attributes[b],e["@"+g.name]=g.value}b=0;for(c=d.childNodes.length;b<c;b++)g=d.childNodes[b],n=g.tagName,1===g.nodeType?(1<s[n]?(e[n]=e[n]||[],e[n].push({}),g.jsonParent=e[n][e[n].length-1]):(e[n]=e[n]||{},g.jsonParent=e[n]),a.push(g)):3===g.nodeType&&""!==g.nodeValue.replace(o,"")&&(e.$=e.$||"",e.$+=g.nodeValue)}return f},isTextNode:function(b){for(var b=b.childNodes,f=0,a=b.length;f<a;f++)if(3!==
b[f].nodeType||b[f].childNodes.length)return!1;return!0},parseNumeric:function(b){var f=null,a,f=b.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\n/g," ").replace(/ *, */gm,",").replace(/\s+/g," ");if(""===f)return f;if((-1!==f.indexOf(" ")||-1!==f.indexOf(","))&&/[0-9\.,e\-\+ ]+/g.test(f))if(/[^0-9\-\+]+/g.test(f))if(/[^0-9\- ]+/g.test(f))if(/[^0-9\-,]+/g.test(f))if(/[^0-9\.e\-\+ ]+/g.test(f))if(/[^0-9\.,e\+\-]+/g.test(f))if(/[^0-9,\-\+ ]+/g.test(f)){if(!/[^0-9\.,e\-\+ ]+/g.test(f)){f=f.split(" ");
b=0;for(a=f.length;b<a;b++)f[b]=r.floatDelimArray(f[b],",");return f}}else{f=f.split(" ");b=0;for(a=f.length;b<a;b++)f[b]=r.intDelimArray(f[b],",");return f}else return r.floatDelimArray(f,",");else return r.floatDelimArray(f," ");else return r.intDelimArray(f,",");else return r.intDelimArray(f," ");else return parseInt(f,10);a=parseFloat(f);return!isNaN(a)?/[^0-9\-\+]+/g.test(f)?a:parseInt(f,10):b},xml2json:function(b){var f={},a=[],c,d,e,g,n;b.jsonParent=f;for(a.push(b);a.length;){d=a.pop();var o=
null;e=d.jsonParent;b=0;for(c=d.childNodes.length;b<c;b++)g=d.childNodes[b],n=g.tagName,n!==x&&(o=o||{},o[n]=o[n]||0,o[n]++);b=0;for(c=d.childNodes.length;b<c;b++){g=d.childNodes[b];n=g.tagName;var s=r.isTextNode(g);1===g.nodeType&&(1<o[n]?(e[n]=e[n]||[],s?e[n].push(r.parseNumeric(r.collectTextNode(g))):(e[n].push({}),g.jsonParent=e[n][e[n].length-1])):s?e[n]=r.parseNumeric(r.collectTextNode(g)):(e[n]=e[n]||{},g.jsonParent=e[n]),s||a.push(g))}}return f},lzwCompress:function(b){var f={},b=(b+"").split(""),
a=[],c,d=b[0],e=256,g;for(g=1;g<b.length;g++)c=b[g],null!==f[d+c]?d+=c:(a.push(1<d.length?f[d]:d.charCodeAt(0)),f[d+c]=e,e++,d=c);a.push(1<d.length?f[d]:d.charCodeAt(0));for(g=0;g<a.length;g++)a[g]=String.fromCharCode(a[g]);return a.join("")},lzwDecompress:function(b){for(var f={},b=(b+"").split(""),a=b[0],c=a,d=[a],e=256,g,n=1;n<b.length;n++)g=b[n].charCodeAt(0),g=256>g?b[n]:f[g]?f[g]:c+a,d.push(g),a=g.charAt(0),f[e]=c+a,e++,c=g;return d.join("")}};return{util:r,get:r.get,clearCache:r.clearCache}});
"undefined"===typeof Iuppiter&&(Iuppiter={version:"3026 $".replace(" $","")});Iuppiter.toByteArray=function(h){var x=[],t,m;for(t=0;t<h.length;t++)m=h.charCodeAt(t),127>=m?x.push(m):(2047>=m?x.push(m>>6|192):(65535>=m?x.push(m>>12|224):(x.push(m>>18|240),x.push(m>>12&63|128)),x.push(m>>6&63|128)),x.push(m&63|128));return x};
Iuppiter.Base64={CA:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",CAS:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",IA:Array(256),IAS:Array(256),init:function(){var h;for(h=0;256>h;h++)Iuppiter.Base64.IA[h]=-1,Iuppiter.Base64.IAS[h]=-1;h=0;for(iS=Iuppiter.Base64.CA.length;h<iS;h++)Iuppiter.Base64.IA[Iuppiter.Base64.CA.charCodeAt(h)]=h,Iuppiter.Base64.IAS[Iuppiter.Base64.CAS.charCodeAt(h)]=h;Iuppiter.Base64.IA["="]=Iuppiter.Base64.IAS["="]=0},encode:function(h,
x){var t,m,q,r,b,f,a,c,d;t=x?Iuppiter.Base64.CAS:Iuppiter.Base64.CA;q=h.constructor==Array?h:Iuppiter.toByteArray(h);r=q.length;b=3*(r/3);f=(r-1)/3+1<<2;m=Array(f);for(c=a=0;a<b;)d=(q[a++]&255)<<16|(q[a++]&255)<<8|q[a++]&255,m[c++]=t.charAt(d>>18&63),m[c++]=t.charAt(d>>12&63),m[c++]=t.charAt(d>>6&63),m[c++]=t.charAt(d&63);a=r-b;0<a&&(d=(q[b]&255)<<10|(2==a?(q[r-1]&255)<<2:0),m[f-4]=t.charAt(d>>12),m[f-3]=t.charAt(d>>6&63),m[f-2]=2==a?t.charAt(d&63):"=",m[f-1]="=");return m.join("")},decode:function(h,
x){var t,m,q,r,b,f,a,c,d,e,g,n;t=x?Iuppiter.Base64.IAS:Iuppiter.Base64.IA;h.constructor==Array?(q=h,b=!0):(q=Iuppiter.toByteArray(h),b=!1);r=q.length;f=0;for(a=r-1;f<a&&0>t[q[f]];)f++;for(;0<a&&0>t[q[a]];)a--;c="="==q[a]?"="==q[a-1]?2:1:0;m=a-f+1;d=76<r?("\r"==q[76]?m/78:0)<<1:0;r=(6*(m-d)>>3)-c;m=Array(r);g=e=0;for(eLen=3*(r/3);e<eLen;)n=t[q[f++]]<<18|t[q[f++]]<<12|t[q[f++]]<<6|t[q[f++]],m[e++]=n>>16&255,m[e++]=n>>8&255,m[e++]=n&255,0<d&&19==++g&&(f+=2,g=0);if(e<r){for(d=n=0;f<=a-c;d++)n|=t[q[f++]]<<
18-6*d;for(t=16;e<r;t-=8)m[e++]=n>>t&255}if(b)return m;for(n=0;n<m.length;n++)m[n]=String.fromCharCode(m[n]);return m.join("")}};Iuppiter.Base64.init();
(function(){Iuppiter.compress=function(h){var x=[],t,m=0,q=0,r,b,f=128,a,c,d=Array(256);for(t=0;256>t;t++)d[t]=3435973836;h=h.constructor==Array?h:Iuppiter.toByteArray(h);for(t=h.length;m<t;){if(256==(f<<=1)){if(q>=t-1-16){a=t;for(q=m=0;a;a--)x[q++]=h[m++];break}f=1;b=q;x[q++]=0}if(m>t-66)x[q++]=h[m++];else if(r=(h[m]+13^h[m+1]-13^h[m+2])&255,c=m-d[r]&1023,d[r]=m,r=m-c,0<=r&&r!=m&&h[m]==h[r]&&h[m+1]==h[r+1]&&h[m+2]==h[r+2]){x[b]|=f;for(a=3;66>a&&h[m+a]==h[r+a];a++);x[q++]=a-3<<2|c>>8;x[q++]=c;m+=
a}else x[q++]=h[m++]}return x};Iuppiter.decompress=function(h,x){var t,m=[],q,r=0,b=0,f,a,c=128,d;t=h.constructor==Array?h:Iuppiter.toByteArray(h);for(q=t.length;r<q;){if(256==(c<<=1))c=1,a=t[r++];if(a&c)if(d=(t[r]>>2)+3,f=(t[r]<<8|t[r+1])&1023,r+=2,0<=(f=b-f))for(;0<=--d;)m[b++]=m[f++];else break;else m[b++]=t[r++]}if(!("undefined"==typeof x?0:x)){for(t=0;t<b;t++)m[t]=String.fromCharCode(m[t]);m=m.join("")}return m}})();
CubicVR.RegisterModule("Shader",function(h){function x(e,g){var d=h.util,o,s,f,w,v=q.gl;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];this.success=!0;this.fragmentLog=this.vertexLog="";-1!==e.indexOf("\n")?(f=e,o=a(q.gl,e,"x-shader/x-vertex")):(o=c(q.gl,e),null===o&&(f=d.getURL(e),o=a(q.gl,f,"x-shader/x-vertex")));v.getShaderParameter(o,v.COMPILE_STATUS)||(this.vertexLog=v.getShaderInfoLog(o),this.success=!1);-1!==g.indexOf("\n")?(w=g,s=a(q.gl,g,"x-shader/x-fragment")):(s=c(q.gl,
g),null===s&&(w=d.getURL(g),s=a(q.gl,w,"x-shader/x-fragment")));v.getShaderParameter(s,v.COMPILE_STATUS)||(this.fragmentLog=v.getShaderInfoLog(s),this.success=!1);this.success?(this.shader=v.createProgram(),v.attachShader(this.shader,o),v.attachShader(this.shader,s),v.linkProgram(this.shader),q.gl.getProgramParameter(this.shader,v.LINK_STATUS)||(b("Error linking shader:\n"+v.getProgramInfoLog(this.shader)),this.success=!1)):(o=d.multiSplit(this.vertexLog,";\n"),d=d.multiSplit(this.fragmentLog,";\n"),
o.length&&this.dumpErrors(o,f),d.length&&this.dumpErrors(d,w))}function t(a){this._update=a.update||null;this._init=a.init||null;this._vertex=h.get(a.vertex)||null;this._fragment=h.get(a.fragment)||null;this._bindings=[];this._shaderVars=this._shaderInfo=this._shader=null;this._initialized=!1;a=(this._vertex||"")+(this._fragment||"");this._hasDepthPack=""!==a.trim()?/\s\!?LIGHT_DEPTH_PASS\s/.test(a):!1}var m=h.undef,q=h.GLCore,r=h.enums,b=h.log,f=h.util;r.shader={map:{COLOR:1,SPECULAR:2,NORMAL:4,
BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128,COLORMAP:256},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var a=function(a,c,d){if("x-shader/x-fragment"===d)d=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===d)d=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(d,c);a.compileShader(d);return d},c=function(a,c){var d=document.getElementById(c);if(!d)return null;for(var o="",s=d.firstChild;s;)3===s.nodeType&&(o+=s.textContent),
s=s.nextSibling;if("x-shader/x-fragment"===d.type)d=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===d.type)d=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(d,o);a.compileShader(d);return d};x.prototype={isCompiled:function(){return this.success},dumpErrors:function(a,c,d){for(var d=(d||"Error on line")+" ",c=c.split("\n"),o=0,s=a.length;o<s;o++){var b=a[o];if(0===b.indexOf("ERROR: ")){var b=b.substr(7).trim(),f=b.substr(0,b.indexOf(" ")),b=b.substr(f.length),f=f.split(":"),
f=parseInt(f[1],10);console.log(f+"> "+c[f-1]);console.log(d+f+", :"+b)}}},bindSelf:function(a){var c,d,o;-1!==a.indexOf(".")?-1!==a.indexOf("[")?(c=a.split("["),o=c[0],c=c[1].split("]"),d=c[0],c=c[1].split("."),c=c[1],this[o]===m&&(this[o]=[]),this[o][d]===m&&(this[o][d]={}),this[o][d][c]=this.uniforms[a]):(c=a.split("."),o=c[0],c=c[1],this[o]===m&&(this[o]={}),this[o][c]=this.uniforms[a]):-1!==a.indexOf("[")?(c=a.split("["),o=c[0],c=c[1].split("]"),d=c[0],this[o]===m&&(this[o]=[]),this[o][d]=this.uniforms[a]):
this[a]=this.uniforms[a]},addMatrix:function(a,c){this.use();this.uniforms[a]=q.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==m&&this.setMatrix(a,c);this.bindSelf(a);return this.uniforms[a]},addVector:function(a,c){this.use();this.uniforms[a]=q.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
c!==m&&this.setVector(a,c);this.bindSelf(a);return this.uniforms[a]},addFloat:function(a,c){this.use();this.uniforms[a]=q.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==m&&this.setFloat(a,c);this.bindSelf(a);return this.uniforms[a]},addVertexArray:function(a){this.use();this.uniforms[a]=q.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.ARRAY_VERTEX;this.uniform_typelist.push([this.uniforms[a],
this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addUVArray:function(a){this.use();this.uniforms[a]=q.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addFloatArray:function(a){this.use();this.uniforms[a]=q.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
this.bindSelf(a);return this.uniforms[a]},addInt:function(a,c){this.use();this.uniforms[a]=q.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==m&&this.setInt(a,c);this.bindSelf(a);return this.uniforms[a]},use:function(){q.gl.useProgram(this.shader)},setMatrix:function(a,c){var d=this.uniforms[a];if(null!==d){var o=c.length;16===o?q.gl.uniformMatrix4fv(d,!1,c):9===o?q.gl.uniformMatrix3fv(d,!1,c):4===
o&&q.gl.uniformMatrix2fv(d,!1,c)}},setInt:function(a,c){var d=this.uniforms[a];null!==d&&q.gl.uniform1i(d,c)},setFloat:function(a,c){var d=this.uniforms[a];null!==d&&q.gl.uniform1f(d,c)},setVector:function(a,c){var d=this.uniforms[a];if(null!==d){var o=c.length;3==o?q.gl.uniform3fv(d,c):2==o?q.gl.uniform2fv(d,c):q.gl.uniform4fv(d,c)}},clearArray:function(a){var c=q.gl,a=this.uniforms[a];null!==a&&c.disableVertexAttribArray(a)},bindArray:function(a,c){var d=q.gl,o=this.uniforms[a];if(null!==o){var s=
this.uniform_type[a];s===r.shader.uniform.ARRAY_VERTEX?(d.bindBuffer(d.ARRAY_BUFFER,c),d.vertexAttribPointer(o,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(o)):s===r.shader.uniform.ARRAY_UV?(d.bindBuffer(d.ARRAY_BUFFER,c),d.vertexAttribPointer(o,2,d.FLOAT,!1,0,0)):s===r.shader.uniform.ARRAY_FLOAT&&(d.bindBuffer(d.ARRAY_BUFFER,c),d.vertexAttribPointer(o,1,d.FLOAT,!1,0,0))}}};var d={tidyScript:function(a){return a.replace(/\t+/g," ").replace(/\/\/.*$/gm,"").replace(/\/\*(.|\n)*\*\//g,"").replace(/ +/g,
" ").replace(/ *\[ */g,"[").replace(/ *\] */g,"]").replace(/ *; */g,";").replace(/ *$/gm,"").replace(/^ */gm,"")},getDefines:function(a){var c={},a=f.multiSplit(a,"\n;");i=0;for(iMax=a.length;i<iMax;i++){var d=a[i];0===d.indexOf("#define")&&(d=d.split(" "),2<d.length&&(c[d[1]]=d.slice(2).join(" ")))}return c},replaceAll:function(a,c,d,o){var d=d||"",o=o||"",s;for(s in c)if(c.hasOwnProperty(s))for(var b=d+s+o;-1!==a.indexOf(b);)a=a.replace(b,d+c[s]+o);return a},getShaderInfo:function(a,c){var n,o,
s,b,w,v,q=["uniform","attribute","varying"],h=[],r={};v={};var t;c===m&&(c="");a=d.tidyScript(a);c=d.tidyScript(c);r.v_define=d.getDefines(a);r.f_define=d.getDefines(c);a=d.replaceAll(a,r.v_define,"[","]");c=d.replaceAll(c,r.f_define,"[","]");t=f.multiSplit(a+"\n"+c,"\n;");var u=[];b=s=-1;n=0;for(o=t.length;n<o;n++)w=t[n],-1===s&&0===w.indexOf("struct")?s=n:-1===b&&(-1!==s&&-1!==w.indexOf("}"))&&(b=n+1),-1!==s&&-1!==b&&(w=t.slice(s,b).join("\n").replace(/(\{|\})/g,"\n").replace(/ +$/gm,"").replace(/^ +/gm,
"").replace(/\n\n/gm,"\n"),u.push({start:s,end:b,struct:w.split("\n")}),b=s=-1);n=0;for(o=u.length;n<o;n++){var y=u[n].struct,D=null;s=0;for(b=y.length;s<b;s++)w=y[s].split(" "),1>=w.length||("struct"==w[0]?(D=w[1],v[D]={}):D&&(v[D][w[1]]=w[0]))}r.struct=v;n=0;for(o=q.length;n<o;n++)r[q[n]]=[];n=0;for(o=t.length;n<o;n++){w=t[n];s=0;for(b=q.length;s<b;s++)if(u=q[s],0===w.indexOf(u)&&(v=w.split(" "),3===v.length&&v[0]==u&&-1===h.indexOf(v[2])))if(h.push(v[2]),-1!==v[2].indexOf("[")){var y=v[2].split("["),
D=y[1].replace("]",""),z=parseInt(D,10);z===z&&(D=z);r[u].push({name:y[0],type:v[1],isArray:!0,len:D})}else r[u].push({name:v[2],type:v[1]})}return r},genShaderVarList:function(a,c){var d=a[c],o=[],s,b,f,v,m,q;if(!d)return[];s=0;for(b=d.length;s<b;s++){var h=d[s];if(a.struct[h.type]){var r=a.struct[h.type];if(r&&h.isArray){f=0;for(v=h.len;f<v;f++)for(q in m=h.name+"["+f+"]",r)r.hasOwnProperty(q)&&o.push({location:m+"."+q,type:r[q],basename:h.name})}else for(q in r)o.push({location:h.name+"."+q,type:r[q],
basename:h.name})}else if(h.isArray){f=0;for(v=h.len;f<v;f++)m=h.name+"["+f+"]",o.push({location:m,type:h.type,basename:h.name})}else o.push({location:h.name,type:h.type,basename:h.name})}return o},getShaderVars:function(a){var c={};c.uniform=d.genShaderVarList(a,"uniform");c.attribute=d.genShaderVarList(a,"attribute");return c}};t.prototype={use:function(){this._initialized&&this._shader.use()},getShader:function(){return this._shader},ready:function(){return this._initialized},isReady:function(){return this._initialized},
hasDepthPack:function(){return this._hasDepthPack},_init_shader:function(a,c,n,o,s){n=n||[];a=h.util.get(a);c=h.util.get(c);s=s||"#define customShader_splice";if(o=o===m?this._vertex||this._fragment:o)o=a.indexOf(s),s=c.indexOf(s),-1!==o&&this._vertex&&(a=a.substr(0,o)+this._vertex),-1!==s&&this._fragment&&(c=c.substr(0,s)+this._fragment);this._shader=new h.Shader(a,c);this._shaderInfo=d.getShaderInfo(a,c);this._shaderVars=d.getShaderVars(this._shaderInfo);this._appendShaderVars(this._shaderVars,
"uniform",n);this._appendShaderVars(this._shaderVars,"attribute",n);(this._initialized=this._shader.isCompiled())&&this._init&&this._init(this)},_appendShaderVars:function(a,c,d){for(var a=function(a,c){return function(g,e){e!==m&&(v.activeTexture(v.TEXTURE0+g),v.bindTexture(q.gl.TEXTURE_2D,h.Textures[e.tex_id]));c.value=g;a.update(c)}},o=0,s=this._shaderVars[c].length;o<s;o++){var b=this._shaderVars[c][o],f=b.location;if(-1===d.indexOf(b.basename)&&(b=b.type,"vec3"===b?"attribute"===c?this._shader.addVertexArray(f):
this._shader.addVector(f):"vec2"===b?"attribute"===c?this._shader.addUVArray(f):this._shader.addVector(f):"float"===b?"attribute"===c?this._shader.addFloatArray(f):this._shader.addFloat(f):"sampler2D"===b||"int"===b?this._shader.addInt(f):("mat4"===b||"mat3"===b||"mat2"===b)&&this._shader.addMatrix(f),f=this._bindSelf(f),"sampler2D"==b&&f)){var v=q.gl;f.set=a(this,f)}}},_bindSelf:function(a){var c,d,o,b;if(null!==this._shader.uniforms[a]){var f=function(a,c){return function(g){c.value=g;a.update(c)}};
-1!==a.indexOf(".")?-1!==a.indexOf("[")?(c=a.split("["),o=c[0],c=c[1].split("]"),d=c[0],c=c[1].split("."),c=c[1],this[o]===m&&(this[o]=[]),this[o][d]===m&&(this[o][d]={}),b={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[o][d][c]=b):(c=a.split("."),o=c[0],c=c[1],this[o]===m&&(this[o]={}),b={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[o][c]=b):-1!==a.indexOf("[")?(c=a.split("["),o=c[0],c=c[1].split("]"),d=c[0],this[o]===
m&&(this[o]=[]),b={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[o][d]=b):(b={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[a]=b);this._bindings.push(b);b&&(b.set=f(this,b));return b}},_doUpdate:function(a){if(this._initialized)if(this._update)this._update(this,a);else for(var c=0,d=this._bindings.length;c<d;c++)this.update(this._bindings[c],a)},update:function(a){if(this._initialized){var c=q.gl,d=a.value,o=a.location;
null!==o&&(a.type===r.shader.uniform.MATRIX?(a=d.length,16===a?c.uniformMatrix4fv(o,!1,d):9===a?c.uniformMatrix3fv(o,!1,d):4===a&&c.uniformMatrix2fv(o,!1,d)):a.type===r.shader.uniform.INT?c.uniform1i(o,d):a.type===r.shader.uniform.VECTOR?(a=d.length,3===a?c.uniform3fv(o,d):2===a?c.uniform2fv(o,d):c.uniform4fv(o,d)):a.type===r.shader.uniform.FLOAT?c.uniform1f(o,d):a.type===r.shader.uniform.ARRAY_VERTEX?(c.bindBuffer(c.ARRAY_BUFFER,d),c.vertexAttribPointer(o,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(o)):
a.type===r.shader.uniform.ARRAY_UV?(c.bindBuffer(c.ARRAY_BUFFER,d),c.vertexAttribPointer(o,2,c.FLOAT,!1,0,0),c.enableVertexAttribArray(o)):a.type===r.shader.uniform.ARRAY_FLOAT&&(c.bindBuffer(c.ARRAY_BUFFER,d),c.vertexAttribPointer(o,1,c.FLOAT,!1,0,0),c.enableVertexAttribArray(o)))}}};return{Shader:x,shader_util:d,CustomShader:t}});
CubicVR.RegisterModule("MainLoop",function(h){function x(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function t(){null!==h.GLCore.mainloop&&(window.requestAnimationFrame&&window.requestAnimationFrame(t),h.GLCore.mainloop.interval())}function m(a,c,d){window.requestAnimationFrame===r&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null);null!==h.GLCore.mainloop&&(!window.requestAnimationFrame&&h.GLCore.mainloop&&clearInterval(h.GLCore.mainloop.interval),h.GLCore.mainloop=null);if(null===a)h.GLCore.mainloop=null;else{this.renderList=[];var e=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],g=new x;g.start();this.timer=g;this.func=a;this.doclear=c!==r?c:!0;h.GLCore.mainloop=this;f.resizeList.length&&!h.GLCore.resize_active&&(window.addEventListener("resize",
function(){h.GLCore.onResize()},!1),h.GLCore.resize_active=!0);c=function(){return function(){var c=h.GLCore.gl;g.update();h.GLCore.mainloop.doclear&&c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT);a(g,h.GLCore.gl);var d=e[e.length-1],b=d.scenes;d.update&&d.update(g,c);if(b){c=0;for(d=b.length;c<d;++c){var f=b[c];if(!f.paused){f.update&&f.update(g,h.GLCore.gl);f.render()}}}}}();d?this.loopFunc=c:window.requestAnimationFrame?(this.interval=c,window.requestAnimationFrame(t)):this.interval=setInterval(c,
20)}}function q(a,c,d){this.canvas=a;this.camera=c;this.mpos=[0,0];this.mdown=!1;var e=this;this.mEvents={};this.keyState=[];for(var g in b.keyboard)this.keyState[g]=!1;this.onMouseDown=function(){return function(a){e.mdown=!0;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];e.mEvents.mouseDown&&e.mEvents.mouseDown(e,e.mpos,e.keyState)}}();this.onMouseUp=function(){return function(a){e.mdown=!1;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];e.mEvents.mouseUp&&e.mEvents.mouseUp(e,
e.mpos,e.keyState)}}();this.onMouseMove=function(){return function(a){var c=[],a=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];c[0]=a[0]-e.mpos[0];c[1]=a[1]-e.mpos[1];e.mpos=a;e.mEvents.mouseMove&&e.mEvents.mouseMove(e,e.mpos,c,e.keyState)}}();this.onMouseWheel=function(){return function(a){a=a.wheelDelta?a.wheelDelta:100*-a.detail;e.mEvents.mouseWheel&&e.mEvents.mouseWheel(e,e.mpos,a,e.keyState)}}();this.onKeyDown=function(){return function(a){var a=a.keyCode,c=null;e.mEvents.keyPress?
(c=e.mEvents.keyPress(e,e.mpos,a,e.keyState),e.keyState[a]=c!==r?!!c:!0):e.keyState[a]=!0;e.keyState[a]&&e.mEvents.keyDown&&(c=e.mEvents.keyDown(e,e.mpos,a,e.keyState),e.keyState[a]=c!==r?!!c:!0)}}();this.onKeyUp=function(){return function(a){a=a.keyCode;e.mEvents.keyUp&&e.mEvents.keyUp(e,e.mpos,a,e.keyState);e.keyState[a]=!1}}();this.eventDefaults={mouseMove:function(a,c,g){a.mdown&&a.orbitView(g)},mouseWheel:function(a,c,g){a.zoomView(g)},mouseDown:null,mouseUp:null,keyDown:null,keyUp:null,keyPress:null};
!1!==d&&this.setEvents(d===r?this.eventDefaults:d);this.bind()}var r=h.undef,b=h.enums,f=h.GLCore;b.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,
KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,LEFT_META:91,RIGHT_META:92,SELECT:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,EQUALS:187,COMMA:188,
DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};x.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},reset:function(){this.start()},lockFramerate:function(a){this.lock_rate=1/a;this.lock_state=!0},unlock:function(){var a=
this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=a-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.system_milliseconds=this.lock_state?this.system_milliseconds+(1E3*this.lock_rate|0):Date.now();this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);this.time_elapsed=this.system_milliseconds-
this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(a){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-a},setSeconds:function(a){this.setMilliseconds(1E3*a|0)},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-
this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(a){this.paused_state=a},getPaused:function(){return this.paused_state}};m.prototype={setPaused:function(a){this.timer.setPaused(a)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(a){this.timer.setSeconds(a)},getTimerSeconds:function(){return this.timer.getSeconds()},resetTimer:function(){this.timer.reset()},addScene:function(a){this.renderStack[this.renderStack.length-
1].scenes.push(a);return a},pushSceneGroup:function(a){a.scenes=a.scenes||[];this.renderStack.push(a);for(var c=0;c<a.scenes.length;++c)a.scenes[c].enable();a.start&&a.start()},popSceneGroup:function(){for(var a=this.renderStack[this.renderStack.length-1],c=0;c<a.scenes.length;++c)a.scenes[c].disable();1<this.renderStack.length&&this.renderStack.pop();a.stop&&a.stop()},getScene:function(a){for(var c=renderStack[renderStack.length-1],d,e=0,g=c.scenes.length;e<g;++e)if(c.scenes[e].scene.name===a){d=
c.scenes[e];break}return d},resumeScene:function(a){"string"===typeof a&&(a=this.getScene(a));a.enable();a.paused=!1},pauseScene:function(a){"string"===typeof a&&(a=this.getScene(a));a.paused=!0;a.disable()},removeScene:function(a){var c=renderStack[renderStack.length-1];"string"===typeof a&&(a=this.getScene(a));var d=c.scenes.indexOf(a);-1<d&&c.scenes.splice(d,1);return a},runOnce:function(){this.loopFunc()}};q.prototype={getKeyState:function(a){return a!==r?this.keyState[a]:this.keyState},setEvents:function(a){this.mEvents=
{};for(var c in a)this.bindEvent(c,a[c])},orbitView:function(a){var c=h.vec3,d=c.subtract(this.camera.target,this.camera.position),d=c.length(d);this.camera.position=c.moveViewRelative(this.camera.position,this.camera.target,-d*a[0]/300,0);this.camera.position[1]+=d*a[1]/300;this.camera.position=c.add(this.camera.target,c.multiply(c.normalize(c.subtract(this.camera.position,this.camera.target)),d))},panView:function(a,c){var d=h.vec3;c||(c=!1);var e=d.subtract(this.camera.target,this.camera.position),
e=d.length(e),g=this.camera.position;c?this.camera.position=d.moveViewRelative(this.camera.position,this.camera.target,-e*a[0]/300,-e*a[1]/300):(this.camera.position=d.moveViewRelative(this.camera.position,this.camera.target,-e*a[0]/300,0),this.camera.position[1]+=e*a[1]/300);e=d.subtract(this.camera.position,g);this.camera.target=d.add(this.camera.target,e)},zoomView:function(a,c,d){var e=h.vec3,g=e.subtract(this.camera.target,this.camera.position),g=e.length(g),g=g-a/1E3;c||(c=0.1);d||(d=1E3);g<
c&&(g=c);g>d&&(g=d);this.camera.position=e.add(this.camera.target,e.multiply(e.normalize(e.subtract(this.camera.position,this.camera.target)),g))},bindEvent:function(a,c){this.mEvents[a]=c===r?this.eventDefaults[a]:c},unbindEvent:function(a){this.bindEvent(a,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",this.onMouseDown,!1);this.canvas.addEventListener("mouseup",this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",
this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.addEventListener("keydown",this.onKeyDown,!1);window.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",this.onMouseUp,!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",
this.onMouseWheel,!1);window.removeEventListener("keydown",this.onKeyDown,!1);window.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(a){this.camera=a},getMousePosition:function(){return this.mpos}};return{Timer:x,MainLoop:m,MouseViewController:q,setMainLoop:function(a){h.GLCore.mainloop=a},keyboard:b.keyboard}});
CubicVR.RegisterModule("Texture",function(h){function x(a,c){if(1===a||1===c)return!1;if(1!==a)for(;0===a%2;)a/=2;if(1!==c)for(;0===c%2;)c/=2;return 1<a||1<c?!1:!0}function t(a){var g=h.GLCore.gl;if("CANVAS"===a.nodeName||"IMG"===a.nodeName||"VIDEO"===a.nodeName)this.canvasSource=a;else{this.canvasSource=document.createElement("CANVAS");if(void 0===a.width||void 0===a.height)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=a.width;this.canvasSource.height=
a.height;this.canvasContext=this.canvasSource.getContext("2d")}this.updateFunction=a.update;this.texture=new h.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;var d=this.canvasSource;(!d.height||!d.width)&&e("Warning - CanvasTexture input has no initial width and height, edges clamped.");!d.height||!d.width||!x(d.width,d.height)?(this.setFilter(c.texture.filter.LINEAR),g.texParameteri(g.TEXTURE_2D,
g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE)):(this.setFilter(c.texture.filter.LINEAR_MIP),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.REPEAT),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.REPEAT));"IMG"===a.nodeName&&this.update()}function m(a,g){if(!a)throw"PDF Texture Error: page is null.";var e=this,d=h.GLCore.gl,b=this.canvasSource=document.createElement("canvas"),n;b.mozOpaque=!0;b.width=g.width;b.height=g.height;n=this.canvasContext=
b.getContext("2d");n.save();n.fillStyle="rgb(255, 255, 255)";n.fillRect(0,0,b.width,b.height);n.restore();a.startRendering(n,function(){e.update()});this.texture=new h.Texture;this.updateFunction=g.update||function(){};this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;x(b.width,b.height)?(this.setFilter(c.texture.filter.LINEAR_MIP),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT),
d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT)):(this.setFilter(c.texture.filter.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE))}function q(a,g,e){var d=h.GLCore.gl;this.texture=new h.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=g;this.canvas.height=e;this.pjs=new Processing(this.canvas,h.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();this.setFilter=this.texture.setFilter;
this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;x(this.canvas.width,this.canvas.height)?this.setFilter(c.texture.filter.LINEAR_MIP):(this.setFilter(c.texture.filter.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE))}function r(g,e,d){var b=a.gl;this.width=e;this.height=d;this.srcTex=g;this.outTex=new h.RenderBuffer(e,d);x(e,d);g=[1/e,1/
d,0];this.outputBuffer=new h.RenderBuffer(e,d,!1);this.fsQuad=h.fsQuad.make(e,d);shaderNMap=new h.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",g);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(b.TEXTURE0);this.setFilter(c.texture.filter.LINEAR);
b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT)}function b(g,e,d){var b=a.gl;this.width=g;this.height=e;this.outTex=new h.RenderBuffer(g,e,d);this.texture=this.outTex.texture;var n=x(g,e);this.setFilter=this.outTex.texture.setFilter;this.clear=this.outTex.texture.clear;this.use=this.outTex.texture.use;this.tex_id=this.outTex.texture.tex_id;this.filterType=this.outTex.texture.filterType;this.texture.use(b.TEXTURE0);n?(this.setFilter(c.texture.filter.LINEAR),
b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT)):(this.setFilter(c.texture.filter.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE));this.dims=[g,e];this.depth=d?!0:!1}function f(a,c){this.scene=a;this.renderTex=new b(c?c.width:a.camera.width,c?c.height:a.camera.height,!0);this.setFilter=this.renderTex.texture.setFilter;this.clear=this.renderTex.texture.clear;
this.use=this.renderTex.texture.use;this.tex_id=this.renderTex.texture.tex_id;this.filterType=this.renderTex.texture.filterType}var a=h.GLCore,c=h.enums,d=h.undef,e=h.log;c.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var g=function(a,c){this.img_path=a;this.filter_type=c};g.prototype={getTexture:function(a,c){return new n(this.img_path,this.filter_type,a,c)}};var n=function(g,e,b,n,f){var m=
a.gl;this.tex_id=h.Textures.length;this.filterType=-1;this.onready=f;this.loaded=!1;h.Textures[this.tex_id]=m.createTexture();h.Textures_obj[this.tex_id]=this;g&&("string"===typeof g?h.Images[this.tex_id]=new Image:"object"===typeof g&&"IMG"===g.nodeName&&(h.Images[this.tex_id]=g),h.Textures_ref[g]=this.tex_id);m.bindTexture(m.TEXTURE_2D,h.Textures[this.tex_id]);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,m.LINEAR);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.LINEAR);if(g){var q=this.tex_id,
r=e!==d?e:a.default_filter,t=this;h.Images[this.tex_id].onload=function(){m.bindTexture(m.TEXTURE_2D,h.Textures[q]);m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,true);m.pixelStorei(m.UNPACK_COLORSPACE_CONVERSION_WEBGL,m.NONE);var a=h.Images[q];m.texImage2D(m.TEXTURE_2D,0,m.RGBA,m.RGBA,m.UNSIGNED_BYTE,a);if(a=x(a.width,a.height)){m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.REPEAT);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.REPEAT)}else{m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.CLAMP_TO_EDGE);
m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.CLAMP_TO_EDGE)}if(h.Textures_obj[q].filterType===-1){if(a)r=c.texture.filter.LINEAR_MIP;else if(r===c.texture.filter.LINEAR_MIP)r=c.texture.filter.LINEAR;h.Textures_obj[q].filterType===-1&&h.Textures_obj[q].setFilter(r)}else h.Textures_obj[q].setFilter(h.Textures_obj[q].filterType);if(t.onready)t.onready();m.bindTexture(m.TEXTURE_2D,null);t.loaded=true};b?(h.Images[this.tex_id].deferredSrc=g,b.addImage(n,g,h.Images[this.tex_id])):"string"===typeof g&&
(h.Images[this.tex_id].src=g)}this.active_unit=-1};n.prototype={setFilter:function(a){if(-1<this.tex_id){var g=h.GLCore.gl;g.bindTexture(g.TEXTURE_2D,h.Textures[this.tex_id]);a===c.texture.filter.LINEAR?(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.LINEAR),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.LINEAR)):a===c.texture.filter.LINEAR_MIP?(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.LINEAR),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.LINEAR_MIPMAP_NEAREST),g.generateMipmap(g.TEXTURE_2D)):
a===c.texture.filter.NEAREST?(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.NEAREST),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.NEAREST)):a===c.texture.filter.NEAREST_MIP&&(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.NEAREST),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.NEAREST_MIPMAP_LINEAR),g.generateMipmap(g.TEXTURE_2D));this.filterType=a}},use:function(c){-1<this.tex_id&&(a.gl.activeTexture(c),a.gl.bindTexture(a.gl.TEXTURE_2D,h.Textures[this.tex_id]),this.active_unit=
c)},clear:function(){-1<this.tex_id&&-1!==this.active_unit&&(a.gl.activeTexture(this.active_unit),a.gl.bindTexture(a.gl.TEXTURE_2D,null),this.active_unit=-1)},destroy:function(){var a=h.GLCore.gl;-1<this.tex_id&&h.Textures[this.tex_id]&&(a.deleteTexture(h.Textures[this.tex_id]),delete h.Textures_obj[this.tex_id],this.tex_id=-1)}};t.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=h.GLCore.gl;a.bindTexture(a.TEXTURE_2D,h.Textures[this.texture.tex_id]);
a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===c.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};m.prototype={update:function(){this.updateFunction(this.canvasSource,this.canvasContext);var a=h.GLCore.gl;a.bindTexture(a.TEXTURE_2D,h.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);
this.filterType===c.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};q.prototype={update:function(){var a=h.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,h.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===c.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};r.prototype={update:function(){var c=
a.gl,g=c.getParameter(c.VIEWPORT);this.outputBuffer.use();c.viewport(0,0,this.width,this.height);c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);this.srcTex.use(c.TEXTURE0);h.fsQuad.render(this.shaderNorm,this.fsQuad);c.bindFramebuffer(c.FRAMEBUFFER,null);c.viewport(g[0],g[1],g[2],g[3])}};b.prototype={begin:function(){var c=a.gl;this.dims=c.getParameter(c.VIEWPORT);this.outTex.use();c.viewport(0,0,this.width,this.height);this.depth?c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT):c.clear(c.COLOR_BUFFER_BIT)},
end:function(){var c=a.gl;c.bindFramebuffer(c.FRAMEBUFFER,null);c.viewport(this.dims[0],this.dims[1],this.dims[2],this.dims[3])}};f.prototype={update:function(){this.renderTex.begin();this.scene.updateShadows();this.scene.render();this.renderTex.end()}};return{Texture:n,DeferredLoadTexture:g,CanvasTexture:t,PdfTexture:m,TextTexture:function(a,c){var g=c&&c.color||"#fff",e=c&&c.bgcolor,b=c&&c.font||"18pt Arial",n=c&&c.align||"start",f=c&&c.y||0,m=c&&c.width||d,q=c&&c.height||d,h,r=document.createElement("CANVAS"),
D=r.getContext("2d"),z=0,z="string"===typeof a?1:a.length;D.font=b;var x=c&&c.lineHeight||D.measureText("OO").width,I;if(1===z)I=D.measureText(a).width;else for(h=I=0;h<z;++h){var H=D.measureText(a[h]).width;H>I&&(I=H)}r.width=m||I;r.height=q||x*z;e&&(D.fillStyle=e,D.fillRect(0,0,r.width,r.height));D.fillStyle=g;D.font=b;D.textAlign=n;D.textBaseline="top";if(1===z)g=c&&c.x||"center"===n?r.width/2:"right"===n?r.width:0,D.fillText(a,g,f);else for(h=0;h<z;++h)g=c&&c.x||"center"===n?r.width/2:"right"===
n?r.width:0,D.fillText(a[h],g,f+h*x);D.fill();this.use=t.prototype.use;this.clear=t.prototype.clear;this.update=t.prototype.update;t.apply(this,[r]);this.update();this.canvasSource=null},PJSTexture:q,NormalMapGen:r,RenderTexture:b,SceneRenderTexture:f}});
CubicVR.RegisterModule("DrawBufferTexture",function(h){var x=h.GLCore,t=h.enums;t.draw={brush:{SINE:0,SQUARE:1},op:{ADD:0,REPLACE:1,SUBTRACT:2,MULTIPLY:3}};var m=function(m){m=m||{};this.operation=h.parseEnum(t.draw.op,m.operation||m.op)||t.draw.op.REPLACE;this.brushType=h.parseEnum(t.draw.brush,m.brushType)||t.draw.brush.SINE;this.brushSize=m.size||5;this.color=m.color||[255,255,255,255]};m.prototype={setOperation:function(m){this.operation=h.parseEnum(t.draw.op,m)},getOperation:function(){return this.operation},
setBrushType:function(m){this.brushType=h.parseEnum(t.draw.brush,m)||t.draw.brush.SINE},getBrushType:function(){return this.brushType},setSize:function(m){this.brushSize=m},getSize:function(){return this.brushSize},setColor:function(m){this.color=m},getColor:function(){return this.color.slice(0)}};return{DrawBufferTexture:h.extendClassGeneral(h.Texture,function(q){q=q||{};h.Texture.apply(this,[q.image,q.filter,q.deferred_bin,q.binId,q.readyFunc]);this.width=q.width||0;this.height=q.height||0;this.imageBufferData=
this.imageBuffer=null;this.brush=q.brush||new m;this.drawBuffer=[];this.width&&this.height&&this.setupImageBuffer(this.width,this.height)},{getUint8Buffer:function(){return this.imageBuffer},needsFlush:function(){return 0!==this.drawBuffer.length},getWidth:function(){return this.width},getHeight:function(){return this.height},setupImageBuffer:function(){this.imageBufferData=new ArrayBuffer(4*this.width*this.height);this.imageBuffer=new Uint8Array(this.imageBufferData);this.update()},setBrush:function(m){this.brush=
m},getBrush:function(){return this.brush},draw:function(m,h,b){var f=b||this.brush,b=f.getOperation(),a=f.getSize(),c=f.getBrushType(),f=f.getColor();this.drawBuffer.push([m,h,b,a,c,f])},flush:function(){if(!this.drawBuffer.length)return!1;for(;this.drawBuffer.length;){var m=this.drawBuffer.pop();this.drawFunc(m[0],m[1],m[2],m[3],m[4],m[5])}return!0},drawFunc:function(m,h,b,f,a,c){for(var d=this.imageBuffer,e=this.width,g=this.height,n=parseInt(Math.floor(m),10)-f;n<parseInt(Math.ceil(m),10)+f;n++)for(var o=
n-m,s,E=parseInt(Math.floor(h),10)-f;E<parseInt(Math.ceil(h),10)+f;E++)if(!(0>n||n>=e||0>E||E>=g)){s=E-h;var w;0===a&&(w=(1-Math.sqrt(o*o+s*s)/f)/2);s=4*(E*e+n);0===b?0>w&&(w=0):1===b?0>w&&(w=0):2===b&&(w=-w,0<w&&(w=0));var v=Math.floor(d[s]*(1-w)+c[0]*w),C=Math.floor(d[s+1]*(1-w)+c[1]*w),A=Math.floor(d[s+2]*(1-w)+c[2]*w),B=Math.floor(d[s+3]*(1-w)+c[3]*w);255<v?v=255:0>v&&(v=0);255<C?C=255:0>C&&(C=0);255<A?A=255:0>A&&(A=0);255<B?B=255:0>B&&(B=0);d[s]=v;d[s+1]=C;d[s+2]=A;d[s+3]=B}},update:function(){var m=
x.gl;this.flush();m.bindTexture(m.TEXTURE_2D,h.Textures[this.tex_id]);m.texImage2D(m.TEXTURE_2D,0,m.RGBA,this.width,this.height,0,m.RGBA,m.UNSIGNED_BYTE,this.imageBuffer);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,m.LINEAR);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.LINEAR)}}),DrawBufferBrush:m}});
CubicVR.RegisterModule("Material",function(h){function x(a){this.blendEnabled=this.dirtyFlag=this.initialized=!1;this.textures=[];this.shader=[];this.customShader=(a=h.get(a)||{},a.shader||null);null===r&&(r=new h.CustomShader({vertex:"precision lowp float; \nattribute vec3 vertexPosition; uniform mat4 matrixModelView; uniform mat4 matrixProjection; uniform mat4 matrixObject;\nvoid main(void) { gl_Position = matrixProjection * matrixModelView * matrixObject * vec4(vertexPosition,1.0); }",fragment:"precision lowp float; \nvoid main(void) { gl_FragColor = vec4(1.0,0.0,1.0,1.0); }\n"}),
r._init_shader(r._vertex,r._fragment,!1));this.customShader&&(!this.customShader._init_shader&&"object"===typeof this.customShader)&&(this.customShader=new h.CustomShader(this.customShader));this.diffuse=a.diffuse||[1,1,1];this.specular=a.specular||[0.1,0.1,0.1];this.color=a.color||[1,1,1];this.ambient=a.ambient||[0,0,0];this.name=a.name||null;this.visible=a.visible!==t?a.visible:!0;this.friction=a.friction!==t?a.friction:0.3;this.collision=a.visible!==t?a.collision:!0;this.opacity=a.opacity===t?
1:a.opacity;this.shininess=a.shininess===t?1:a.shininess;this.max_smooth=a.max_smooth===t?60:a.max_smooth;this.env_amount=a.env_amount===t?0.75:a.env_amount;this.morph=a.morph===t?!1:a.morph;this.color_map=a.colorMap===t?!1:a.colorMap;this.uvOffset=a.uvOffset===t?[0,0]:a.uvOffset;this.noFog=a.noFog===t?!1:a.noFog;if(a.textures)for(var d in a.textures)this.setTexture(a.textures[d],d)}var t=h.undef,m=h.GLCore,q=h.enums,r=null,b=[q.texture.map.REFLECT,q.texture.map.SPECULAR,q.texture.map.NORMAL,q.texture.map.BUMP],
f=[],a="textureColor textureEnvSphere textureNormal textureBump textureReflect textureSpecular textureAmbient textureAlpha matrixModelView matrixProjection matrixObject matrixNormal vertexPosition vertexNormal vertexColor vertexTexCoord materialTexOffset vertexMorphPosition vertexMorphNormal materialMorphWeight lightDiffuse lightSpecular lightIntensity lightDistance lightPosition lightDirection lightCutOffAngle lightShadowMap lightProjectionMap lightDepthClip lightShadowMatrix lightAmbient materialDiffuse materialColor materialAmbient materialSpecular materialShininess materialEnvironment materialAlpha postDepthInfo".split(" ");
x.prototype={clone:function(){var a=new h.Material({diffuse:this.diffuse,specular:this.specular,color:this.color,ambient:this.ambient,opacity:this.opacity,shininess:this.shininess,max_smooth:this.max_smooth,env_amount:this.env_amount,morph:this.morph,colorMap:this.color_map,visible:this.visible,friction:this.friction,collision:this.collision,name:this.name}),d;for(d in this.textures)this.textures.hasOwnProperty(d)&&a.setTexture(this.textures[d],d);return a},setVisibility:function(a){this.visible=
a},getVisibility:function(){return this.visible},setCollision:function(a){this.collision=a},getCollision:function(){return this.collision},setFriction:function(a){this.friction=a},getFriction:function(){return this.friction},setTexture:function(a,d){if(a&&(d=h.parseEnum(q.texture.map,d)||0,h.features.texturePerPixel||-1===b.indexOf(d)))!a.use&&"string"===typeof a&&(a=h.Textures_ref[a]!==t?h.Textures_obj[h.Textures_ref[a]]:new h.Texture(a)),this.textures[d]=a},calcShaderMask:function(){var a;a=0+("object"===
typeof this.textures[q.texture.map.COLOR]?q.shader.map.COLOR:0);a+="object"===typeof this.textures[q.texture.map.SPECULAR]?q.shader.map.SPECULAR:0;a+="object"===typeof this.textures[q.texture.map.NORMAL]?q.shader.map.NORMAL:0;a+="object"===typeof this.textures[q.texture.map.BUMP]?q.shader.map.BUMP:0;a+="object"===typeof this.textures[q.texture.map.REFLECT]?q.shader.map.REFLECT:0;a+="object"===typeof this.textures[q.texture.map.ENVSPHERE]?q.shader.map.ENVSPHERE:0;a+="object"===typeof this.textures[q.texture.map.AMBIENT]?
q.shader.map.AMBIENT:0;a+="object"===typeof this.textures[q.texture.map.ALPHA]?q.shader.map.ALPHA:0;a+=1!==this.opacity?q.shader.map.ALPHA:0;a+=this.color_map?q.shader.map.COLORMAP:0;1!==this.opacity&&(this.blendEnabled=!0);return a},getShaderHeader:function(a,d){return(d!==t?"#define LIGHT_COUNT "+d+"\n":"")+"#define TEXTURE_COLOR "+("object"===typeof this.textures[q.texture.map.COLOR]?1:0)+"\n#define TEXTURE_SPECULAR "+("object"===typeof this.textures[q.texture.map.SPECULAR]?1:0)+"\n#define TEXTURE_NORMAL "+
("object"===typeof this.textures[q.texture.map.NORMAL]?1:0)+"\n#define TEXTURE_BUMP "+("object"===typeof this.textures[q.texture.map.BUMP]?1:0)+"\n#define TEXTURE_REFLECT "+("object"===typeof this.textures[q.texture.map.REFLECT]?1:0)+"\n#define TEXTURE_ENVSPHERE "+("object"===typeof this.textures[q.texture.map.ENVSPHERE]?1:0)+"\n#define TEXTURE_AMBIENT "+("object"===typeof this.textures[q.texture.map.AMBIENT]?1:0)+"\n#define TEXTURE_ALPHA "+("object"===typeof this.textures[q.texture.map.ALPHA]?1:
0)+"\n#define MATERIAL_ALPHA "+(1!==this.opacity?1:0)+"\n#define LIGHT_IS_POINT "+(a===q.light.type.POINT?1:0)+"\n#define LIGHT_IS_DIRECTIONAL "+(a===q.light.type.DIRECTIONAL?1:0)+"\n#define LIGHT_IS_SPOT "+(a===q.light.type.SPOT||a===q.light.type.SPOT_SHADOW||a===q.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED "+(a===q.light.type.SPOT_SHADOW||a===q.light.type.SPOT_SHADOW_PROJECTOR||a===q.light.type.AREA?1:0)+"\n#define LIGHT_IS_PROJECTOR "+(a===q.light.type.SPOT_SHADOW_PROJECTOR?
1:0)+"\n#define LIGHT_SHADOWED_SOFT "+(m.soft_shadow?1:0)+"\n#define LIGHT_IS_AREA "+(a===q.light.type.AREA?1:0)+"\n#define LIGHT_DEPTH_PASS "+(a===q.light.type.DEPTH_PACK?1:0)+"\n#define FX_DEPTH_ALPHA "+(m.depth_alpha?1:0)+"\n#define VERTEX_MORPH "+(this.morph?1:0)+"\n#define VERTEX_COLOR "+(this.color_map?1:0)+"\n#define FOG_ENABLED "+(m.fog_enabled&&!this.noFog?1:0)+"\n#define USE_FOG_EXP "+(m.fogExp?1:0)+"\n#define USE_FOG_LINEAR "+(m.fogLinear?1:0)+"\n#define LIGHT_PERPIXEL "+(h.features.lightPerPixel?
1:0)+"\n\n"},bindObject:function(a,d){var e=m.gl,g=d.vertexPosition,b=d.vertexTexCoord,o=d.vertexNormal,s=d.vertexColor;e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_points);e.vertexAttribPointer(g,3,e.FLOAT,!1,0,0);e.enableVertexAttribArray(g);null!==b&&(null!==a.compiled.gl_uvs&&-1!==b)&&(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_uvs),e.vertexAttribPointer(b,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(b));f.uv=b;null!==o&&(null!==a.compiled.gl_normals&&-1!==o)&&(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_normals),
e.vertexAttribPointer(o,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(o));f.un=o;null!==s&&(null!==a.compiled.gl_colors&&-1!==s)&&(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_colors),e.vertexAttribPointer(s,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(s));f.uc=s;a.morphTarget&&(g=d.vertexMorphPosition,o=d.vertexMorphNormal,e.bindBuffer(e.ARRAY_BUFFER,a.morphTarget.gl_points),e.vertexAttribPointer(g,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(g),null!==o&&(null!==a.morphTarget.gl_normals&&-1!==o)&&(e.bindBuffer(e.ARRAY_BUFFER,
a.morphTarget.gl_normals),e.vertexAttribPointer(o,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(o)),e.uniform1f(d.materialMorphWeight,a.morphWeight));e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.compiled.gl_elements)},clearObject:function(a,d){var e=m.gl;f.uv!==t&&-1!==f.uv&&e.disableVertexAttribArray(f.uv);f.un!==t&&-1!==f.un&&e.disableVertexAttribArray(f.un);f.uc!==t&&-1!==f.uc&&e.disableVertexAttribArray(f.uc);a.morphTarget&&d&&(up=d.vertexMorphPosition,e.disableVertexAttribArray(up),un=d.vertexMorphNormal,
null!==un&&(null!==a.compiled.gl_normals&&-1!==un)&&e.disableVertexAttribArray(un))},use:function(c,d){var e,g=m.gl,b=this.textures,o=!0,d=d||0,c=c||0;this.shader[c]||(this.shader[c]=[]);var f=this.shader[c][d],E=this.customShader&&c===q.light.type.DEPTH_PACK&&!this.customShader.hasDepthPack();f&&(1!==this.opacity&&!0!==this.blendEnabled)&&(this.dirtyFlag=!0);!0===this.dirtyFlag&&(f=null,this.dirtyFlag=!1);if(f)o=f!==r,f.use();else{e=this.calcShaderMask(c);if(!this.customShader||E)h.ShaderPool[c][e]||
(h.ShaderPool[c][e]=[]),f=h.ShaderPool[c][e][d];if(!f){var w=this.getShaderHeader(c,d),v=w+m.CoreShader_vs,w=w+m.CoreShader_fs;this.customShader&&!E?this.customShader._initialized||(this.customShader._init_shader(v,w,a),f=this.customShader.getShader(),f.isCompiled()||(o=!1,f=r.getShader())):(f=new h.Shader(v,w),f.isCompiled()||(o=!1,f=r.getShader()),h.ShaderPool[c][e][d]=f);e=0;if(c!==q.light.type.DEPTH_PACK){if(c===q.light.type.SPOT_SHADOW||c===q.light.type.SPOT_SHADOW_PROJECTOR||c===q.light.type.AREA)e+=
d,c===q.light.type.SPOT_SHADOW_PROJECTOR&&(e+=d);"object"===typeof b[q.texture.map.COLOR]&&f.addInt("textureColor",e++);"object"===typeof b[q.texture.map.ENVSPHERE]&&f.addInt("textureEnvSphere",e++);"object"===typeof b[q.texture.map.NORMAL]&&f.addInt("textureNormal",e++);"object"===typeof b[q.texture.map.BUMP]&&f.addInt("textureBump",e++);"object"===typeof b[q.texture.map.REFLECT]&&f.addInt("textureReflect",e++);"object"===typeof b[q.texture.map.SPECULAR]&&f.addInt("textureSpecular",e++);"object"===
typeof b[q.texture.map.AMBIENT]&&f.addInt("textureAmbient",e++)}"object"===typeof b[q.texture.map.ALPHA]&&f.addInt("textureAlpha",e++);f.addMatrix("matrixModelView");f.addMatrix("matrixProjection");f.addMatrix("matrixObject");f.addMatrix("matrixNormal");f.addVertexArray("vertexPosition");f.addVertexArray("vertexNormal");this.color_map&&f.addVertexArray("vertexColor");this.morph&&(f.addVertexArray("vertexMorphPosition"),f.addVertexArray("vertexMorphNormal"),f.addFloat("materialMorphWeight",0));for(e=
0;e<d;e++)if(f.addVector("lightDiffuse["+e+"]"),f.addVector("lightSpecular["+e+"]"),f.addFloat("lightIntensity["+e+"]"),f.addFloat("lightDistance["+e+"]"),f.addVector("lightPosition["+e+"]"),f.addVector("lightDirection["+e+"]"),(c===q.light.type.SPOT_SHADOW||c===q.light.type.SPOT_SHADOW_PROJECTOR||c===q.light.type.SPOT)&&f.addFloat("lightCutOffAngle["+e+"]"),c===q.light.type.SPOT_SHADOW||c===q.light.type.SPOT_SHADOW_PROJECTOR||c===q.light.type.AREA)f.addInt("lightShadowMap["+e+"]"),c===q.light.type.SPOT_SHADOW_PROJECTOR&&
f.addInt("lightProjectionMap["+e+"]"),f.addVector("lightDepthClip["+e+"]"),f.addMatrix("lightShadowMatrix["+e+"]");c!==q.light.type.DEPTH_PACK&&(f.addVector("lightAmbient"),f.addVector("materialDiffuse"),f.addVector("materialColor"),f.addVector("materialAmbient"),f.addVector("materialSpecular"),f.addFloat("materialShininess"),f.addFloat("materialEnvironment"));f.addFloat("materialAlpha");(m.depth_alpha||c===q.light.type.DEPTH_PACK||c===q.light.type.SPOT_SHADOW||c===q.light.type.SPOT_SHADOW_PROJECTOR||
c===q.light.type.AREA)&&f.addVector("postDepthInfo");f.addUVArray("vertexTexCoord");f.addVector("materialTexOffset");m.fog_enabled&&!this.noFog&&(f.addVector("fogColor",m.fogColor),f.addFloat("fogDensity",m.fogDensity),f.addFloat("fogNear",m.fogNear),f.addFloat("fogFar",m.fogFar))}this.shader[c][d]=f;f.use();-1!=f.materialTexOffset&&g.uniform2fv(f.materialTexOffset,[0,0])}e=0;if(c!==q.light.type.DEPTH_PACK){if(c===q.light.type.SPOT_SHADOW||c===q.light.type.SPOT_SHADOW_PROJECTOR||c===q.light.type.AREA)e+=
d,c===q.light.type.SPOT_SHADOW_PROJECTOR&&(e+=d);if(v=b[q.texture.map.COLOR])v.use(m.gl.TEXTURE0+e),e++;if(v=b[q.texture.map.ENVSPHERE])v.use(m.gl.TEXTURE0+e),e++,g.uniform1f(f.materialEnvironment,this.env_amount);if(v=b[q.texture.map.NORMAL])v.use(m.gl.TEXTURE0+e),e++;if(v=b[q.texture.map.BUMP])v.use(m.gl.TEXTURE0+e),e++;if(v=b[q.texture.map.REFLECT])v.use(m.gl.TEXTURE0+e),e++;if(v=b[q.texture.map.SPECULAR])v.use(m.gl.TEXTURE0+e),e++;if(v=b[q.texture.map.AMBIENT])v.use(m.gl.TEXTURE0+e),e++}if(v=
b[q.texture.map.ALPHA])v.use(m.gl.TEXTURE0+e),e++;m.fog_enabled&&!this.noFog&&(g.uniform3fv(f.fogColor,m.fogColor),g.uniform1f(f.fogDensity,m.fogDensity),g.uniform1f(f.fogNear,m.fogNear),g.uniform1f(f.fogFar,m.fogFar));c!==q.light.type.DEPTH_PACK?(g.uniform3fv(f.materialColor,this.color),g.uniform3fv(f.materialDiffuse,this.diffuse),g.uniform3fv(f.materialAmbient,this.ambient),g.uniform3fv(f.materialSpecular,this.specular),g.uniform1f(f.materialShininess,128*this.shininess),g.uniform3fv(f.lightAmbient,
h.globalAmbient),1!==this.opacity&&g.uniform1f(f.materialAlpha,this.opacity),(m.depth_alpha||c===q.light.type.SPOT_SHADOW||c===q.light.type.SPOT_SHADOW_PROJECTOR||c===q.light.type.AREA)&&g.uniform3fv(f.postDepthInfo,[m.depth_alpha_near,m.depth_alpha_far,0])):g.uniform3fv(f.postDepthInfo,[m.shadow_near,m.shadow_far,0]);f.materialTexOffset&&g.uniform2fv(f.materialTexOffset,this.uvOffset);this.customShader&&(c!==q.light.type.DEPTH_PACK||c===q.light.type.DEPTH_PACK&&!E)&&this.customShader._doUpdate({material:this,
textureIndex:e});return o}};return{Material:x}});
CubicVR.RegisterModule("Mesh",function(h){function x(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function t(b){this.compiled=null;this.materials=[];this.edges=this.instanceMaterials=this.bb=null;this.faces=[];this.points=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.morphTarget=this.morphTargets=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1;this.originBuffer=null;b=h.get(b)||
{};if(b instanceof h.Mesh)this.booleanAdd(b),b._clones=b._clones||1,b._clones++,this.name=b.name?b.name+"_copy"+b._clones:null;else{this.name=b.name||null;this.dynamic=b.dynamic||!1;if(b.material){var f=b.material;f.length?this.materials=f:"object"===typeof f&&(f.use?this.setFaceMaterial(f):this.setFaceMaterial(new h.Material(f)))}b.points&&this.build(b);b.part?this.build(b.part):b.parts&&this.build(b.parts);if((this.primitives=b.primitives||b.primitive||null)&&!this.primitives.length||"string"===
typeof this.primitives)this.primitives=[this.primitives];if(this.primitives&&this.primitives.length)for(var f=0,a=this.primitives.length;f<a;f++){var c=this.primitives[f];"string"===typeof c&&(c=h.get(c));var d=h.primitives[c.type];if(c.type&&d)this.booleanAdd(d(c));else if(c.type){r("Mesh error, primitive "+c.type+" is unknown.");var c="",e;for(e in h.primitives)h.primitives.hasOwnProperty(e)&&(""!==c&&(c+=", "),c+=e);r("Available primitive types are: "+c)}else r("Mesh error, primitive "+(f+1)+" lacks type.")}this.buildWireframe=
b.buildWireframe||b.wireframe||!!b.wireframeMaterial||b.triangulateWireframe||!1;this.triangulateWireframe=b.triangulateWireframe||null;this.wireframeMaterial=h.get(b.wireframeMaterial,h.Material)||null;this.wireframe=b.wireframe||!1;b.flipFaces&&this.faces.length&&this.flipFaces();(b.prepare||b.compile&&this.faces.length)&&this.prepare();(b.clean||b.compile&&this.faces.length&&!this.dynamic)&&this.clean();b.calcNormals&&(!b.compile&&!b.prepare)&&this.calcNormals()}}var m=h.undef,q=h.GLCore,r=h.log;
x.prototype={setUV:function(b,f){f!==m?this.uvs[f]=b:2!==b.length?this.uvs=b:this.uvs.push(b)},setColor:function(b,f){f!==m?this.point_colors[f]=b:"number"!==typeof b[0]?this.point_colors=b:this.point_colors.push(b)},flip:function(){for(var b=0,f=this.point_normals.length;b<f;b++)this.point_normals[b]=[-this.point_normals[b][0],-this.point_normals[b][1],-this.point_normals[b][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();this.normal=[-this.normal[0],-this.normal[1],-this.normal[2]]}};
t.prototype={setWireframe:function(b){this.wireframe=b},isWireframe:function(){return this.wireframe},setWireframeMaterial:function(b){this.wireframeMaterial=b},build:function(b,f){var a,c;"string"===typeof b&&(b=h.get(b));b&&!b.length&&(b=[b]);var d=this.faces.length;f&&f.length&&this.points.concat(f);for(var e=0,g=b.length;e<g;e++){var n=b[e];a=n.material;c=n.points;var o=n.faces,s=n.uv,m=n.color,n=n.segment||null;null!==n&&this.setSegment(parseInt(n,10));if(c&&c.length&&(this.points=this.points.concat(c),
o&&d)){o=o.slice(0);c=0;for(n=o.length;c<n;c++)for(var w=o[c],v=0,q=o.length;v<q;v++)w[v]+=d}a&&(a.length?this.materials=a:"object"===typeof a&&(a.use?this.setFaceMaterial(a):this.setFaceMaterial(new h.Material(a))));o&&o.length&&this.addFace(o);if(o&&s&&"object"===typeof s){n=null;if(s.length&&s.length===o.length)if(s.length===o.length){a=0;for(c=s.length;a<c;a++)this.faces[a+d].setUV(s[a])}else r("Mesh error in part, face count: "+o.length+", uv count:"+s.length);else n=s.apply?s:new h.UVMapper(s);
n&&n.apply(this,this.currentMaterial,this.currentSegment,d,this.faces.length-d)}if(o&&m&&"object"===typeof m)if(m.length&&m.length===o.length){a=0;for(c=m.length;a<c;a++)this.faces[a+d].setColor(m[a]);this.materials[this.currentMaterial].colorMap=!0}else r("Mesh error in part, face count: "+o.length+", color count:"+m.length)}return this},showAllSegments:function(){for(var b in this.segment_state)this.segment_state.hasOwnProperty(b)&&(this.segment_state[b]=!0)},hideAllSegments:function(){for(var b in this.segment_state)this.segment_state.hasOwnProperty(b)&&
(this.segment_state[b]=!1)},setSegment:function(b,f){f!==m?this.segment_state[b]=f:this.currentSegment=b},addPoint:function(b){if(3!==b.length||"object"===typeof b[0])for(var f=0,a=b.length;f<a;f++)this.points.push(b[f]);else this.points.push(b);return this.points.length-1},getMaterialIndex:function(b){return this.materials.indexOf(b)},setFaceMaterial:function(b,f){var a;"number"==typeof b?a=b:(a=this.materials.indexOf(b),-1===a&&(this.materials.push(b),a=this.materials.length-1));f!==m?this.faces[f]!==
m&&(this.faces[f].material=a):this.currentMaterial=a;return this},addFace:function(b,f,a,c){if("number"!==typeof b[0]){f=0;for(a=b.length;f<a;f++)this.addFace(b[f])}else return f===m?(this.currentFace=this.faces.length,this.faces.push(new x)):(this.faces[f]===m&&(this.faces[f]=new x),this.currentFace=f),"object"===typeof b&&(this.faces[this.currentFace].points=b),a!==m?this.setFaceMaterial(a,this.currentFace):this.faces[this.currentFace].material=this.currentMaterial,this.faces[this.currentFace].segment=
c!==m?c:this.currentSegment,this.currentFace},flipFaces:function(){for(var b=0,f=this.faces.length;b<f;b++)this.faces[b].flip()},triangulateQuads:function(){for(var b=0,f=this.faces.length;b<f;b++)if(4===this.faces[b].points.length){var a=this.faces.length;this.addFace([this.faces[b].points[2],this.faces[b].points[3],this.faces[b].points[0]],this.faces.length,this.faces[b].material,this.faces[b].segment);this.faces[b].points.pop();this.faces[a].normal=this.faces[b].normal.slice(0);4===this.faces[b].point_colors.length&&
(this.faces[a].setColor(this.faces[b].point_colors[2],0),this.faces[a].setColor(this.faces[b].point_colors[3],1),this.faces[a].setColor(this.faces[b].point_colors[0],2),this.faces[b].point_colors.pop());4===this.faces[b].uvs.length&&(this.faces[a].setUV(this.faces[b].uvs[2],0),this.faces[a].setUV(this.faces[b].uvs[3],1),this.faces[a].setUV(this.faces[b].uvs[0],2),this.faces[b].uvs.pop());4===this.faces[b].point_normals.length&&(this.faces[a].point_normals[0]=this.faces[b].point_normals[2],this.faces[a].point_normals[1]=
this.faces[b].point_normals[3],this.faces[a].point_normals[2]=this.faces[b].point_normals[0],this.faces[b].point_normals.pop())}return this},booleanAdd:function(b,f){var a=h.mat4,c=this.points.length,d,e,g,n;d=f;f=d===m?m:"array"===typeof d?d:"object"===typeof d?d.getResult?d.getResult():d.position||d.rotation||d.scale?h.mat4.transform(d.position,d.rotation,d.scale):m:void 0;b.wireframeMaterial&&(this.wireframeMaterial=b.wireframeMaterial);if(f!==m){e=f;d=0;for(g=b.points.length;d<g;d++)this.addPoint(a.vec3_multiply(b.points[d],
e))}else{d=0;for(g=b.points.length;d<g;d++)this.addPoint([b.points[d][0],b.points[d][1],b.points[d][2]])}a=[];d=0;for(g=b.materials.length;d<g;d++)e=this.materials.indexOf(b.materials[d]),-1===e?(this.materials.push(b.materials[d]),a[d]=this.materials.length-1):a[d]=e;d=0;for(g=b.faces.length;d<g;d++){var o=[];e=0;for(n=b.faces[d].points.length;e<n;e++)o.push(b.faces[d].points[e]+c);o=this.faces[this.addFace(o)];o.segment=b.faces[d].segment;o.material=a[b.faces[d].material];o.material===m&&(o.material=
0);e=0;for(n=b.faces[d].uvs.length;e<n;e++)o.uvs[e]=[b.faces[d].uvs[e][0],b.faces[d].uvs[e][1]];e=0;for(n=b.faces[d].point_normals.length;e<n;e++)o.point_normals[e]=[b.faces[d].point_normals[e][0],b.faces[d].point_normals[e][1],b.faces[d].point_normals[e][2]]}return this},calcFaceNormals:function(b,f){var a=h.vec3,c=h.triangle,d=0,e=this.faces.length,g,n=this.points,o;b&&(d=b);for(f&&(e=f+1);d<e;d++)g=this.faces[d],o=g.points,3>o.length?g.normal=[0,0,0]:a.normalize(c.normal(n[o[0]],n[o[1]],n[o[2]],
g.normal));return this},getMaterial:function(b){if(!isNaN(parseInt(b,10)))return this.materials[f];for(var f=0,a=this.materials.length;f<a;f++)if(this.materials[f].name===b)return this.materials[f];return null},getMaterials:function(){return this.materials},bindInstanceMaterials:function(b){this.instanceMaterials=b},calcNormals:function(b){var f=h.vec3,a=!1,c;this.dynamic&&(c=[],b=b||{});b!==m&&(c=[],a=!0);this.calcFaceNormals();var d,e,g,n,o=Array(this.points.length);d=0;for(n=o.length;d<n;d++)o[d]=
[];n=this.faces.length;for(d=0;d<n;d++){g=this.faces[d].points.length;for(e=0;e<g;e++)o[this.faces[d].points[e]].push([d,e])}d=0;for(n=this.points.length;d<n;d++){var s=o[d].length;for(e=0;e<s;e++){var E=1,w=o[d][e][0],v=o[d][e][1],q=this.materials.length?this.materials[this.faces[w].material].max_smooth:60,r=this.faces[w];a&&(c[w]===m&&(c[w]=[]),c[w][v]===m&&(c[w][v]=[]));var B=Array(3);B[0]=r.normal[0];B[1]=r.normal[1];B[2]=r.normal[2];if(0!==q)for(g=0;g<s;g++)if(e!==g){var t=o[d][g][0],u=this.faces[t],
y=f.angle(u.normal,r.normal);if(y!==y||y*(180/Math.PI)<=q)a&&c[w][v].push(t),B[0]+=u.normal[0],B[1]+=u.normal[1],B[2]+=u.normal[2],E++}B[0]/=E;B[1]/=E;B[2]/=E;this.faces[w].point_normals[v]=f.normalize(B)}}if(a){d=f=0;for(n=c.length;d<n;d++){e=0;for(g=c[d].length;e<g;e++)f+=c[d][e].length}b.faceCount||(b.faceCount=new Uint8Array(3*this.faces.length));b.faceNorm||(b.faceNorm=new Uint16Array(f));b.faceNormIdx||(b.faceNormIdx=new Uint16Array(this.faces.length));d=f=0;for(n=this.faces.length;d<n;d++)for(e=
0;3>e;e++)if(a=c[d][e],b.faceCount[3*d+e]=a?a.length:0,b.faceNormIdx[d]=f,a){g=0;for(a=a.length;g<a;g++)b.faceNorm[f++]=c[d][e][g]}else f++;this.normalMapRef=b}return this},recalcNormals:function(b,f){var a,c,d,e,g,n,o,s,h,w;if(b=b||this.normalMapRef){a=f.segments!==m?!0:!1;c=f.segments;this.calcFaceNormals();var v=0,q=0,r=0,B;if(a)for(var q=this.dynamicData.VBO.dynamicMap,t=b.faceNormIdx,u=0,y=c.length;u<y;u++)for(var D=q.segmentMap[c[u]],z=0,x=D.length;z<x;z++){a=D[z];h=this.faces[a];B=h.normal;
v=t[a];for(j=0;3>j;j++){s=h.point_normals[j];g=B[0];n=B[1];o=B[2];w=b.faceCount[3*a+j];d=0;for(iMax=w;d<iMax;d++)e=b.faceNorm[v+d],e=this.faces[e],e=e.normal,g+=e[0],n+=e[1],o+=e[2];w?(d=w+1,g/=d,n/=d,o/=d,d=Math.sqrt(g*g+n*n+o*o),g/=d,n/=d,o/=d,s[0]=g,s[1]=n,s[2]=o):r++}}else{a=0;for(c=this.faces.length;a<c;a++){h=this.faces[a];B=h.normal;for(j=0;3>j;j++){s=h.point_normals[j];g=B[0];n=B[1];o=B[2];w=b.faceCount[q++];d=0;for(iMax=w;d<iMax;d++)e=b.faceNorm[v++],e=this.faces[e],e=e.normal,g+=e[0],n+=
e[1],o+=e[2];w?(d=w+1,g/=d,n/=d,o/=d,d=Math.sqrt(g*g+n*n+o*o),g/=d,n/=d,o/=d,s[0]=g,s[1]=n,s[2]=o):r++}}}return this}},removeDoubles:function(b){var f=[],a=[],c,d,e,g;c=0;for(d=this.points.length;c<d;c++){var n=-1,o=this.points[c];e=0;for(g=f.length;e<g;e++)if(h.vec3.equal(o,f[e],b)){n=e;break}-1!=n?a[c]=n:(a[c]=f.length,f.push(this.points[c]))}this.points=f;c=0;for(d=this.faces.length;c<d;c++){b=this.faces[c];e=0;for(g=b.points.length;e<g;e++)b.points[e]=a[b.points[e]]}return this},buildEdges:function(){var b,
f,a,c,d=[],e=[];b=0;for(a=this.faces.length;b<a;b++){var g=this.faces[b];f=0;for(c=g.points.length;f<c;f++){var n,o,s;s=g.segment;matId=g.material;f?(o=g.points[f],n=g.points[f-1]):(o=g.points[f],n=g.points[c-1]);d[n]=d[n]||{};d[n][matId]=d[n][matId]||{};d[n][matId][s]=d[n][matId][s]||{};!d[n][matId][s][o]&&(!d[o]||!d[o][matId][s][n])&&e.push([matId,s,n,o])}}this.edges=e;return this},subdivide:function(b,f){var a=h.vec3,f=f===m?!0:f;b===m&&(b=1);if(0!==b){var c,d,e,g,n,o={},s=[],E=[],w=this.points.length,
v=this.faces.length,q=[],A=[],B=[],t=[];c=0;for(e=v;c<e;c++)if(n=this.faces[c],n.points&&(3===n.points.length||4===n.points.length)){var u=[0,0,0];d=0;for(g=n.points.length;d<g;d++){var y=this.points[n.points[d]];u[0]+=y[0];u[1]+=y[1];u[2]+=y[2]}u[0]/=g;u[1]/=g;u[2]/=g;q[c]=this.addPoint(u);if(n.uvs.length===n.points.length){u=[0,0];d=0;for(g=n.uvs.length;d<g;d++)y=n.uvs[d],u[0]+=y[0],u[1]+=y[1];u[0]/=g;u[1]/=g;A[c]=u}if(n.point_colors.length===n.points.length){u=[0,0,0];d=0;for(g=n.point_colors.length;d<
g;d++)y=n.point_colors[d],u[0]+=y[0],u[1]+=y[1],u[2]+=y[2];u[0]/=g;u[1]/=g;u[2]/=g;B[c]=u}if(n.point_normals.length===n.points.length){u=[0,0,0];d=0;for(g=n.point_normals.length;d<g;d++)y=n.point_normals[d],u[0]+=y[0],u[1]+=y[1],u[2]+=y[2];u[0]/=g;u[1]/=g;u[2]/=g;t[c]=u}}c=0;for(e=this.faces.length;c<e;c++){n=this.faces[c];d=0;for(g=n.points.length;d<g;d++){var D,z;d?(D=d,z=d-1):(D=d,z=g-1);y=n.points[D];u=n.points[z];o[u]=o[u]||{};s[u]=s[u]||[];s[u].push(c);o[u][y]={face:c,a:u,b:y,fpa:D,fpb:z}}}for(c in o)if(o.hasOwnProperty(c))for(d in o[c])if(o[c].hasOwnProperty(d)){e=
o[c][d];n=o[d][c];if(n===m){r("Mesh.subdivide error. Hole at face #"+e.face+", Edge:["+e.fpa+"->"+e.fpb+"], holes not yet supported; perhaps use Mesh.removeDoubles()?");return}e.edge_point||(g=a.multiply(a.add(this.points[e.a],this.points[e.b]),0.5),f?(u=a.multiply(a.add(this.points[q[e.face]],this.points[q[n.face]]),0.5),e.edge_point=a.multiply(a.add(g,u),0.5)):e.edge_point=g,n.edge_point=e.edge_point,e.edge_avg=g,n.edge_avg=g,e.ep_idx=this.addPoint(e.edge_point),n.ep_idx=e.ep_idx);E[e.a]=E[e.a]||
[];E[e.a].push(e.edge_avg);g=this.faces[e.face].uvs;g.length&&(n=g[e.fpa],g=g[e.fpb],e.uv=[(n[0]+g[0])/2,(n[1]+g[1])/2]);n=this.faces[e.face].point_colors;n.length&&(e.color=a.multiply(a.add(n[e.fpa],n[e.fpb]),0.5));n=this.faces[e.face].point_normals;n.length&&(e.normal=a.normalize(a.multiply(a.add(n[e.fpa],n[e.fpb]),0.5)))}if(f){n=[];c=0;for(e=w;c<e;c++)if(u=[0,0,0],s[c]){d=0;for(g=s[c].length;d<g;d++)y=this.points[q[s[c][d]]],u[0]+=y[0],u[1]+=y[1],u[2]+=y[2];u[0]/=g;u[1]/=g;u[2]/=g;n[c]=u}u=[];
c=0;for(e=w;c<e;c++)if(y=[0,0,0],E[c]){d=0;for(g=E[c].length;d<g;d++)D=E[c][d],y[0]+=D[0],y[1]+=D[1],y[2]+=D[2];y[0]/=g;y[1]/=g;y[2]/=g;u[c]=y}c=0;for(e=w;c<e;c++)s[c]&&(w=s[c].length,d=1/w,E=2/w,w=a.multiply(this.points[c],(w-3)/w),w=a.add(w,a.multiply(n[c],d)),w=a.add(w,a.multiply(u[c],E)),this.points[c]=w)}for(c=0;c<v;c++)if(n=this.faces[c],!(3!==n.points.length&&4!==n.points.length))if(a=n.points.slice(0),s=n.uvs.slice(0),d=n.point_colors.slice(0),E=n.point_normals.slice(0),w=s.length===a.length,
e=d.length===a.length,g=E.length===a.length,n=n.material,3===a.length){if(this.setFaceMaterial(n),u=o[a[0]][a[1]],y=o[a[2]][a[0]],this.addFace([a[0],u.ep_idx,q[c],y.ep_idx],c),w&&(this.faces[c].uvs=[s[0],u.uv,A[c],y.uv]),e&&(this.faces[c].point_colors=[d[0],u.color,B[c],y.color]),g&&(this.faces[c].point_normals=[E[0],u.normal,t[c],y.normal]),u=o[a[1]][a[2]],y=o[a[0]][a[1]],n=this.addFace([a[1],u.ep_idx,q[c],y.ep_idx]),w&&(this.faces[n].uvs=[s[1],u.uv,A[c],y.uv]),e&&(this.faces[n].point_colors=[d[1],
u.color,B[c],y.color]),g&&(this.faces[n].point_normals=[E[1],u.normal,t[c],y.normal]),u=o[a[2]][a[0]],y=o[a[1]][a[2]],n=this.addFace([a[2],u.ep_idx,q[c],y.ep_idx]),w&&(this.faces[n].uvs=[s[2],u.uv,A[c],y.uv]),e&&(this.faces[n].point_colors=[d[2],u.color,B[c],y.color]),g)this.faces[n].point_normals=[E[2],u.normal,t[c],y.normal]}else if(this.setFaceMaterial(n),u=o[a[0]][a[1]],y=o[a[3]][a[0]],this.addFace([a[0],u.ep_idx,q[c],y.ep_idx],c),w&&(this.faces[c].uvs=[s[0],u.uv,A[c],y.uv]),e&&(this.faces[c].point_colors=
[d[0],u.color,B[c],y.color]),g&&(this.faces[c].point_normals=[E[0],u.normal,t[c],y.normal]),u=o[a[1]][a[2]],y=o[a[0]][a[1]],n=this.addFace([a[1],u.ep_idx,q[c],y.ep_idx]),w&&(this.faces[n].uvs=[s[1],u.uv,A[c],y.uv]),e&&(this.faces[n].point_colors=[d[1],u.color,B[c],y.color]),g&&(this.faces[n].point_normals=[E[1],u.normal,t[c],y.normal]),u=o[a[2]][a[3]],y=o[a[1]][a[2]],n=this.addFace([a[2],u.ep_idx,q[c],y.ep_idx]),w&&(this.faces[n].uvs=[s[2],u.uv,A[c],y.uv]),e&&(this.faces[n].point_colors=[d[2],u.color,
B[c],y.color]),g&&(this.faces[n].point_normals=[E[2],u.normal,t[c],y.normal]),u=o[a[3]][a[0]],y=o[a[2]][a[3]],n=this.addFace([a[3],u.ep_idx,q[c],y.ep_idx]),w&&(this.faces[n].uvs=[s[3],u.uv,A[c],y.uv]),e&&(this.faces[n].point_colors=[d[3],u.color,B[c],y.color]),g)this.faces[n].point_normals=[E[3],u.normal,t[c],y.normal];b--;if(0!==b)this.subdivide(b,f);else return this}},removeInternals:function(){var b,f,a,c,d,e={},g=this.faces.length,n,o,s,h;b=0;for(a=this.faces.length;b<a;b++){d=this.faces[b];f=
0;for(c=d.points.length;f<c;f++)f?(s=f,h=f-1):(s=f,h=c-1),n=d.points[s],o=d.points[h],e[n]=e[n]||{},e[n][o]===m?e[n][o]=[b]:e[n][o].push(b)}a=function(a){return-1!==e[o][n].indexOf(a)};for(b=0;b<g;b++){d=this.faces[b];var w=null;f=0;for(c=d.points.length;f<c;f++)f?(s=f,h=f-1):(s=f,h=c-1),n=d.points[s],o=d.points[h],w=w?w.filter(a):e[o][n];w.length&&(this.faces.splice(b,1),g--,b--)}return this},prepare:function(b){b===m&&(b=!0);this.buildWireframe&&!this.triangulateWireframe&&this.buildEdges();this.triangulateQuads().calcNormals();
this.buildWireframe&&this.triangulateWireframe&&this.buildEdges();this.compile();b&&!this.dynamic&&this.clean();return this},clean:function(){var b,f;b=0;for(f=this.points.length;b<f;b++)delete this.points[b],this.points[b]=null;this.points=[];b=0;for(f=this.faces.length;b<f;b++)delete this.faces[b].points,delete this.faces[b].point_normals,delete this.faces[b].uvs,delete this.faces[b].normal,delete this.faces[b],this.faces[b]=null;this.faces=[];return this},compileMap:function(b){var f=h.vec3,a=
h.vec2;b===m&&(b=1.0E-5);var c={segments:[],bounds:[]},d=[],e,g,n,o,s,q,w,v;this.materials.length||this.materials.push(new h.Material);e=0;for(q=this.materials.length;e<q;e++)d[e]=[];e=0;for(q=this.faces.length;e<q;e++)3===this.faces[e].points.length&&(n=this.faces[e].material,o=this.faces[e].segment,d[n][o]===m&&(d[n][o]=[],c.segments.push(o)),d[n][o].push(e));var r=[],A=0,B=!1,t=!1,u=!1,y;e=0;for(q=d.length;e<q;e++)for(g in d[e])if(d[e].hasOwnProperty(g))for(n=0;n<d[e][g].length;n++)y=d[e][g][n],
B=B||0!==this.faces[y].uvs.length,t=t||0!==this.faces[y].point_normals.length,u=u||0!==this.faces[y].point_colors.length;if(B)for(e=0;e<this.faces.length;e++)if(!this.faces[e].uvs.length)for(g=0;g<this.faces[e].points.length;g++)this.faces[e].uvs.push([0,0]);if(t)for(e=0;e<this.faces.length;e++)if(!this.faces[e].point_normals.length)for(g=0;g<this.faces[e].points.length;g++)this.faces[e].point_normals.push([0,0,0]);if(u)for(e=0;e<this.faces.length;e++)if(!this.faces[e].point_colors.length)for(g=0;g<
this.faces[e].points.length;g++)this.faces[e].point_colors.push([0,0,0]);e=0;for(q=d.length;e<q;e++)for(g in d[e])if(d[e].hasOwnProperty(g)){n=0;for(w=d[e][g].length;n<w;n++){y=d[e][g][n];for(o=0;3>o;o++){var D=this.faces[y].points[o],z=-1;if(r[D]!==m){s=0;for(v=r[D].length;s<v;s++){var x=r[D][s][0],I=r[D][s][1],z=r[D][s][2];t&&(z=f.equal(this.faces[x].point_normals[I],this.faces[y].point_normals[o],b)?z:-1);B&&(z=a.equal(this.faces[x].uvs[I],this.faces[y].uvs[o],b)?z:-1);u&&(z=f.equal(this.faces[x].point_colors[I],
this.faces[y].point_colors[o],b)?z:-1)}}-1!==z?(c.elements===m&&(c.elements=[]),c.elements[e]===m&&(c.elements[e]=[]),c.elements[e][g]===m&&(c.elements[e][g]=[]),c.elements[e][g].push(z)):(c.points===m&&(c.points=[]),c.points.push(D),0===c.bounds.length?(c.bounds[0]=[this.points[D][0],this.points[D][1],this.points[D][2]],c.bounds[1]=[this.points[D][0],this.points[D][1],this.points[D][2]]):(this.points[D][0]<c.bounds[0][0]&&(c.bounds[0][0]=this.points[D][0]),this.points[D][1]<c.bounds[0][1]&&(c.bounds[0][1]=
this.points[D][1]),this.points[D][2]<c.bounds[0][2]&&(c.bounds[0][2]=this.points[D][2]),this.points[D][0]>c.bounds[1][0]&&(c.bounds[1][0]=this.points[D][0]),this.points[D][1]>c.bounds[1][1]&&(c.bounds[1][1]=this.points[D][1]),this.points[D][2]>c.bounds[1][2]&&(c.bounds[1][2]=this.points[D][2])),t&&(c.normals===m&&(c.normals=[]),c.normals.push([y,o])),u&&(c.colors===m&&(c.colors=[]),c.colors.push([y,o])),B&&(c.uvs===m&&(c.uvs=[]),c.uvs.push([y,o])),c.elements===m&&(c.elements=[]),c.elements[e]===m&&
(c.elements[e]=[]),c.elements[e][g]===m&&(c.elements[e][g]=[]),c.elements[e][g].push(A),r[D]===m&&(r[D]=[]),r[D].push([y,o,A]),A++)}}}if(this.edges){c.line_elements=[];e=0;for(q=this.edges.length;e<q;e++)f=this.edges[e],n=f[0],o=f[1],b=f[2],f=f[3],c.line_elements[n]=c.line_elements[n]||[],c.line_elements[n][o]=c.line_elements[n][o]||[],c.line_elements[n][o].push(r[b][0][2]),c.line_elements[n][o].push(r[f][0][2])}c.dynamic=this.dynamic;return c},compileVBO:function(b,f,a,c,d,e,g,n){"object"==typeof f?
(f=f.element!==m?f.element:!0,a=f.vertex!==m?f.vertex:!0,e=f.color!==m?f.color:!0,c=f.normal!==m?f.normal:!0,d=f.uv!==m?f.uv:!0,g=f.lines!==m?f.lines:!!b.line_elements,n=f.dynamic!==m?f.dynamic:b.dynamic):(f===m&&(f=!0),a===m&&(a=!0),e===m&&(e=!0),c===m&&(c=!0),d===m&&(d=!0),g===m&&(g=!!b.line_elements),n===m&&(n=b.dynamic));var o={},s,h,w,v,q;n&&(v={points:new Int16Array(b.points.length),face_points:new Int16Array(2*b.points.length),segments:null},o.dynamicMap=v,o.dynamic=!0);if(b.points&&a){s=b.points.length;
o.vbo_points=new Float32Array(3*s);for(a=0;a<s;a++)h=b.points[a],o.vbo_points[3*a]=this.points[h][0],o.vbo_points[3*a+1]=this.points[h][1],o.vbo_points[3*a+2]=this.points[h][2],n&&(v.points[a]=h)}if(n){q=b.normals||b.colors||b.uvs;a=0;for(s=q.length;a<s;a++)h=q[a],v.face_points[2*a]=h[0],v.face_points[2*a+1]=h[1]}if(b.normals&&c){s=b.normals.length;o.vbo_normals=new Float32Array(3*s);for(a=c=0;a<s;a++)h=b.normals[a],o.vbo_normals[c++]=this.faces[h[0]].point_normals[h[1]][0],o.vbo_normals[c++]=this.faces[h[0]].point_normals[h[1]][1],
o.vbo_normals[c++]=this.faces[h[0]].point_normals[h[1]][2]}if(b.colors&&e){s=b.colors.length;o.vbo_colors=new Float32Array(3*s);for(a=c=0;a<s;a++)h=b.colors[a],o.vbo_colors[c++]=this.faces[h[0]].point_colors[h[1]][0],o.vbo_colors[c++]=this.faces[h[0]].point_colors[h[1]][1],o.vbo_colors[c++]=this.faces[h[0]].point_colors[h[1]][2]}if(b.uvs&&d){s=b.uvs.length;o.vbo_uvs=new Float32Array(2*s);for(a=c=0;a<s;a++)h=b.uvs[a],o.vbo_uvs[c++]=this.faces[h[0]].uvs[h[1]][0],o.vbo_uvs[c++]=this.faces[h[0]].uvs[h[1]][1]}if(f){o.elements_ref=
[];o.vbo_elements=[];a=0;for(s=b.elements.length;a<s;a++)for(w in o.elements_ref[a]=[],f=0,b.elements[a])if(b.elements[a].hasOwnProperty(w)){c=b.elements[a][w];d=0;for(e=c.length;d<e;d++)o.vbo_elements.push(c[d]);o.elements_ref[a][f]=[w|0,c.length|0];f++}o.vbo_elements=new Uint16Array(o.vbo_elements)}if(g){o.line_elements_ref=[];o.vbo_line_elements=[];a=0;for(s=b.line_elements.length;a<s;a++)for(w in o.line_elements_ref[a]=[],f=0,b.line_elements[a])if(b.line_elements[a].hasOwnProperty(w)){c=b.line_elements[a][w];
d=0;for(e=c.length;d<e;d++)o.vbo_line_elements.push(c[d]);o.line_elements_ref[a][f]=[w|0,c.length|0];f++}o.vbo_line_elements=new Uint16Array(o.vbo_line_elements)}o.segments=b.segments;o.bounds=b.bounds;if(n&&1<b.segments.length){b=[];q=v.points;a=0;for(s=q.length;a<s;a++)g=this.faces[v.face_points[2*a]].segment||0,b[g]===m&&(b[g]=[]),b[g].push(a);o.dynamicMap.segmentMap=b}return o},updateVBO:function(b,f){if(!b.dynamic)return!1;var a,c,d=b.dynamicMap,e=f.points&&!!b.vbo_points,g=f.normals&&!!b.vbo_normals,
n=f.uvs&&!!b.vbo_uvs,o=f.colors&&!!b.vbo_colors;c=f.segments;var s,h,w;if(f.segments!==m)for(var v=0,q=c.length;v<q;v++)for(var r=d.segmentMap[c[v]],t=0,G=r.length;t<G;t++){if(a=r[t],h=this.faces[d.face_points[2*a]],w=d.face_points[2*a+1],e&&(s=this.points[d.points[a]],b.vbo_points[3*a]=s[0],b.vbo_points[3*a+1]=s[1],b.vbo_points[3*a+2]=s[2]),g&&(s=h.point_normals[w],b.vbo_normals[3*a]=s[0],b.vbo_normals[3*a+1]=s[1],b.vbo_normals[3*a+2]=s[2]),o&&(s=h.point_colors[w],b.vbo_colors[3*a]=s[0],b.vbo_colors[3*
a+1]=s[1],b.vbo_colors[3*a+2]=s[2]),n)s=h.uvs[w],b.vbo_uvs[2*a]=s[0],b.vbo_uvs[2*a+1]=s[1]}else{a=0;for(c=d.points.length;a<c;a++)if(h=this.faces[d.face_points[2*a]],w=d.face_points[2*a+1],e&&(s=this.points[d.points[a]],b.vbo_points[3*a]=s[0],b.vbo_points[3*a+1]=s[1],b.vbo_points[3*a+2]=s[2]),g&&(s=h.point_normals[w],b.vbo_normals[3*a]=s[0],b.vbo_normals[3*a+1]=s[1],b.vbo_normals[3*a+2]=s[2]),o&&(s=h.point_colors[w],b.vbo_colors[3*a]=s[0],b.vbo_colors[3*a+1]=s[1],b.vbo_colors[3*a+2]=s[2]),n)s=h.uvs[w],
b.vbo_uvs[2*a]=s[0],b.vbo_uvs[2*a+1]=s[1]}return this},rebufferVBO:function(b,f,a){var c=q.gl;a.points&&(c.bindBuffer(c.ARRAY_BUFFER,f.gl_points),c.bufferData(c.ARRAY_BUFFER,b.vbo_points,c.DYNAMIC_DRAW));a.normals&&b.vbo_normals&&(c.bindBuffer(c.ARRAY_BUFFER,f.gl_normals),c.bufferData(c.ARRAY_BUFFER,b.vbo_normals,c.DYNAMIC_DRAW));a.uvs&&b.vbo_uvs&&(c.bindBuffer(c.ARRAY_BUFFER,f.gl_uvs),c.bufferData(c.ARRAY_BUFFER,b.vbo_uvs,c.DYNAMIC_DRAW));a.colors&&b.vbo_colors&&(c.bindBuffer(c.ARRAY_BUFFER,f.gl_colors),
c.bufferData(c.ARRAY_BUFFER,b.vbo_colors,c.DYNAMIC_DRAW));c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null);return this},bufferVBO:function(b,f){var a=q.gl,c={};f===m&&(f={});c.gl_points=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c.gl_points);a.bufferData(a.ARRAY_BUFFER,b.vbo_points,a.STATIC_DRAW);b.vbo_normals?(c.gl_normals=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,c.gl_normals),a.bufferData(a.ARRAY_BUFFER,b.vbo_normals,a.STATIC_DRAW)):c.gl_normals=f.gl_normals?f.gl_normals:null;b.vbo_uvs?(c.gl_uvs=
a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,c.gl_uvs),a.bufferData(a.ARRAY_BUFFER,b.vbo_uvs,a.STATIC_DRAW)):c.gl_uvs=f.gl_uvs?f.gl_uvs:null;b.vbo_colors?(c.gl_colors=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,c.gl_colors),a.bufferData(a.ARRAY_BUFFER,b.vbo_colors,a.STATIC_DRAW)):c.gl_colors=f.gl_colors?f.gl_colors:null;!b.vbo_elements&&f.gl_elements?(c.gl_elements=f.gl_elements,c.elements_ref=f.elements_ref):(c.gl_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,c.gl_elements),a.bufferData(a.ELEMENT_ARRAY_BUFFER,
b.vbo_elements,a.STATIC_DRAW),c.elements_ref=b.elements_ref);!b.vbo_line_elements&&f.gl_line_elements?(c.gl_line_elements=f.gl_line_elements,c.line_elements_ref=f.line_elements_ref):(c.gl_line_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,c.gl_line_elements),a.bufferData(a.ELEMENT_ARRAY_BUFFER,b.vbo_line_elements,a.STATIC_DRAW),c.line_elements_ref=b.line_elements_ref);c.segments=b.segments;c.bounds=b.bounds;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);return c},update:function(b){var b=
b||{},f=b.points||b.point||b.vertex||b.vertices||b.all||!0,a=b.uvs||b.uv||b.texture||b.all||!1,c=b.normals||b.normal||b.all||!0,d=b.colors||b.color||b.all||!1,b=b.segments||b.segment;b!==m&&b.length===m&&(b=[b]);if(!this.dynamic)return r("Mesh not defined as dynamic, cannot update."),!1;c&&this.normalMapRef&&this.recalcNormals(m,{segments:b});f={points:f,uvs:a,normals:c,colors:d,segments:b};this.updateVBO(this.dynamicData.VBO,f);this.rebufferVBO(this.dynamicData.VBO,this.dynamicData.buffer,f)},bindBuffer:function(b){null===
this.originBuffer&&(this.originBuffer=b);this.compiled=b;this.segment_state=[];for(var f=0,a=b.segments.length;f<a;f++)this.segment_state[b.segments[f]]=!0;this.bb=b.bounds},compile:function(b){if(0<this.faces.length&&0<this.points.length){var b=this.compileVBO(this.compileMap(b)),f=this.bufferVBO(b);this.bindBuffer(f);if(this.dynamic){this.sourcePoints=[];for(var a=0,c=this.points.length;a<c;a++)this.sourcePoints[a]=this.points[a].slice(0);this.dynamicData={VBO:b,buffer:f}}}return this},addMorphTarget:function(b){null===
this.morphTargets&&(this.morphTargets=[]);this.morphTargets.push(b)},setMorphSource:function(b){this.morphSourceIndex!==b&&(this.morphSourceIndex=b,this.bindBuffer(this.morphTargets[b]))},setMorphTarget:function(b){this.morphTargetIndex!==b&&(this.morphTargetIndex=b,this.morphTarget=this.morphTargets[b])},setMorphWeight:function(b){this.morphWeight=b},morphTargetCount:function(){return null!==this.morphTargets?this.morphTargets.length:0}};return{Mesh:t,Face:x}});
CubicVR.RegisterModule("UVMapper",function(h){function x(a){a=h.get(a)||{};this.rotation=a.rotation===t?[0,0,0]:a.rotation;this.scale=a.scale===t?[1,1,1]:a.scale;this.center=a.center===t?[0,0,0]:a.center;this.projection_mode=a.projectionMode===t?m.uv.projection.PLANAR:h.parseEnum(m.uv.projection,a.projectionMode);this.projection_axis=a.projectionAxis===t?m.uv.axis.X:h.parseEnum(m.uv.axis,a.projectionAxis);this.wrap_w_count=a.wrapW===t?1:a.wrapW;this.wrap_h_count=a.wrapH===t?1:a.wrapH}var t=h.undef,
m=h.enums,q=2*Math.PI,r=Math.PI/2;m.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var b=function(a,c,d){return 0===a&&0===d?0:0===d?0>a?r:-r:0>d?-Math.atan(a/d)+Math.PI:-Math.atan(a/d)},f=function(a,c,d){var e;0===a&&0===d?(e=0,a=0!==c?0>c?-r:r:0):(e=0===d?0>a?r:-r:0>d?-Math.atan(a/d)+Math.PI:-Math.atan(a/d),a=Math.sqrt(a*a+d*d),a=0===a?0>c?-r:r:Math.atan(c/a));return[e,a]};x.prototype={setRotation:function(a){this.rotation=a},setScale:function(a){this.scale=
a},setCenter:function(a){this.center=a},setProjectionAxis:function(a){this.projection_axis=a},setProjectionMode:function(a){this.projection_mode=a},setWrapW:function(a){this.wrap_w_count=a},setWrapH:function(a){this.wrap_h_count=a},apply:function(a,c,d,e,g){var n=h.mat4,o,s,E,w,v,C=new h.Transform,A=!1,B=null;if(this.center[0]||this.center[1]||this.center[2])C.translate(-this.center[0],-this.center[1],-this.center[2]),A=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&
C.rotate(this.rotation[2],0,0,1),this.rotation[1]&&C.rotate(this.rotation[1],0,1,0),this.rotation[2]&&C.rotate(this.rotation[0],1,0,0),A=!0;A&&(B=C.getResult());"object"===typeof c&&(c=a.materials.indexOf(c));var C=0,G=a.faces.length;e&&(C=e);for(g&&(G=g+1);C<G;C++)if(a.faces[C].material===c&&!(d!==t&&a.faces[C].segment!==d)){var u,y,D;if(this.projection_mode===m.uv.projection.CUBIC||this.projection_mode===m.uv.projection.SKY)u=Math.abs(a.faces[C].normal[0]),y=Math.abs(a.faces[C].normal[1]),D=Math.abs(a.faces[C].normal[2]);
for(var e=[],g=0,z=a.faces[C].points.length;g<z;g++){s=a.faces[C].points[g];var x=a.faces[C].points[(g+1)%3],I=a.faces[C].points[(g+2)%3];o=a.points[s];var H=a.points[x],J=a.points[I],L;A&&(o=n.vec3_multiply(o,B));L=this.projection_mode;if(L===m.uv.projection.SKY)s=a.sky_mapping,u>=y&&u>=D&&(E=o[2]/this.scale[2]+this.scale[2]/2,w=-o[1]/this.scale[1]+this.scale[1]/2,0>a.faces[C].normal[0]?(E=(s[2][2]-s[2][0])*(1-E),w=1-(s[2][3]-s[2][1])*w,E+=s[2][0],w+=s[2][1]):(E*=s[3][2]-s[3][0],w=1-(s[3][3]-s[3][1])*
w,E+=s[3][0],w+=s[3][1])),y>=u&&y>=D&&(E=o[0]/this.scale[0]+this.scale[0]/2,w=-o[2]/this.scale[2]+this.scale[2]/2,0>a.faces[C].normal[1]?(E*=s[1][2]-s[1][0],w=1-(s[1][3]-s[1][1])*w,E+=s[1][0],w-=s[1][1]):(E*=s[0][2]-s[0][0],w=1-(s[0][3]-s[0][1])*w,E+=s[0][0],w-=s[0][1])),D>=u&&D>=y&&(E=o[0]/this.scale[0]+this.scale[0]/2,w=o[1]/this.scale[1]+this.scale[1]/2,0>a.faces[C].normal[2]?(E*=s[4][2]-s[4][0],w=1-(s[4][3]-s[4][1])*(1-w),E+=s[4][0],w-=s[4][1]):(E=(s[5][2]-s[5][0])*(1-E),w=1-(s[5][3]-s[5][1])*
(1-w),E+=s[5][0],w+=s[5][1])),a.faces[C].setUV([E,w],g);else if(L===m.uv.projection.CUBIC)u>=y&&u>=D&&(E=o[2]/this.scale[2]+0.5,w=o[1]/this.scale[1]+0.5),y>=u&&y>=D&&(E=-o[0]/this.scale[0]+0.5,w=o[2]/this.scale[2]+0.5),D>=u&&D>=y&&(E=-o[0]/this.scale[0]+0.5,w=o[1]/this.scale[1]+0.5),0<a.faces[C].normal[0]&&(E=-E),0>a.faces[C].normal[1]&&(E=-E),0<a.faces[C].normal[2]&&(E=-E),a.faces[C].setUV([E,w],g);else if(L===m.uv.projection.PLANAR)E=this.projection_axis===m.uv.axis.X?o[2]/this.scale[2]+0.5:-o[0]/
this.scale[0]+0.5,w=this.projection_axis===m.uv.axis.Y?o[2]/this.scale[2]+0.5:o[1]/this.scale[1]+0.5,a.faces[C].setUV([E,w],g);else{if(L===m.uv.projection.CYLINDRICAL)L=this.projection_axis,L===m.uv.axis.X?(v=b(o[2],o[0],-o[1]),w=-o[0]/this.scale[0]+0.5):L===m.uv.axis.Y?(v=b(-o[0],o[1],o[2]),w=-o[1]/this.scale[1]+0.5):L===m.uv.axis.Z&&(v=b(-o[0],o[2],-o[1]),w=-o[2]/this.scale[2]+0.5),v=1-v/q,1!==this.wrap_w_count&&(v*=this.wrap_w_count),o=v,s=w;else if(L===m.uv.projection.SPHERICAL){var M,K,N;L=this.projection_axis;
L===m.uv.axis.X?(M=e[s]?e[s]:f(o[2],o[0],-o[1]),e[s]||(e[s]=M),K=e[x]?e[x]:f(H[2],H[0],-H[1]),e[x]||(e[x]=K),N=e[I]?e[I]:f(J[2],J[0],-J[1]),e[I]||(e[I]=N)):L===m.uv.axis.Y?(M=e[s]?e[s]:f(o[0],-o[1],o[2]),e[s]||(e[s]=M),K=e[x]?e[x]:f(H[0],-H[1],H[2]),e[x]||(e[x]=K),N=e[I]?e[I]:f(J[0],-J[1],J[2]),e[I]||(e[I]=N)):L===m.uv.axis.Z&&(M=e[s]?e[s]:f(-o[0],o[2],-o[1]),e[s]||(e[s]=M),K=e[x]?e[x]:f(-H[0],H[2],-H[1]),e[x]||(e[x]=K),N=e[I]?e[I]:f(-J[0],J[2],-J[1]),e[I]||(e[I]=N));Math.abs(M[0]-K[0])>r&&Math.abs(M[0]-
N[0])>r&&(M[0]=M[0]>K[0]&&M[0]>N[0]?M[0]-q:M[0]+q);Math.abs(M[1]-K[1])>r&&Math.abs(M[1]-N[1])>r&&(M[1]=M[1]>K[1]&&M[1]>N[1]?M[1]-q:M[1]+q);v=1-M[0]/q;s=0.5-M[1]/Math.PI;1!==this.wrap_w_count&&(v*=this.wrap_w_count);1!==this.wrap_h_count&&(s*=this.wrap_h_count);o=v}else s=o=0;a.faces[C].setUV([o,s],g)}}}return this}};return{UVMapper:x}});
CubicVR.RegisterModule("Renderer",function(h){var x=h.undef;return{renderObject:function(t,m,q,r,b,f,a){var c=!1,b=b||!1,f=f||!1;if(null!==t.compiled){var d=0,e=h.GLCore.gl,g,n=r===x?0:r.length,o,s=0,E,w=null,v=t.instanceMaterials||t.materials,C=(a=(t.wireframe||a)&&t.compiled.line_elements_ref)?t.compiled.line_elements_ref:t.compiled.elements_ref,A=!1,B,G,u;e.depthFunc(e.LEQUAL);q===x&&(q=cubicvr_identity);for(var y=0,D=C.length;y<D;y++){var w=a&&t.wireframeMaterial?t.wireframeMaterial:v[y],z=0,
s=!1;if(1>w.opacity&&b)c=!0;else if(!(f&&1<=w.opacity)){1!==w.opacity?(e.enable(e.BLEND),e.depthMask(0),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)):(e.depthMask(1),e.disable(e.BLEND),e.blendFunc(e.ONE,e.ONE));for(var F=0,I=C[y].length;F<I;F++)if(E=C[y][F][0],s=!1,g=C[y][F][1],z+=g,w.visible){if(!t.segment_state[E])if(z>g){d+=2*g;z-=g;if(n){G=!1;for(B=0;B<n;){g=n-B;g>h.MAX_LIGHTS&&(g=h.MAX_LIGHTS);0<B&&!G&&(e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE),e.depthFunc(e.EQUAL),G=!0);o=r[B];u=o.light_type;
for(s=0;s<g;s++)if(r[s+B].light_type!=u){g=s;break}w.use(o.light_type,g);o=w.shader[o.light_type][g];e.uniformMatrix4fv(o.matrixModelView,!1,m.mvMatrix);e.uniformMatrix4fv(o.matrixProjection,!1,m.pMatrix);e.uniformMatrix4fv(o.matrixObject,!1,q);e.uniformMatrix3fv(o.matrixNormal,!1,m.nMatrix);A||(w.bindObject(t,o),A=-1!=o.vertexTexCoord,a&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.compiled.gl_line_elements));for(s=0;s<g;s++)r[s+B].setupShader(o,s);a?e.drawElements(e.LINES,z,e.UNSIGNED_SHORT,d):e.drawElements(e.TRIANGLES,
z,e.UNSIGNED_SHORT,d);B+=g}G&&(e.disable(e.BLEND),e.depthFunc(e.LEQUAL))}else w.use(0,0),e.uniformMatrix4fv(w.shader[0][0].matrixModelView,!1,m.mvMatrix),e.uniformMatrix4fv(w.shader[0][0].matrixProjection,!1,m.pMatrix),e.uniformMatrix4fv(w.shader[0][0].matrixObject,!1,q),e.uniformMatrix3fv(w.shader[0][0].matrixNormal,!1,m.nMatrix),A||(w.bindObject(t,w.shader[0][0]),A=-1!=w.shader[0][0].vertexTexCoord,a&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.compiled.gl_line_elements)),a?e.drawElements(e.LINES,z,e.UNSIGNED_SHORT,
d):e.drawElements(e.TRIANGLES,z,e.UNSIGNED_SHORT,d);d+=2*z;z=0;s=!0}else d+=2*z,z=0}else d+=2*g,z-=g;if(!s&&t.segment_state[E]&&w.visible){if(n){G=!1;for(B=0;B<n;){g=n-B;g>h.MAX_LIGHTS&&(g=h.MAX_LIGHTS);0<B&&!G&&(e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE),e.depthFunc(e.EQUAL),G=!0);o=r[B];u=o.light_type;for(s=0;s<g;s++)if(r[s+B].light_type!=u){g=s;break}w.use(o.light_type,g);o=w.shader[o.light_type][g];e.uniformMatrix4fv(o.matrixModelView,!1,m.mvMatrix);e.uniformMatrix4fv(o.matrixProjection,!1,m.pMatrix);
e.uniformMatrix4fv(o.matrixObject,!1,q);e.uniformMatrix3fv(o.matrixNormal,!1,m.nMatrix);A||(w.bindObject(t,o),A=-1!=o.vertexTexCoord,a&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.compiled.gl_line_elements));for(s=0;s<g;s++)r[s+B].setupShader(o,s);a?e.drawElements(e.LINES,z,e.UNSIGNED_SHORT,d):e.drawElements(e.TRIANGLES,z,e.UNSIGNED_SHORT,d);B+=g}G&&(e.disable(e.BLEND),e.depthFunc(e.LEQUAL))}else w.use(0,0),e.uniformMatrix4fv(w.shader[0][0].matrixModelView,!1,m.mvMatrix),e.uniformMatrix4fv(w.shader[0][0].matrixProjection,
!1,m.pMatrix),e.uniformMatrix4fv(w.shader[0][0].matrixObject,!1,q),e.uniformMatrix3fv(w.shader[0][0].matrixNormal,!1,m.nMatrix),A||(w.bindObject(t,w.shader[0][0]),A=-1!=w.shader[0][0].vertexTexCoord,a&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.compiled.gl_line_elements)),a?e.drawElements(e.LINES,z,e.UNSIGNED_SHORT,d):e.drawElements(e.TRIANGLES,z,e.UNSIGNED_SHORT,d);d+=2*z}}}w&&o?w.clearObject(t,o):w.clearObject(t,null);e.depthMask(1);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);return c}}}});
CubicVR.RegisterModule("Light",function(h){function x(b,f){var a=h.aabb,b=h.get(b)||{};b===q&&(b=m.light.type.POINT);f===q&&(f=m.light.method.DYNAMIC);"object"==typeof b?(this.light_type=b.type!==q?h.parseEnum(m.light.type,b.type):m.light.type.POINT,this.diffuse=b.diffuse!==q?b.diffuse:[1,1,1],this.specular=b.specular!==q?b.specular:[1,1,1],this.intensity=b.intensity!==q?b.intensity:1,this.position=b.position!==q?b.position:[0,0,0],this.direction=b.direction!==q?b.direction:[0,0,0],this.distance=
b.distance!==q?b.distance:this.light_type===m.light.type.AREA?30:10,this.cutoff=b.cutoff!==q?b.cutoff:60,this.map_res=b.map_res!==q?b.map_res:this.light_type===m.light.type.AREA?2048:512,this.map_res=b.mapRes!==q?b.mapRes:this.map_res,this.method=b.method!==q?h.parseEnum(m.light.method,b.method):f,this.areaCam=b.areaCam!==q?b.areaCam:null,this.areaCeiling=b.areaCeiling!==q?b.areaCeiling:40,this.areaFloor=b.areaFloor!==q?b.areaFloor:-40,this.areaAxis=b.areaAxis!==q?b.areaAxis:[1,1,0],this.projectorTex=
b.projector!==q?b.projector:null):(this.light_type=h.parseEnum(m.light.type,b),this.diffuse=[1,1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===m.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===m.light.type.AREA?2048:512,this.method=h.parseEnum(m.light.method,f),this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0],this.projectorTex=null);if(this.projectorTex&&"string"===typeof this.projectorTex){var c=
this.projectorTex;this.projectorTex=h.Textures_ref[c]!==q?h.Textures_obj[h.Textures_ref[c]]:new h.Texture(c)}this.setType(this.light_type);this.lposition=[0,0,0];this.dirty=!0;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.aabb=[[0,0,0],[0,0,0]];a.reset(this.aabb,this.position);this.adjust_octree=h.SceneObject.prototype.adjust_octree;this.motion=null;this.rotation=[0,0,0];(this.light_type===
m.light.type.SPOT_SHADOW||this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===m.light.type.AREA&&h.features.lightShadows)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=null}var t=h.GLCore,m=h.enums,q=h.undef,r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];m.light={type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,SPOT_SHADOW_PROJECTOR:7,MAX:8},method:{GLOBAL:0,STATIC:1,DYNAMIC:2}};x.prototype={get x(){return this.position[0]},set x(b){this.position[0]=
b},get y(){return this.position[1]},set y(b){this.position[1]=b},get z(){return this.position[2]},set z(b){this.position[2]=b},get rotX(){return this.rotation[0]},set rotX(b){this.rotation[0]=b},get rotY(){return this.rotation[1]},set rotY(b){this.rotation[1]=b},get rotZ(){return this.rotation[2]},set rotZ(b){this.rotation[2]=b},get dirX(){return this.direction[0]},set dirX(b){this.direction[0]=b},get dirY(){return this.direction[1]},set dirY(b){this.direction[1]=b},get dirZ(){return this.direction[2]},
set dirZ(b){this.direction[2]=b},get pos(){return this.position.slice(0)},set pos(b){this.position=b.slice(0)},get rot(){return this.rotation.slice(0)},set rot(b){this.rotation=b.slice(0)},get dir(){return this.direction.slice(0)},set dir(b){this.direction=vec3.normalize(b.slice(0))},setType:function(b){if(b===m.light.type.AREA&&!h.features.lightShadows)this.dummyCam=new h.Camera,this.areaCam=new h.Camera,this.updateAreaLight(),this.areaCam=this.dummyCam=null,b=m.light.type.DIRECTIONAL;else if((b===
m.light.type.SPOT_SHADOW||b===m.light.type.SPOT_SHADOW_PROJECTOR)&&!h.features.lightShadows)b=m.light.type.SPOT;this.light_type=b},setParent:function(b){this.parent=b},setMethod:function(b){this.method=b},setDiffuse:function(b){this.diffuse=b},setSpecular:function(b){this.specular=b},setIntensity:function(b){this.intensity=b},setPosition:function(b){this.position=b},setDistance:function(b){this.distance=b},setCutoff:function(b){this.cutoff=b},prepare:function(b){var f=h.mat4,a=h.mat3,c=this.light_type;
this.parent?c===m.light.type.SPOT||c===m.light.type.SPOT_SHADOW||c===m.light.type.SPOT_SHADOW_PROJECTOR?(c=f.inverse_mat3(this.parent.tMatrix),a.transpose_inline(c),this.lDir=a.vec3_multiply(this.direction,c),this.lDir=a.vec3_multiply(this.lDir,b.nMatrix),this.lPos=f.vec3_multiply(this.position,f.multiply(b.mvMatrix,this.parent.tMatrix))):c===m.light.type.POINT&&(this.lPos=f.vec3_multiply(this.position,f.multiply(b.mvMatrix,this.parent.tMatrix))):c===m.light.type.DIRECTIONAL?this.lDir=a.vec3_multiply(this.direction,
b.nMatrix):c===m.light.type.SPOT||c===m.light.type.SPOT_SHADOW||c===m.light.type.SPOT_SHADOW_PROJECTOR?(this.lDir=a.vec3_multiply(this.direction,b.nMatrix),this.lPos=f.vec3_multiply(this.position,b.mvMatrix)):c===m.light.type.POINT?this.lPos=f.vec3_multiply(this.position,b.mvMatrix):c===m.light.type.AREA&&(this.lDir=a.vec3_multiply(this.direction,b.nMatrix))},control:function(b,f,a){b===m.motion.POS?this.position[f]=a:b===m.motion.INTENSITY&&(this.intensity=a)},getAABB:function(){var b=h.vec3,f=h.aabb,
a=[[0,0,0],[0,0,0]];f.engulf(a,[this.distance,this.distance,this.distance]);f.engulf(a,[-this.distance,-this.distance,-this.distance]);a[0]=b.add(a[0],this.position);a[1]=b.add(a[1],this.position);return this.aabb=a},setDirection:function(b,f,a){var c=h.vec3;if("object"===typeof b)this.setDirection(b[0],b[1],b[2]);else return this.direction=c.normalize([b,f,a]),this},lookat:function(b,f,a){var c=h.vec3;if("object"===typeof b)this.lookat(b[0],b[1],b[2]);else return this.direction=c.normalize(c.subtract([b,
f,a],this.position)),this},setRotation:function(b,f,a){var c=h.mat4,d=h.vec3;if("object"===typeof b)this.setRotation(b[0],b[1],b[2]);else{var e=new h.Transform;e.rotate([-b,-f,-a]);e.pushMatrix();this.direction=d.normalize(c.vec3_multiply([1,0,0],e.getResult()));this.rotation=[b,f,a];return this}},setupShader:function(b,f){var a=t.gl;a.uniform3fv(b.lightDiffuse[f],this.diffuse);a.uniform3fv(b.lightSpecular[f],this.specular);this.lPos&&a.uniform3fv(b.lightPosition[f],this.lPos);this.lDir&&a.uniform3fv(b.lightDirection[f],
this.lDir);a.uniform1f(b.lightIntensity[f],this.intensity);a.uniform1f(b.lightDistance[f],this.distance);(this.light_type===m.light.type.SPOT_SHADOW||this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===m.light.type.SPOT)&&a.uniform1f(b.lightCutOffAngle[f],this.cutoff);if(this.light_type===m.light.type.SPOT_SHADOW||this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===m.light.type.AREA)this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR?(this.shadowMapTex.texture.use(t.gl.TEXTURE0+
2*f),a.uniform1i(b.lightShadowMap[f],2*f),this.projectorTex.use(t.gl.TEXTURE0+2*f+1),a.uniform1i(b.lightProjectionMap[f],2*f+1)):(this.shadowMapTex.texture.use(t.gl.TEXTURE0+f),a.uniform1i(b.lightShadowMap[f],f)),a.uniform3fv(b.lightDepthClip[f],[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),a.uniformMatrix4fv(b.lightShadowMatrix[f],!1,this.spMatrix)},setShadow:function(b){h.features.lightShadows&&(this.map_res=b,this.shadowMapTex=new h.RenderBuffer(this.map_res,this.map_res,!0),this.shadowMapTex.texture.setFilter(m.texture.filter.NEAREST),
this.dummyCam=new h.Camera(this.map_res,this.map_res,80,0.1,this.distance),this.dummyCam.calc_nmatrix=!1,this.dummyCam.setTargeted(!0),this.has_shadow=!0)},hasShadow:function(){return has_shadow},setProjector:function(b){this.projectorTex=b},hasProjector:function(){return null!==this.projectorTex?!0:!1},shadowBegin:function(){var b=t.gl,f=h.mat4,a=h.mat3;this.shadowMapTex.use();b.viewport(0,0,this.map_res,this.map_res);b.clear(b.DEPTH_BUFFER_BIT|b.COLOR_BUFFER_BIT);this.light_type!==m.light.type.AREA?
(this.dummyCam.setClip(0.1,this.distance),this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();if(this.parent){var c=f.inverse_mat3(this.parent.tMatrix);a.transpose_inline(c);a.vec3_multiply(this.direction,c);f.vec3_multiply(this.position,this.parent.tMatrix);this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],0,1,0);f.multiply(this.dummyCam.mvMatrix.slice(0),
f.inverse(this.parent.tMatrix),this.dummyCam.mvMatrix)}else this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],0,1,0);b.cullFace(b.FRONT)},shadowEnd:function(){var b=t.gl;b.bindFramebuffer(b.FRAMEBUFFER,null);b.cullFace(b.BACK);this.setupTexGen()},setupTexGen:function(){var b=h.mat4;this.spMatrix=b.multiply(r,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=
b.multiply(this.spMatrix,this.dummyCam.pMatrix);this.spMatrix=b.multiply(this.spMatrix,this.dummyCam.mvMatrix)},setAreaAxis:function(b){this.areaAxis=b},updateAreaLight:function(){var b=h.vec3,f=this.areaCeiling-this.areaFloor;this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var a=0,a=Math.tan(this.areaCam.fov/2*(Math.PI/180)),c=b.subtract(this.areaCam.target,this.areaCam.position);c[1]=0;c=b.normalize(c);b.normalize(b.cross(c,[0,1,0]));var d=-Math.atan2(c[2],c[0]),a=this.distance/2*Math.abs(a)-
this.distance/2;a<this.distance/3/2&&(a=this.distance/3/2);var c=b.multiply(c,a),a=this.areaAxis[1]*(Math.PI/180),e=Math.tan(this.areaAxis[0]*(Math.PI/180)),a=[Math.tan(a),0,e],d=d-Math.atan2(a[0],a[2]);this.position=b.add(b.add(this.areaCam.position,c),b.multiply(a,f));this.position[1]=this.areaCeiling;this.target=b.add(b.add(this.areaCam.position,c),b.multiply(a,-f));this.target[1]=this.areaFloor;this.direction=b.normalize(b.subtract(this.target,this.position));this.dummyCam.rotation[2]=d*(180/
Math.PI);b=this.dummyCam.farclip*Math.abs(this.direction[1])*f;f=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);f[0][1]<this.areaCeiling&&Math.abs(this.direction[1]);f=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);f[1][1]>this.areaFloor&&(f=f[1][1]-this.areaFloor,b+=f/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=
b;this.dummyCam.setOrtho(-this.distance/2,this.distance/2,-this.distance/2,this.distance/2)},orthoBounds:function(b,f,a,c,d,e){var c=h.vec3,g=c.normalize([d[0],d[4],d[8]]),n=c.normalize([d[1],d[5],d[9]]),d=c.normalize(c.cross(n,g)),o;o=a/2;a=[];f=c.multiply(g,f/2);g=c.multiply(n,o);e=c.multiply(d,e);a[0]=c.add(c.subtract(b,f),c.add(g,e));a[1]=c.add(c.add(b,f),c.add(g,e));a[2]=c.subtract(c.subtract(b,f),c.add(g,e));a[3]=c.subtract(c.add(b,f),c.add(g,e));aabb1=a[0];aabb2=a[0];for(b=1;4>b;b++)aabb1[0]>
a[b][0]&&(aabb1[0]=a[b][0]),aabb1[1]>a[b][1]&&(aabb1[1]=a[b][1]),aabb1[2]>a[b][2]&&(aabb1[2]=a[b][2]),aabb2[0]<a[b][0]&&(aabb2[0]=a[b][0]),aabb2[1]<a[b][1]&&(aabb2[1]=a[b][1]),aabb2[2]<a[b][2]&&(aabb2[2]=a[b][2]);return[aabb1,aabb2]}};return{Light:x}});
CubicVR.RegisterModule("Camera",function(h){function x(a,c,d,e,g){var b=h.mat4;this.frustum=new h.Frustum;"object"==typeof a?(this.position=a.position||[0,0,-1],this.rotation=a.rotation||[0,0,0],this.target=a.target||[0,0,0],this.fov=a.fov||60,this.nearclip=a.nearclip||a.nearClip||a.near||0.1,this.farclip=a.farclip||a.farClip||a.far||400,this.targeted=a.targeted!==q?a.targeted:!0,this.calc_nmatrix=a.calcNormalMatrix!==q?a.calcNormalMatrix:!0,this.name=a.name||"camera"+f,c=a.height?a.height:q,a=a.width?
a.width:q):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=d!==q?d:60,this.nearclip=e!==q?e:0.1,this.farclip=g!==q?g:400,this.calc_nmatrix=this.targeted=!0,this.name="camera"+f);this.motion=this.targetSceneObject=null;this.transform=new h.Transform;this.manual=!1;this.setDimensions(a!==q?a:512,c!==q?c:512);this.mvMatrix=b.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1};this.parent=null;++f}function t(a){this.position=
a!==q?a:[0,0,0]}function m(a,c,d){this.camPath=new h.Motion;this.targetPath=new h.Motion;this.start_position=a!==q?a:[8,8,8];this.target=c!==q?c:[0,0,0];this.bounds=d!==q?d:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var q=h.undef,r=h.enums,b=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],f=0;x.prototype={get x(){return this.position[0]},
set x(a){this.position[0]=a},get y(){return this.position[1]},set y(a){this.position[1]=a},get z(){return this.position[2]},set z(a){this.position[2]=a},get rotX(){return this.rotation[0]},set rotX(a){this.rotation[0]=a},get rotY(){return this.rotation[1]},set rotY(a){this.rotation[1]=a},get rotZ(){return this.rotation[2]},set rotZ(a){this.rotation[2]=a},get targetX(){return this.target[0]},set targetX(a){this.target[0]=a},get targetY(){return this.target[1]},set targetY(a){this.target[1]=a},get targetZ(){return this.target[2]},
set targetZ(a){this.target[2]=a},get pos(){return this.position.slice(0)},set pos(a){this.position=a.slice(0)},get rot(){return this.rotation.slice(0)},set rot(a){this.rotation=a.slice(0)},trackTarget:function(a,c,d){this.position=h.vec3.trackTarget(this.position,a,c,d)},setParent:function(a){this.parent=a},hasParent:function(){return!!this.parent},getParent:function(){return this.parent},getParentedPosition:function(){return null!==this.parent&&this.mvMatrix&&this.parent.tMatrix?h.mat4.vec3_multiply(this.position,
this.parent.tMatrix):this.position},setOrtho:function(a,c,d,e){this.ortho=!0;this.ortho_view.left=a;this.ortho_view.right=c;this.ortho_view.bottom=d;this.ortho_view.top=e},control:function(a,c,d){a===r.motion.ROT?this.rotation[c]=d:a===r.motion.POS?this.position[c]=d:a===r.motion.FOV?this.setFOV(d):a===r.motion.LENS?this.setLENS(d):a===r.motion.NEARCLIP?this.setClip(d,this.farclip):a===r.motion.FARCLIP&&this.setClip(this.nearclip,d)},makeFrustum:function(a,c,d,e,g,b){return[2*g/(c-a),0,0,0,0,2*g/
(e-d),0,0,(c+a)/(c-a),(e+d)/(e-d),-(b+g)/(b-g),-1,0,0,-2*b*g/(b-g),0]},setTargeted:function(a){this.targeted=a},calcProjection:function(){var a=h.mat4,c=h.mat3;this.pMatrix=this.ortho?a.ortho(this.ortho_view.left,this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):a.perspective(this.fov,this.aspect,this.nearclip,this.farclip);!this.targeted&&this.mvMatrix&&(a.identity(this.mvMatrix),a.rotate(-this.rotation[0],-this.rotation[1],-this.rotation[2],this.mvMatrix),
a.translate(-this.position[0],-this.position[1],-this.position[2],this.mvMatrix),this.parent&&a.multiply(this.mvMatrix.slice(0),a.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=a.inverse_mat3(this.mvMatrix),c.transpose_inline(this.nMatrix)):a.identity(this.nMatrix));this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(a,c){this.nearclip=a;this.farclip=c;this.calcProjection()},setDimensions:function(a,c){this.width=a;this.height=c;this.aspect=a/c;this.calcProjection()},
resize:function(a,c){this.setDimensions(a,c)},setFOV:function(a){this.fov=a;this.ortho=!1;this.calcProjection()},setLENS:function(a){this.setFOV(2*Math.atan(16/a)*(180/Math.PI))},lookat:function(a,c,d,e,g,f,o,s,m){var w=h.mat4,v=h.mat3;"object"==typeof a?this.lookat(this.position[0],this.position[1],this.position[2],a[0],a[1],a[2],0,1,0):(this.mvMatrix=w.lookat(a,c,d,e,g,f,o,s,m),this.rotation[2]&&(this.transform.clearStack(),this.transform.rotate(-this.rotation[2],0,0,1),this.transform.pushMatrix(this.mvMatrix),
this.mvMatrix=this.transform.getResult()),null!==this.parent&&w.multiply(this.mvMatrix.slice(0),w.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=w.inverse_mat3(this.mvMatrix),v.transpose_inline(this.nMatrix)):this.nMatrix=b,this.frustum.extract(this,this.mvMatrix,this.pMatrix))},unProject:function(a,c,d){var e=h.mat4,g=h.vec3,b=[0,0,this.width,this.height],a=e.vec4_multiply(e.vec4_multiply([2*((a-b[0])/b[2])-1,-(2*((c-b[1])/b[3])-1),1,1],e.inverse(this.pMatrix)),e.inverse(this.mvMatrix)),
a=[a[0]/a[3],a[1]/a[3],a[2]/a[3]];return d!==q?(c=this.getParentedPosition(),g.add(c,g.multiply(g.normalize(g.subtract(a,c)),d))):a},project:function(a,c,d){var e=h.mat4,e=e.vec4_multiply(e.vec4_multiply([a,c,d,1],this.mvMatrix),this.pMatrix);e[2]=h.vec3.length(h.vec3.subtract([a,c,d],this.position));return[(e[0]/e[3]+1)/2*this.width,(-e[1]/e[3]+1)/2*this.height,e[2]]}};t.prototype={control:function(a,c,d){a===r.motion.POS&&(this.position[c]=d)}};m.prototype={inBounds:function(a){var c=h.vec3;if(!(a[0]>
this.bounds[0][0]&&a[1]>this.bounds[0][1]&&a[2]>this.bounds[0][2]&&a[0]<this.bounds[1][0]&&a[1]<this.bounds[1][1]&&a[2]<this.bounds[1][2]))return!1;for(var d=0,e=this.avoid_sphere.length;d<e;d++)if(c.length(a,this.avoid_sphere[d][0])<this.avoid_sphere[d][1])return!1;return!0},findNextNode:function(a,c){var d=h.vec3,e=[0,0,0],g=[0,0,0],b=e=0,o=!1;do if(g[0]=Math.random()-0.5,g[1]=Math.random()-0.5,g[2]=Math.random()-0.5,g=d.normalize(g),e=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,
e=d.add(c.position,d.multiply(g,e)),o=this.inBounds(e),b++,30<b){e=c.position;break}while(!o);return e},run:function(a){this.current_time=a;0===this.path_time&&(this.path_time=this.current_time,this.camPath.setKey(r.motion.POS,r.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(r.motion.POS,r.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(r.motion.POS,r.motion.Z,this.path_time,this.start_position[2]));for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=
this.segment_time;var c=new t,d=new t;this.path_length&&this.camPath.apply(this.path_time-2*this.segment_time,c);this.camPath.apply(this.path_time-this.segment_time,d);c=this.findNextNode(c,d);this.camPath.setKey(r.motion.POS,r.motion.X,this.path_time,c[0]);this.camPath.setKey(r.motion.POS,r.motion.Y,this.path_time,c[1]);this.camPath.setKey(r.motion.POS,r.motion.Z,this.path_time,c[2]);this.path_length++}c=new t;this.camPath.apply(a,c);return c.position},addSafeBound:function(a,c){this.safe_bb.push([a,
c])},addAvoidSphere:function(a,c){this.avoid_sphere.push([a,c])}};return{Camera:x,AutoCamera:m}});
CubicVR.RegisterModule("Motion",function(h){function x(){this.time=this.value=0;this.shape=r.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function t(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=CubicVR.parseEnum(r.envelope.behavior,a.in_behavior||a.inBehavior||a.behavior)||r.envelope.behavior.CONSTANT,this.out_behavior=CubicVR.parseEnum(r.envelope.behavior,a.out_behavior||a.outBehavior||a.behavior)||r.envelope.behavior.CONSTANT):
this.out_behavior=this.in_behavior=r.envelope.behavior.CONSTANT}function m(a,c){this.controllers=[];this.yzflip=!1;if("object"===typeof a){var d=CubicVR.get(a);this.env_init=CubicVR.get(d.envelope);this.key_init=CubicVR.get(d.key);for(var b in d)if(d.hasOwnProperty(b)&&!("envelope"===b||"key"===b)){var f=d[b],m=CubicVR.get(f.envelope),h;for(h in f)if(f.hasOwnProperty(h)&&!("envelope"===h||"key"===h)){var v=f[h];if("object"===typeof v)for(var q in v)this.setKey(b,q,h,v[q]),m&&this.setBehavior(b,q,
m)}}}else this.env_init=a,this.key_init=c}var q=h.undef,r=CubicVR.enums;r.motion={POS:0,ROT:1,SCL:2,POSITION:0,ROTATION:1,SCALE:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};r.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var b=function(a,c,d){var b=0,b=d-c;if(0===b)return[c,0];c=a-b*Math.floor((a-c)/b);b=-parseInt((c-a)/b+(c>a?0.5:-0.5),10);return[c,b]},f=function(a,c,d,b,f){var m,h;h=f*f;m=3*(c-
a);c=3*(d-c)-m;return(b-a-m-c)*h*f+c*h+m*f+a},a=function(c,g,d,b,s,m,h){var v,q;q=m+0.5*(h-m);v=f(c,g,d,b,q);return 1.0E-4<Math.abs(s-v)?(v>s?h=q:m=q,a(c,g,d,b,s,m,h)):q},c=function(a,c){var d,b,f,m;a.shape===r.envelope.shape.TCB?(d=(1-a.tension)*(1+a.continuity)*(1+a.bias),b=(1-a.tension)*(1-a.continuity)*(1-a.bias),f=c.value-a.value,a.prev?(m=(c.time-a.time)/(c.time-a.prev.time),d=m*(d*(a.value-a.prev.value)+b*f)):d=b*f):a.shape===r.envelope.shape.LINE?(f=c.value-a.value,a.prev?(m=(c.time-a.time)/
(c.time-a.prev.time),d=m*(a.value-a.prev.value+f)):d=f):a.shape===r.envelope.shape.BEZI||a.shape===r.envelope.shape.HERM?(d=a.param[1],a.prev&&(d*=(c.time-a.time)/(c.time-a.prev.time))):a.shape===r.envelope.shape.BEZ2?(d=a.param[3]*(c.time-a.time),d=1.0E-5<Math.abs(a.param[2])?d/a.param[2]:1E5*d):d=0;return d},d=function(a,c){var d,b,f,m;c.shape===r.envelope.shape.LINE?(f=c.value-a.value,c.next?(m=(c.time-a.time)/(c.next.time-a.time),d=m*(c.next.value-c.value+f)):d=f):c.shape===r.envelope.shape.TCB?
(d=(1-c.tension)*(1-c.continuity)*(1+c.bias),b=(1-c.tension)*(1+c.continuity)*(1-c.bias),f=c.value-a.value,c.next?(m=(c.time-a.time)/(c.next.time-a.time),d=m*(b*(c.next.value-c.value)+d*f)):d*=f):c.shape===r.envelope.shape.HERM||c.shape===r.envelope.shape.BEZI?(d=c.param[0],c.next&&(d*=(c.time-a.time)/(c.next.time-a.time))):c.shape===r.envelope.shape.BEZ2?(d=c.param[1]*(c.time-a.time),d=1.0E-5<Math.abs(c.param[0])?d/c.param[0]:1E5*d):d=0;return d};t.prototype={setBehavior:function(a,c){this.in_behavior=
CubicVR.parseEnum(r.envelope.behavior,a);this.out_behavior=CubicVR.parseEnum(r.envelope.behavior,c)},empty:function(){return 0===this.nKeys},addKey:function(a,c,d){var b="object"==typeof a?a:d;c||(c=0);a||(a=0);b?(b=a,a=b.time,d=this.insertKey(a),d.value=b.value?b.value:c,d.time=b.time?b.time:a,d.shape=CubicVR.parseEnum(r.envelope.shape,b.shape)||r.envelope.shape.TCB,d.tension=b.tension?b.tension:0,d.continuity=b.continuity?b.continuity:0,d.bias=b.bias?b.bias:0,d.param=b.param?b.param:[0,0,0,0]):
(d=this.insertKey(a),d.value=c);return d},insertKey:function(a){var c=new x;c.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=this.keys=c,this.nKeys++,c;for(var d=this.keys;d;){this.firstKey.time>a?this.firstKey=c:this.lastKey.time<a&&(this.lastKey=c);if(d.time>c.time)return c.prev=d.prev,c.prev&&(c.prev.next=c),c.next=d,c.next.prev=c,this.nKeys++,c;if(!d.next)return c.prev=d,d.next=c,this.nKeys++,c;d=d.next}return null},evaluate:function(e){var g,n,o,s,m,h=0;if(0===this.nKeys)return 0;if(1===
this.nKeys)return this.keys.value;n=this.firstKey;g=this.lastKey;if(e<n.time){s=this.in_behavior;if(s===r.envelope.behavior.RESET)return 0;if(s===r.envelope.behavior.CONSTANT)return n.value;if(s===r.envelope.behavior.REPEAT)s=b(e,n.time,g.time),e=s[0];else if(s===r.envelope.behavior.OCILLATE)s=b(e,n.time,g.time),e=s[0],s=s[1],s%2&&(e=g.time-n.time-e);else if(s===r.envelope.behavior.OFFSET)s=b(e,n.time,g.time),e=s[0],s=s[1],h=s*(g.value-n.value);else if(s===r.envelope.behavior.LINEAR)return m=c(n,
n.next)/(n.next.time-n.time),m*(e-n.time)+n.value}else if(e>g.time){s=this.out_behavior;if(s===r.envelope.behavior.RESET)return 0;if(s===r.envelope.behavior.CONSTANT)return g.value;if(s===r.envelope.behavior.REPEAT)s=b(e,n.time,g.time),e=s[0];else if(s===r.envelope.behavior.OCILLATE)s=b(e,n.time,g.time),e=s[0],s=s[1],s%2&&(e=g.time-n.time-e);else if(s===r.envelope.behavior.OFFSET)s=b(e,n.time,g.time),e=s[0],s=s[1],h=s*(g.value-n.value);else if(s===r.envelope.behavior.LINEAR)return s=d(g.prev,g)/(g.time-
g.prev.time),s*(e-g.time)+g.value}if(this.lastKey0)if(e>this.lastKey0.time)g=this.lastKey0;else if(e<this.lastKey0.time)for(g=this.lastKey;e<g.time&&g.prev;)g=g.prev;else g=this.keys;else g=this.keys;for(;e>g.next.time;)g=g.next;n=g.next;this.lastKey0=g;if(e===g.time)return g.value+h;if(e===n.time)return n.value+h;o=(e-g.time)/(n.time-g.time);s=n.shape;if(s===r.envelope.shape.TCB||s===r.envelope.shape.BEZI||s===r.envelope.shape.HERM){m=c(g,n);s=d(g,n);var v,q;q=o*o;v=o*q;e=3*q-v-v;v-=q;e=[1-e,e,v-
q+o,v];return e[0]*g.value+e[1]*n.value+e[2]*m+e[3]*s+h}return s===r.envelope.shape.BEZ2?(e=a(g.time,g.shape===r.envelope.shape.BEZ2?g.time+g.param[2]:g.time+(n.time-g.time)/3,n.time+n.param[0],n.time,e,0,1),f(g.value,g.shape===r.envelope.shape.BEZ2?g.value+g.param[3]:g.value+g.param[1]/3,n.param[1]+n.value,n.value,e)+h):s===r.envelope.shape.LINE?g.value+o*(n.value-g.value)+h:s===r.envelope.shape.STEP?g.value+h:h}};m.prototype={clone:function(){var a=new h.Motion(this.env_init,this.key_init),c;for(c in this.controllers)if(this.controllers.hasOwnProperty(c)){a.controllers[c]===
q&&(a.controllers[c]=[]);for(var d in this.controllers[c])if(this.controllers[c].hasOwnProperty(d)){var b=this.controllers[c][d],f=a.controllers[c][d]=new t({in_behavior:b.in_behavior,out_behavior:b.out_behavior});f.nKeys=b.nKeys;f.keys=b.keys;f.firstKey=b.firstKey;f.lastKey=b.lastKey}}return a},envelope:function(a,c){c=CubicVR.parseEnum(r.motion,c)||0;a=CubicVR.parseEnum(r.motion,a)||0;this.controllers[a]===q&&(this.controllers[a]=[]);this.controllers[a][c]===q&&(this.controllers[a][c]=new t(this.env_init));
return this.controllers[a][c]},evaluate:function(a){var c=[],d;for(d in this.controllers)if(this.controllers.hasOwnProperty(d)){c[d]=[];for(var b in this.controllers[d])this.controllers[d].hasOwnProperty(b)&&(c[d][b]=this.controllers[d][b].evaluate(a))}return c},apply:function(a,c){for(var d in this.controllers)if(this.controllers.hasOwnProperty(d)){var b=parseInt(d,10);if(this.yzflip&&b===r.motion.ROT){this.q||(this.q=new CubicVR.Quaternion);var f=this.q,m=this.controllers[d][0].evaluate(a),h=this.controllers[d][1].evaluate(a),
v=this.controllers[d][2].evaluate(a);f.fromEuler(m,v,-h);f=f.toEuler();c.control(b,0,f[0]);c.control(b,1,f[1]);c.control(b,2,f[2])}else for(var q in this.controllers[d])this.controllers[d].hasOwnProperty(q)&&c.control(b,parseInt(q,10),this.controllers[d][q].evaluate(a))}},setKey:function(a,c,d,b,f){c=CubicVR.parseEnum(r.motion,c)||0;a=CubicVR.parseEnum(r.motion,a)||0;return this.envelope(a,c).addKey(d,b,f?f:this.key_init)},setArray:function(a,c,d,b){var f=[],a=CubicVR.parseEnum(r.motion,a)||0,m;for(m in d)if(d.hasOwnProperty(m)){var h=
this.envelope(a,CubicVR.parseEnum(r.motion,m));f[m]=h.addKey(c,d[m],b?b:this.key_init)}return f},setBehavior:function(a,c,d,b){var f=this.envelope(a,c);"object"===typeof d&&(b=d,d=b.in_behavior||b.inBehavior||b.behavior,b=b.out_behavior||b.outBehavior||b.behavior);CubicVR.parseEnum(r.motion,c);CubicVR.parseEnum(r.motion,a);f.setBehavior(d,b)},setBehaviorArray:function(a,c,d){var a=CubicVR.parseEnum(r.motion,a)||0,b=this.controllers[a],f;for(f in b)b.hasOwnProperty(f)&&this.envelope(a,CubicVR.parseEnum(r.motion,
f)||0).setBehavior(c,d)}};return{Motion:m,Envelope:t,EnvelopeKey:x}});
CubicVR.RegisterModule("EventHandler",function(h){function x(f){f=CubicVR.parseEnum(r.event,f);return f===q?(b("For custom events use CubicVR.registerEvent('event_name'); and use the resulting CubicVR.enums.event.EVENT_NAME for type checks and 'event_name' for construction."),!1):!isNaN(parseInt(f,10))&&(f>=r.event.EVENT_MAX||0>f)?(b("Unknown event ID passed: "+f),!1):f}function t(b){b=b||{};this.name=b.name;b.id=x(b.id)||r.event.TICK;this.id=b.id;this.interval=b.interval||0;this.enabled=b.enabled||
!0;this.action=b.action||null;this.properties=b.properties||{};this.event_properties=b.event_properties||{};this.buffered=b.buffered||!1;this.weight=b.weight===q?-1:b.weight;this.subject=null;this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0;this.break_chain=!1}function m(){this.events=[];this.eventProperties=[];this.eventPropertyCount=[];this.eventHandled=[];this.listeners=[];this.listenerNames=[];this.eventParameters=[]}var q=h.undef,
r=CubicVR.enums,b=h.log;r.event={TICK:0,MOVE:1,MATRIX_UPDATE:2,OCTREE_ADJUST:3,COLLIDE:4,CONTACT:5,CONTACT_ADD:6,CONTACT_REMOVE:7,CONTACT_GHOST:8,RIGID_REST:9,RIGID_AWAKE:10,ENUM_MAX:11};t.prototype={getName:function(){return this.name},setName:function(b){this.name=b},getSubject:function(){return this.subject},setSubject:function(b){this.subject=b},getId:function(){return this.id},setId:function(b){this.id=b},isEnabled:function(){return this.enabled},disable:function(){this.setEnabled(!1)},enable:function(){this.setEnabled(!0)},
setEnabled:function(b){b&&!this.enabled&&(this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0,this.break_chain=!1);this.enabled=b},isBuffered:function(){return this.buffered},setBuffered:function(b){this.buffered=b},setInterval:function(b){this.interval=b},getInterval:function(){return this.interval},setAction:function(b){this.action=b},getAction:function(){return this.action},getProperties:function(){return this.properties},setProperties:function(b){this.properties=
b},getProperty:function(b){return this.properties[b]},setProperty:function(b,a){this.properties[b]=a},setEventProperties:function(b){this.event_properties=b},getEventProperties:function(){return this.event_properties},getEventProperty:function(b){return this.event_properties[b]},setEventProperty:function(b,a){this.properties[b]=a},getTimeSleeping:function(){return this.t_sleep},getTimeActive:function(){return this.t_active},getTimeUpdated:function(){return this.t_update},getSeconds:function(){return this.getTimeUpdated()},
getRestInterval:function(){return this.t_rest},getLastUpdateSeconds:function(){return this.t_last},setRestInterval:function(b){this.t_rest=b},getUpdateCount:function(){return this.n_updates},breakChain:function(){this.break_chain=!0},isChainBroken:function(){return this.break_chain},rest:function(b){this.setRestInterval(b||0)},awake:function(){this.t_rest=0},update:function(b,a){if(!this.enabled)return!1;var c=0,d=!0;0===this.n_updates?(this.t_updatecall=this.t_update=b,c=1/60):b!==this.t_update?
(this.t_rest||(this.t_last=b-this.t_update,this.t_update=b),c=b-this.t_updatecall,this.t_updatecall=b):d=!1;if(0<this.t_rest)d&&(this.t_resting+=c,this.t_rest-=c,0>this.t_rest&&(this.t_rest=0));else return d&&(this.t_active+=this.t_last,!this.t_rest&&this.interval&&(this.t_rest=this.interval),this.n_updates++),this.callEvent(a),!0;d&&this.n_updates++;return!1},callEvent:function(b){return!this.action?!1:this.action(this,b)}};m.prototype={addEvent:function(b){b.callEvent||(b=new t(b));var a=b.getId();
this.eventProperties[a]||(this.eventProperties[a]={});this.listeners[a]=this.listeners[a]||0;this.listeners[a]++;this.events.push(b);-1===this.listenerNames.indexOf(a)&&this.listenerNames.push(a);return b},removeEvent:function(b){if(this.lockState)this.lockRemovals||(this.lockRemovals=[]),-1==this.lockRemovals.indexOf(b)&&this.lockRemovals.push(b);else{var a=this.events.indexOf(b);-1!==a&&(b=b.getId(),this.events.splice(a,1),this.listeners[b]--,this.listeners[b]||(this.eventHandled[b]=!0,this.eventParameters[b]=
{},this.eventProperties[b]=[],this.eventPropertyCount[b]=0,a=this.listenerNames.indexOf(b),0<=a&&this.listenerNames.splice(a,1)))}},getProperties:function(b){this.eventParameters[b]=this.eventParameters[b]||{};return this.eventParameters[b]},setProperties:function(b,a){this.eventParameters[b]=a},getProperty:function(b,a){return this.getProperties(b)[a]},setProperty:function(b,a,c){this.getProperties(b)[a]=c},hasEvent:function(b){return!!this.listeners[b]},triggerEvent:function(b,a){if(!this.listeners[b])return null;
this.eventProperties[b]==q&&(this.eventProperties[b]=[]);var c=this.eventProperties[b];this.eventPropertyCount[b]===q&&(this.eventPropertyCount[b]=0);var d=this.eventPropertyCount[b];20<d&&console.log("Warning, event "+b+" count > 20: "+d);c[d]=a&&c?a:c[d]||{};this.eventPropertyCount[b]++;this.eventHandled[b]=!1;return c[d]},update:function(b){var a,c,d,e,g,n;if(this.hasEvent(r.event.TICK)&&0===this.eventPropertyCount[r.event.TICK]&&(a=this.triggerEvent(r.event.TICK)))a.time=b,a.handler=this;this.lockState=
!0;a=0;for(c=this.events.length;a<c;a++){g=this.events[a];n=g.getId();e=this.eventPropertyCount[n];var o=!1;d=!1;if(e){var s=this.eventProperties[n];if(g.isEnabled()){if(g.isBuffered()){if(s.length=e,g.setEventProperties(s),o=o||g.update(b,this),g.isChainBroken()){g.breakChain(!1);break}}else for(d=0;d<e;d++)if(g.setEventProperties(s[a]),o=o||g.update(b,this),g.isChainBroken()){g.breakChain(!1);break}d=!0}}if(o||!d)this.eventHandled[n]=!0}a=0;for(c=this.listenerNames.length;a<c;a++)n=this.listenerNames[a],
this.eventHandled[n]&&(this.eventPropertyCount[n]=0);this.lockState=!1;if(this.lockRemovals&&this.lockRemovals.length){a=0;for(c=this.lockRemovals.length;a<c;a++)this.removeEvent(this.lockRemovals[a]);this.lockRemovals.length=0}}};return{Event:t,EventHandler:m,registerEvent:function(f){f=f.toUpperCase();r.event[f]!==q?b("Error, event '"+f+"' is already registered."):(r.event[f]=r.event.ENUM_MAX,r.event.ENUM_MAX++)},validateEvent:x}});
CubicVR.RegisterModule("Scene",function(h){function x(a,c){return a.light_type-c.light_type}function t(g,d){var b=null,e;g!==r&&null!==g?g.compile?b={}:(b=h.get(g)||{},g=null):b={};this.morphWeight=b.morphWeight||0;this.morphSource=b.morphSource||-1;this.morphTarget=b.morphTarget||-1;this.position=b.position===r?[0,0,0]:b.position;this.rotation=b.rotation===r?[0,0,0]:b.rotation;this.scale=b.scale===r?[1,1,1]:b.scale;this.shadowCast=b.shadowCast===r?!0:b.shadowCast;this.wireframe=b.wireframe||!1;this.motion=
b.motion===r?null:h.get(b.motion,h.Motion)||null;this.obj=!b.mesh?g?h.get(g,h.Mesh):null:h.get(b.mesh,h.Mesh);this.name=b.name===r?d!==r?d:null:b.name;this.properties=h.get(b.properties)||{};this.parent=this.children=null;var f=b.children||b.child||b.sceneObject||b.sceneObjects;if(f){if(f&&!f.length||"string"===typeof f)f=[f];if(f.length){b=0;for(e=f.length;b<e;b++)this.bindChild(h.get(f[b],h.SceneObject))}}this.drawn_this_frame=!1;this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];
this.lMatrix=c.identity();this.tMatrix=c.identity();this.dirty=!0;this.aabb=[];this.id=-1;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];a.reset(this.octree_aabb,[0,0,0]);this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.dynamic_lights=[];this.static_lights=[];this.matrixLock=!1;this.eventHandler=this.instanceMaterials=null;this.duplicateCount=0;this.independentMotion=!1}function m(a,c,d,b,f,m){this.frames=0;this.sceneObjects=[];this.sceneObjectsByName=
[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.stats=[];this.cameras=[];this.camerasByName=[];this.shadows_updated=this.collect_stats=!1;if("object"===typeof a||"string"===typeof a){a=h.get(a);this.octree=a.octree;this.skybox=a.skybox||null;this.name=a.name||"scene"+e;this.wireframe=a.wireframe||!1;this.destroy=a.destroy||function(){};this.update=a.update||function(){};this.enable=a.enable||function(){};this.disable=a.disable||function(){};
c=a.setup&&a.setup(this)||{};this.update=c.update||this.update;this.enable=c.enable||this.enable;this.disable=c.disable||this.disable;this.destroy=c.destroy||this.destroy;if((b=a.sceneObjects||a.sceneObject||a.objects)&&!b.length||"string"===typeof b)b=[b];if(b&&b.length){c=0;for(d=b.length;c<d;c++)this.bindSceneObject(h.get(b[c],h.SceneObject))}if((b=a.lights||a.light)&&!b.length||"string"===typeof b)b=[b];if(b&&b.length){c=0;for(d=b.length;c<d;c++)this.bindLight(h.get(b[c],h.Light))}if((b=a.cameras||
a.camera)&&!b.length||"string"===typeof b)b=[b];if(b&&b.length){c=0;for(d=b.length;c<d;c++)this.bindCamera(h.get(b[c],h.Camera));this.camera=this.cameras[0]}b||(this.camera=new h.Camera(a.width,a.height,a.fov,a.nearclip,a.farclip))}else this.skybox=null,this.octree=m,this.name="scene"+e,this.camera=new h.Camera(a,c,d,b,f),this.wireframe=!1;this.paused=!1;++e}function q(){this.meshBin={};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr={};this.meshBinPtr={}}var r=h.undef,b=h.enums,
f=h.GLCore,a=h.aabb,c=h.mat4,d=0;t.prototype={get x(){return this.position[0]},set x(a){this.position[0]=a},get y(){return this.position[1]},set y(a){this.position[1]=a},get z(){return this.position[2]},set z(a){this.position[2]=a},get rotX(){return this.rotation[0]},set rotX(a){this.rotation[0]=a},get rotY(){return this.rotation[1]},set rotY(a){this.rotation[1]=a},get rotZ(){return this.rotation[2]},set rotZ(a){this.rotation[2]=a},get pos(){return this.position.slice(0)},set pos(a){this.position=
a.slice(0)},get rot(){return this.rotation.slice(0)},set rot(a){this.rotation=a.slice(0)},get sclX(){return this.scale[0]},set sclX(a){this.scale[0]=a},get sclY(){return this.scale[1]},set sclY(a){this.scale[1]=a},get sclZ(){return this.scale[2]},set sclZ(a){this.scale[2]=a},get scl(){return this.scale.slice(0)},set scl(a){this.scale=a.slice(0)},clone:function(){var a,c;a=this.name?this.name+"_"+this.duplicateCount:null;this.duplicateCount++;var d=new h.SceneObject({name:a,mesh:this.obj,position:this.position.slice(0),
rotation:this.rotation.slice(0),scale:this.scale.slice(0),morphWeight:this.morphWeight,morphSource:this.morphSource,morphTarget:this.morphTarget,shadowCast:this.shadowCast,wireframe:this.wireframe,motion:this.motion?this.motion.clone():null});if(null!==this.instanceMaterials){d.instanceMaterials=[];a=0;for(c=this.instanceMaterials.length;a<c;a++)d.instanceMaterials[a]=this.instanceMaterials[a].clone()}if(null!==this.children){a=0;for(c=this.children.length;a<c;a++)d.bindChild(this.children[a].clone())}return d},
evaluate:function(a){var c,d;this.independentMotion=!0;this.motion&&this.motion.apply(a,this);if(null!==this.children){c=0;for(d=this.children.length;c<d;c++)this.children[c].evaluate(a)}},isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},addEvent:function(a){this.eventHandler||(this.eventHandler=new h.EventHandler);a=this.eventHandler.addEvent(a);a.setSubject(this);return a},removeEvent:function(a){this.eventHandler&&this.eventHandler.removeEvent(a)},hasEvents:function(){return!!this.eventHandler},
getEventHandler:function(){return this.eventHandler},setMesh:function(a){this.obj=a},getMesh:function(){return this.obj},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},getProperty:function(a){return this.properties[a]},setProperty:function(a,c){this.properties[a]=c},getInstanceMaterials:function(){if(!this.obj)return null;if(this.instanceMaterials)return this.instanceMaterials;this.instanceMaterials=[];for(var a=0,c=this.obj.materials.length;a<c;a++)this.instanceMaterials[a]=
this.obj.materials[a].clone();return this.instanceMaterials},getInstanceMaterial:function(a){for(var c=this.getInstanceMaterials(),d=0,b=c.length;d<b;d++)if(c[d].name==a)return c[d];return null},setMorphSource:function(a){this.morphSource=a},setMorphTarget:function(a){this.morphTarget=a},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(a){this.morphWeight=a},morphTargetCount:function(){return null!==this.obj.morphTargets?
this.obj.morphTargets.length:0},setMatrixLock:function(a){this.matrixLock=a},getMatrixLock:function(){return this.matrixLock},setMatrix:function(a){a?(this.tMatrix=a.slice(0),this.matrixLock=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(b.event.MATRIX_UPDATE)&&(a.triggerEvent(b.event.MATRIX_UPDATE).matrix=this.tMatrix))):this.matrixLock=!1},doTransform:function(a){var d=h.vec3;if(!this.matrixLock&&(!d.equal(this.lposition,this.position)||!d.equal(this.lrotation,this.rotation)||!d.equal(this.lscale,
this.scale)||a!==r))a!==r?this.tMatrix=a.slice(0):c.identity(this.tMatrix),c.identity(this.lMatrix),c.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),c.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]||c.scale(this.scale[0],this.scale[1],this.scale[2],this.lMatrix),c.multiply(this.tMatrix.slice(0),this.lMatrix,this.tMatrix),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],
this.lposition[2]=this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(b.event.MOVE)&&(a=a.triggerEvent(b.event.MOVE),a.oldPosition=this.lposition,a.position=this.position,a.oldRotation=this.lrotation,a.rotation=this.rotation,a.oldScale=this.lscale,a.scale=this.scale))},adjust_octree:function(){var c=
this.getAABB(),d=this.octree_aabb,b=c[0][0],e=c[0][1],f=c[0][2],m=c[1][0],v=c[1][1],h=c[1][2],q=d[0][0],t=d[0][1],G=d[0][2],u=d[1][0],y=d[1][1],d=d[1][2];if(0<this.octree_leaves.length&&(b<q||e<t||f<G||m>u||v>y||h>d)){for(b=0;b<this.octree_leaves.length;++b)this.octree_leaves[b].remove(this);this.octree_leaves=[];this.static_lights=[];b=this.octree_common_root;this.octree_common_root=null;if(null!==b){for(;;)if(!b.contains_point(c[0])||!b.contains_point(c[1]))if(b._root!==r&&null!==b._root)b=b._root;
else break;else break;a.reset(this.octree_aabb,this.position);b.insert(this)}}},bindChild:function(a){null===this.children&&(this.children=[]);a.parent=this;this.children.push(a)},control:function(a,c,d){a===b.motion.POS?this.position[c]=d:a===b.motion.SCL?this.scale[c]=d:a===b.motion.ROT&&(this.rotation[c]=d)},getAABB:function(){var a=h.mat4,c=h.vec3;if(this.dirty){var d=Array(8);this.doTransform();var b,e;if(this.obj){if(!this.obj.bb)return this.aabb=[c.add([-1,-1,-1],this.position),c.add([1,1,
1],this.position)];b=this.obj.bb[0];e=this.obj.bb[1]}if(!this.obj||b===r||e===r)return this.aabb=[c.add([-1,-1,-1],this.position),c.add([1,1,1],this.position)];var f=b;b=c.subtract(e,b);d[0]=[f[0],f[1],f[2]];d[1]=[f[0],f[1],f[2]+b[2]];d[2]=[f[0]+b[0],f[1],f[2]];d[3]=[f[0]+b[0],f[1],f[2]+b[2]];d[4]=[f[0],f[1]+b[1],f[2]];d[5]=[f[0],f[1]+b[1],f[2]+b[2]];d[6]=[f[0]+b[0],f[1]+b[1],f[2]];d[7]=[f[0]+b[0],f[1]+b[1],f[2]+b[2]];f=a.vec3_multiply(d[0],this.tMatrix);b=[f[0],f[1],f[2]];e=[f[0],f[1],f[2]];for(c=
1;8>c;++c)f=a.vec3_multiply(d[c],this.tMatrix),b[0]>f[0]&&(b[0]=f[0]),b[1]>f[1]&&(b[1]=f[1]),b[2]>f[2]&&(b[2]=f[2]),e[0]<f[0]&&(e[0]=f[0]),e[1]<f[1]&&(e[1]=f[1]),e[2]<f[2]&&(e[2]=f[2]);this.aabb[0]=b;this.aabb[1]=e;this.dirty=!1}return this.aabb}};var e=0;m.prototype={isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},attachOctree:function(c){this.octree=c;c.init&&c.init(this);c=this.lights;this.lights=[];for(var b=0,e=c.length;b<e;b++)this.bindLight(c[b]);c=
this.sceneObjects;if(this.octree!==r){b=0;for(e=c.length;b<e;++b){var f=c[b];null!==f.obj&&(0>f.id&&(f.id=d,++d),this.sceneObjectsById[f.id]=f,a.reset(f.octree_aabb,f.position),this.octree.insert(f),(void 0===f.octree_common_root||null===f.octree_common_root)&&log("!!",f.name,"octree_common_root is null"))}}},setSkyBox:function(a){this.skybox=a},getSceneObject:function(a){return this.sceneObjectsByName[a]},bindSceneObject:function(c,b,e){if(-1==this.sceneObjects.indexOf(c)){this.sceneObjects.push(c);
b!==r&&b&&this.pickables.push(c);null!==c.name&&(this.sceneObjectsByName[c.name]=c);if(this.octree!==r&&(e===r||"true"===e))0>c.id&&(c.id=d,++d),this.sceneObjectsById[c.id]=c,a.reset(c.octree_aabb,c.position),this.octree.insert(c);if(c.children)for(var f=0,m=c.children.length;f<m;f++)this.bindSceneObject(c.children[f],b,e);return c}},removeLight:function(a){a=this.lights.indexOf(a);0<=a&&this.lights.splice(a,1)},removeSceneObject:function(a){var c;if(this.lockState)this.lockRemovals||(this.lockRemovals=
[]),-1==this.lockRemovals.indexOf(a)&&this.lockRemovals.push(a);else if(c=this.sceneObjects.indexOf(a),0<=c&&this.sceneObjects.splice(c,1),c=this.pickables.indexOf(a),0<=c&&this.pickables.splice(c,1),null!==a.name&&this.sceneObjectsByName[a.name]!==r&&delete this.sceneObjectsByName[a.name],a.children){c=0;for(var d=a.children.length;c<d;c++)this.removeSceneObject(a.children[c])}},bindLight:function(a,c){this.lights.push(a);if(this.octree!==r&&(c===r||"true"===c))a.method===b.light.method.GLOBAL?this.global_lights.push(a):
(a.method===b.light.method.DYNAMIC&&this.dynamic_lights.push(a),this.octree.insert_light(a));this.lights=this.lights.sort(x)},bindCamera:function(a){-1===this.cameras.indexOf(a)&&(this.cameras.push(a),this.camerasByName[a.name]=a);this.camera=a},removeCamera:function(a){"object"!==typeof a&&(a=this.getCamera(camName));-1===this.cameras.indexOf(a)&&(this.cameras.push(a),this.camerasByName[a.name]=a);return a},bind:function(a){a instanceof h.Light?this.bindLight(a):a instanceof h.SceneObject?this.bindSceneObject(a):
a instanceof h.Camera?this.bindCamera(a):a instanceof h.Vehicle?a.bindToScene(this):a instanceof h.RigidBody&&this.bindSceneObject(a.getSceneObject())},remove:function(a){a instanceof h.Light?this.removeLight(a):a instanceof h.SceneObject?this.removeSceneObject(a):a instanceof h.Camera?this.removeCamera(a):a instanceof bsae.RigidBody&&this.removeSceneObject(a.getSceneObject())},setCamera:function(a){a&&("object"!==typeof a&&(a=this.getCamera(a)),this.camera=a)},getCamera:function(a){return a===r?
this.camera:this.camerasByName[a]},evaluate:function(a){var c,d;c=0;for(d=this.sceneObjects.length;c<d;c++)this.sceneObjects[c].motion&&!this.sceneObjects[c].independentMotion&&this.sceneObjects[c].motion.apply(a,this.sceneObjects[c]);null!==this.camera.motion&&(null!==this.camera.targetSceneObject&&(this.camera.target=this.camera.targetSceneObject.position),this.camera.motion.apply(a,this.camera));c=0;for(d=this.lights.length;c<d;c++){var b=this.lights[c];null!==b.motion&&b.motion.apply(a,b)}},prepareTransforms:function(a){var c,
d;if(a){if(a.doTransform(),a.children){c=0;for(d=a.children.length;c<d;c++)a.children[c].doTransform(a.tMatrix),this.prepareTransforms(a.children[c])}}else if(0!==this.sceneObjects.length){c=0;for(d=this.sceneObjects.length;c<d;++c)this.prepareTransforms(this.sceneObjects[c])}},updateShadows:function(a){var c=f.gl;if(this.shadows_updated)return!1;a||this.doTransform();this.shadows_updated=!0;if(h.features.lightShadows){for(var a=c.getParameter(c.FRAMEBUFFER_BINDING),d=!1,e=c.getParameter(c.VIEWPORT),
m=0,q=this.lights.length;m<q;m++){var v=this.lights[m];if(v.light_type==b.light.type.SPOT_SHADOW||v.light_type==b.light.type.SPOT_SHADOW_PROJECTOR||v.light_type==b.light.type.AREA){var d=!0,r=[new h.Light(b.light.type.DEPTH_PACK)];v.light_type===b.light.type.AREA&&(v.areaCam=this.camera,v.updateAreaLight());f.shadow_near=v.dummyCam.nearclip;f.shadow_far=v.dummyCam.farclip;v.shadowBegin();for(var A=0,t=this.sceneObjects.length;A<t;A++){var G=this.sceneObjects[A];G.parent||!1===G.visible||!1===G.shadowCast||
this.renderSceneObject(G,v.dummyCam,r,!1,!0)}v.shadowEnd();a&&c.bindFramebuffer(c.FRAMEBUFFER,a)}}d&&c.viewport(e[0],e[1],e[2],e[3])}},updateCamera:function(){!1===this.camera.manual&&(this.camera.targeted?this.camera.lookat(this.camera.position[0],this.camera.position[1],this.camera.position[2],this.camera.target[0],this.camera.target[1],this.camera.target[2],0,1,0):this.camera.calcProjection());f.depth_alpha_near=this.camera.nearclip;f.depth_alpha_far=this.camera.farclip},resize:function(a,c){this.camera&&
this.camera.setDimensions(a,c)},doTransform:function(){for(var a=this.octree!==r,c=0,d=this.sceneObjects.length;c<d;c++){var b=this.sceneObjects[c];null===b.parent&&(this.prepareTransforms(b),a&&(lights=[],b.dirty&&null!==b.obj&&b.adjust_octree(),!1===b.visible||a&&(b.ignore_octree||!0===b.drawn_this_frame||!0===b.culled)||(lights=b.dynamic_lights,lights=lights.concat(b.static_lights),lights=lights.concat(this.global_lights),this.collect_stats&&(this.lights_rendered=Math.max(lights.length,this.lights_rendered),
this.lights_rendered===lights.length&&(lights_list=lights),++this.objects_rendered),lights=0===lights.length?[f.emptyLight]:lights.sort(x),b.drawn_this_frame=!0)))}},renderSceneObject:function(a,c,d,b,e,m,v){var q=!1,A=f.gl,b=b!==r&&b,e=e||!1,m=m||!1;if(a.visible&&a.obj){0>a.scale[0]&&(q=!q);0>a.scale[1]&&(q=!q);0>a.scale[2]&&(q=!q);q&&A.cullFace(A.FRONT);var t=a.obj;null!==t.morphTargets&&(-1!==a.morphSource&&t.setMorphSource(a.morphSource),-1!==a.morphTarget&&t.setMorphTarget(a.morphTarget),null!==
a.morphWeight&&(t.morphWeight=a.morphWeight));a.instanceMaterials&&t.bindInstanceMaterials(a.instanceMaterials);h.renderObject(t,c,a.tMatrix,d,e,m,this.isWireframe()||a.isWireframe())&&v&&v.push(a);a.instanceMaterials&&t.bindInstanceMaterials(null);q&&A.cullFace(A.BACK)}a=a.children;if(b&&a){b=0;for(q=a.length;b<q;b++)this.renderSceneObject(a[b],c,d,!0,e,m,v)}},runEvents:function(a){var c,d;this.lockState=!0;a.getSeconds&&(a=a.getSeconds());c=0;for(d=this.sceneObjects.length;c<d;c++){var b=this.sceneObjects[c];
b.hasEvents()&&b.getEventHandler().update(a)}this.lockState=!1;if(this.lockRemovals){c=0;for(d=this.lockRemovals.length;c<d;c++)this.removeSceneObject(this.lockRemovals[c])}this.lockRemovals=null},render:function(a){++this.frames;a=a||{};a.postProcess&&a.postProcess.begin(!a.postBuffer);var d=f.gl,b;b=this.octree!==r;this.lights_rendered=0;b&&(this.octree.reset_node_visibility(),this.octree.cleanup(),b=this.octree.get_frustum_hits(this.camera),this.lights_rendered=b.lights.length);this.doTransform();
this.updateCamera();this.updateShadows(!0);this.shadows_updated=!1;var e;b=0;for(e=this.lights.length;b<e;b++)this.lights[b].prepare(this.camera);this.objects_rendered=0;var m=[],q=[],v=this.lights;b=0;for(e=this.sceneObjects.length;b<e;b++){var C=this.sceneObjects[b];!1===C.visible||null!==C.parent||this.renderSceneObject(C,this.camera,v,!0,!0,!1,q)}b=0;for(e=q.length;b<e;b++)this.renderSceneObject(q[b],this.camera,v,!1,!1,!0);this.collect_stats&&(this.stats["objects.num_rendered"]=this.objects_rendered,
this.stats["lights.num_rendered"]=this.lights_rendered,this.stats["lights.rendered"]=m,this.stats["lights.num_global"]=this.global_lights.length,this.stats["lights.num_dynamic"]=this.dynamic_lights.length);null!==this.skybox&&!0===this.skybox.ready&&(d.cullFace(d.FRONT),b=2*this.camera.farclip/Math.sqrt(3),this.skybox.scene_object.position=this.camera.parent?c.vec3_multiply(this.camera.position,this.camera.parent.tMatrix):[this.camera.position[0],this.camera.position[1],this.camera.position[2]],this.skybox.scene_object.scale=
[b,b,b],this.skybox.scene_object.doTransform(),h.renderObject(this.skybox.scene_object.obj,this.camera,this.skybox.scene_object.tMatrix,[]),d.cullFace(d.BACK));a.postProcess&&(a.postProcess.end(),a.postBuffer||a.postProcess.render())},bbRayTest:function(a,c,d){var b=h.vec3,e=[],c=2===c.length?this.camera.unProject(c[0],c[1]):b.add(a,c),f;for(f in this.pickables)if(this.pickables.hasOwnProperty(f)){var m=this.pickables[f];if(!0===m.visible){var q,r;r=m.getAABB();q=r[0];r=r[1];0.2>r[0]-q[0]&&(q[0]-=
0.1,r[0]+=0.1);0.2>r[1]-q[1]&&(q[1]-=0.1,r[1]+=0.1);0.2>r[2]-q[2]&&(q[2]-=0.1,r[2]+=0.1);var t=b.multiply(b.add(q,r),0.5),G=b.getClosestTo(a,c,t),t=b.length(b.subtract(G,t));(G[0]>=q[0]&&G[0]<=r[0]?1:0)+(G[1]>=q[1]&&G[1]<=r[1]?1:0)+(G[2]>=q[2]&&G[2]<=r[2]?1:0)>=d&&e.push({dist:t,obj:m})}}e.length&&e.sort(function(a,c){return a.dist==c.dist?0:a.dist<c.dist?-1:1});return e}};q.prototype={addMesh:function(a,c,d){this.meshBin[a]===r&&(this.meshBin[a]=[],this.meshBinPtr[a]===r&&(this.meshBinPtr[a]=0));
this.meshMap[c]===r&&(this.meshMap[c]=d,this.meshBin[a].push(d))},addImage:function(a,c,d){this.imageBin[a]===r&&(this.imageBin[a]=[],this.imageBinPtr[a]===r&&(this.imageBinPtr[a]=0));this.imageMap[c]===r&&(this.imageMap[c]=d,this.imageBin[a].push(d))},getMeshes:function(a){return this.meshBin[a]},getImages:function(a){return this.imageBin[a]},rewindMeshes:function(a){this.meshBinPtr[a]=0},rewindImages:function(a){this.imageBinPtr[a]=0},getNextMesh:function(a){var c=this.meshBinPtr[a];return c<this.meshBin[a].length?
(this.meshBinPtr[a]++,this.meshBin[a][c]):null},loadNextMesh:function(a){a=this.getNextMesh(a);return null!==a?(null===a.compiled&&(a.triangulateQuads(),a.compile(),a.clean()),!0):!1},isMeshBinEmpty:function(a){return this.meshBinPtr[a]===this.meshBin[a].length},loadNextImage:function(a){a=this.getNextImage(a);null!==a&&(a.src=a.deferredSrc)},getNextImage:function(a){var c=this.imageBinPtr[a];return c<this.imageBin[a].length?(this.imageBinPtr[a]++,this.imageBin[a][c]):null},isImageBinEmpty:function(a){return this.imageBinPtr[a]===
this.imageBin[a].length}};return{Scene:m,SceneObject:t,SkyBox:function(a){var c=a.texture,a=a.mapping,d=this;this.mapping=null;this.ready=!1;this.texture=null;this.onready=function(){c.onready=null;var a=1/h.Images[d.texture.tex_id].width;null===d.mapping&&(d.mapping=[[1/3,0.5,2/3-a,1],[0,0.5,1/3,1],[0,0,1/3-a,0.5],[2/3,0,1,0.5],[2/3+a,0.5,1,1],[1/3,0,2/3,0.5]]);var a=new h.Material({name:"skybox",textures:{color:c},noFog:!0}),b=new h.Mesh;b.sky_mapping=d.mapping;h.primitives.box({mesh:b,size:1,material:a,
uvmapper:{projectionMode:h.enums.uv.projection.SKY,scale:[1,1,1]}});b.prepare();d.scene_object=new h.SceneObject(b);d.ready=!0};if(c&&("string"===typeof c?c=new h.Texture(c,null,null,null,this.onready):c.loaded||(c.onready=this.onready),this.texture=c,a))this.mapping=a,this.onready()},DeferredBin:q}});
CubicVR.RegisterModule("PostProcess",function(h){function x(a){if(a.shader_vertex===q||a.shader_fragment===q)return null;this.outputMode=a.outputMode===q?b.post.output.REPLACE:CubicVR.parseEnum(CubicVR.enums.post.output,a.outputMode);this.onresize=a.onresize===q?null:a.onresize;this.onupdate=a.onupdate===q?null:a.onupdate;this.init=a.init===q?null:a.init;this.enabled=a.enabled===q?!0:a.enabled;this.outputDivisor=a.outputDivisor===q?1:a.outputDivisor;this.shader=new CubicVR.Shader(a.shader_vertex,
a.shader_fragment);this.shader.use();this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");null!==this.init&&this.init(this.shader)}function t(a,d,b){var g=r.gl;this.width=a;this.height=d;this.accum=b===q?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(a,d,!0);this.bufferA=new CubicVR.RenderBuffer(a,d,!1);this.bufferB=new CubicVR.RenderBuffer(a,
d,!1);this.bufferC=new CubicVR.RenderBuffer(a,d,!1);this.accumOpacity=1;this.accumIntensity=0.3;this.accum&&(this.accumBuffer=new CubicVR.RenderBuffer(a,d,!1),this.accumBuffer.use(),g.clearColor(0,0,0,1),g.clear(g.COLOR_BUFFER_BIT),this.blur_shader=new x({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}}));this.bufferA.use();g.clearColor(0,0,0,1);g.clear(g.COLOR_BUFFER_BIT);this.bufferB.use();g.clearColor(0,0,0,1);g.clear(g.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new x({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(a,d)}function m(a,d,b){this.createBuffer(a,d,b)}var q=h.undef,r=h.GLCore,b=CubicVR.enums;b.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var f=[],a=[];t.prototype={setBlurOpacity:function(a){this.accumOpacity=a},setBlurIntensity:function(a){this.accumIntensity=a},makeFSQuad:function(a,d){var b=r.gl,g={},f=a/a,o=d/d;g.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);g.vbo_uvs=new Float32Array([0,0,f,0,f,o,0,o,0,0,f,o]);g.gl_points=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,
g.gl_points);b.bufferData(b.ARRAY_BUFFER,g.vbo_points,b.STATIC_DRAW);g.gl_uvs=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,g.gl_uvs);b.bufferData(b.ARRAY_BUFFER,g.vbo_uvs,b.STATIC_DRAW);return g},destroyFSQuad:function(a){var d=r.gl;d.deleteBuffer(a.gl_points);d.deleteBuffer(a.gl_uvs)},renderFSQuad:function(a,d){var b=r.gl;a.use();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null);b.bindBuffer(b.ARRAY_BUFFER,d.gl_points);b.vertexAttribPointer(a.aVertex,3,b.FLOAT,!1,0,0);b.enableVertexAttribArray(a.aVertex);
b.bindBuffer(b.ARRAY_BUFFER,d.gl_uvs);b.vertexAttribPointer(a.aTex,2,b.FLOAT,!1,0,0);b.enableVertexAttribArray(a.aTex);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null);b.drawArrays(b.TRIANGLES,0,6)},addShader:function(c){this.shaders[this.shaders.length]=c;c.shader.use();c.shader.setVector("texel",this.vTexel);if(c.outputDivisor&&1!=c.outputDivisor&&f[c.outputDivisor]===q){var b=this.width/c.outputDivisor|0,e=this.height/c.outputDivisor|0;f[c.outputDivisor]=new CubicVR.RenderBuffer(b,e,!1);a[c.outputDivisor]=
this.makeFSQuad(b,e)}},resize:function(c,b){var e=r.gl;this.width=c;this.height=b;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&(this.accumBuffer.destroyBuffer(),
this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT));for(var g in f){var e=this.width/g|0,n=this.height/g|0;f[g].destroyBuffer();f[g].createBuffer(e,n,!1);this.destroyFSQuad(a[g]);a[g]=this.makeFSQuad(e,n)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;g=0;for(e=this.shaders.length;g<e;g++)if(this.shaders[g].shader.use(),this.shaders[g].shader.setVector("texel",this.vTexel),null!==this.shaders[g].onresize)this.shaders[g].onresize(this.shaders[g].shader,
this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var a=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=a},begin:function(a){var b=r.gl;this.captureBuffer.use();a&&(this.captureBuffer.depth?b.clear(b.DEPTH_BUFFER_BIT|b.COLOR_BUFFER_BIT):b.clear(b.COLOR_BUFFER_BIT))},end:function(){var a=r.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)},render:function(){var c=r.gl;this.captureBuffer.texture.use(c.TEXTURE1);
this.outputBuffer.use();this.captureBuffer.texture.use(c.TEXTURE0);c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var d=0,e=0,g=this.shaders.length;e<g;e++){var n=this.shaders[e];if(n.enabled){this.swap();this.inputBuffer.texture.use(c.TEXTURE0);var o=n.outputMode;if(o===b.post.output.REPLACE)1!==n.outputDivisor?f[n.outputDivisor].use():this.outputBuffer.use(),c.clearColor(0,0,0,1),c.clear(c.COLOR_BUFFER_BIT);else if(o===b.post.output.ADD||
o===b.post.output.BLEND)1!==n.outputDivisor?f[n.outputDivisor].use():this.bufferC.use(),c.clearColor(0,0,0,1),c.clear(c.COLOR_BUFFER_BIT);null!==n.onupdate&&(n.shader.use(),n.onupdate(n.shader));1!==n.outputDivisor?(c.viewport(0,0,f[n.outputDivisor].width,f[n.outputDivisor].height),this.renderFSQuad(n.shader,a[n.outputDivisor]),n.outputMode===b.post.output.REPLACE?(this.outputBuffer.use(),f[n.outputDivisor].texture.use(c.TEXTURE0),c.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,
this.fsQuad)):c.viewport(0,0,this.width,this.height)):this.renderFSQuad(n.shader,this.fsQuad);o===b.post.output.BLEND?(this.swap(),this.outputBuffer.use(),c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(c.TEXTURE0),1!==n.outputDivisor?f[n.outputDivisor].texture.use(c.TEXTURE0):this.bufferC.texture.use(c.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),c.disable(c.BLEND)):o===b.post.output.ADD&&(this.swap(),this.outputBuffer.use(),c.enable(c.BLEND),
c.blendFunc(c.ONE,c.ONE),1!==n.outputDivisor?f[n.outputDivisor].texture.use(c.TEXTURE0):this.bufferC.texture.use(c.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),c.disable(c.BLEND));this.end();d++}}0===d?this.captureBuffer.texture.use(c.TEXTURE0):this.outputBuffer.texture.use(c.TEXTURE0);this.accum&&1!==this.accumOpacity?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),
this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),c.disable(c.BLEND),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(c.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),c.disable(c.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};m.prototype={createBuffer:function(a,
b,e){this.texture=this.depth=this.fbo=null;this.width=parseInt(a,10);this.height=parseInt(b,10);var a=this.sizeParam(a),b=this.sizeParam(b),g=r.gl;this.fbo=g.createFramebuffer();e&&(this.depth=g.createRenderbuffer());g.bindFramebuffer(g.FRAMEBUFFER,this.fbo);e&&(g.bindRenderbuffer(g.RENDERBUFFER,this.depth),-1!==navigator.appVersion.indexOf("Windows")?(g.renderbufferStorage(g.RENDERBUFFER,g.DEPTH_COMPONENT16,a,b),g.framebufferRenderbuffer(g.FRAMEBUFFER,g.DEPTH_ATTACHMENT,g.RENDERBUFFER,this.depth)):
(g.renderbufferStorage(g.RENDERBUFFER,g.DEPTH_STENCIL,a,b),g.framebufferRenderbuffer(g.FRAMEBUFFER,g.DEPTH_STENCIL_ATTACHMENT,g.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;g.bindTexture(g.TEXTURE_2D,h.Textures[this.texture.tex_id]);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.LINEAR);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.NEAREST);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE);g.texImage2D(g.TEXTURE_2D,
0,g.RGBA,a,b,0,g.RGBA,g.UNSIGNED_BYTE,null);g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_2D,h.Textures[this.texture.tex_id],0);g.bindFramebuffer(g.FRAMEBUFFER,null)},destroyBuffer:function(){var a=r.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteRenderbuffer(this.depth);a.deleteFramebuffer(this.fbo);a.deleteTexture(h.Textures[this.texture.tex_id]);h.Textures[this.texture.tex_id]=null},sizeParam:function(a){return a},use:function(){var a=r.gl;a.bindFramebuffer(a.FRAMEBUFFER,
this.fbo)}};return{RenderBuffer:m,PostProcessShader:x,PostProcessChain:t,fsQuad:{make:t.prototype.makeFSQuad,destroy:t.prototype.destroyFSQuad,render:t.prototype.renderFSQuad}}});
CubicVR.RegisterModule("Layout",function(){function h(h){this.texture=h.texture?h.texture:null;this.width=h.width?h.width:128;this.height=h.height?h.height:128;this.x=h.x?h.x:0;this.y=h.y?h.y:0;this.blend=h.blend?h.blend:!1;this.opacity="undefined"!==typeof h.opacity?h.opacity:1;this.tint=h.tint?h.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function x(h){this.texture=h.texture?h.texture:null;this.width=h.width?h.width:128;this.height=h.height?h.height:128;
this.x=h.x?h.x:0;this.y=h.y?h.y:0;this.blend=h.blend?h.blend:!1;this.opacity="undefined"!==typeof h.opacity?h.opacity:1;this.tint=h.tint?h.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}h.prototype={addSubview:function(h){this.childViews.push(h);h.superView=this},makePanel:function(h){return this.superView.makePanel(h)}};x.prototype={resize:function(h,m){this.width=h;this.height=m},setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(h){h.setInt("srcTex",0);h.addVector("screen");h.addVector("position");h.addVector("tint");h.addVector("size")}})},addSubview:function(h){this.childViews.push(h);h.superView=this},removeSubview:function(h){h=this.childViews.indexOf(h);-1<h&&this.childViews.splice(h,
1)},makePanel:function(h){var m=CubicVR.GLCore.gl,q={};q.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);q.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);q.gl_points=m.createBuffer();m.bindBuffer(m.ARRAY_BUFFER,q.gl_points);m.bufferData(m.ARRAY_BUFFER,q.vbo_points,m.STATIC_DRAW);q.gl_uvs=m.createBuffer();m.bindBuffer(m.ARRAY_BUFFER,q.gl_uvs);m.bufferData(m.ARRAY_BUFFER,q.vbo_uvs,m.STATIC_DRAW);h.panel=q},renderPanel:function(h){if(!h.texture)return!1;h.texture.use(CubicVR.GLCore.gl.TEXTURE0)},
renderView:function(h){if(h.texture){var m=CubicVR.GLCore.gl,q=h.offsetLeft,r=h.offsetTop;q||(q=0);r||(r=0);var b=this.shader.shader;b.use();b.setVector("screen",[this.width,this.height,0]);b.setVector("position",[h.x+q,h.y+r,0]);b.setVector("size",[h.width,h.height,0]);b.setVector("tint",h.tint);h.blend&&(m.enable(m.BLEND),m.blendFunc(m.SRC_ALPHA,m.ONE_MINUS_SRC_ALPHA));h.texture.use(m.TEXTURE0);m.drawArrays(m.TRIANGLES,0,6);h.blend&&(m.disable(m.BLEND),m.blendFunc(m.ONE,m.ZERO))}},render:function(){var h=
CubicVR.GLCore.gl;h.disable(h.DEPTH_TEST);this.texture&&this.renderView(this);var m=[];this.offsetTop=this.offsetLeft=0;m.push(this);var q=this.shader.shader;q.use();h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);h.bindBuffer(h.ARRAY_BUFFER,this.panel.gl_points);h.vertexAttribPointer(q.uniforms.aVertex,3,h.FLOAT,!1,0,0);h.enableVertexAttribArray(q.uniforms.aVertex);h.bindBuffer(h.ARRAY_BUFFER,this.panel.gl_uvs);h.vertexAttribPointer(q.uniforms.aTex,2,h.FLOAT,!1,0,0);h.enableVertexAttribArray(q.uniforms.aTex);
for(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);m.length;){var r=m.pop();this.renderView(r);if(r.childViews.length)for(var b=r.childViews.length-1;0<=b;b--)r.childViews[b].offsetLeft=r.x+r.offsetLeft,r.childViews[b].offsetTop=r.y+r.offsetTop,m.push(r.childViews[b])}h.disableVertexAttribArray(q.uniforms.aTex);h.enable(h.DEPTH_TEST)}};return{Layout:x,View:h}});
CubicVR.RegisterModule("Primitives",function(h){function x(a,c,b,d,f,n){var m=h.mat4,q=h.vec3,r=[],u,y=[0,1,0],t=[1,0,0],z=[0,0,0],x=a.points.length,I,H,J;for(I=u=0;I<g&&u!==b;I+=g/b){t=[Math.cos(I),0,Math.sin(I)];H=0;for(J=c.length;H<J;H++)z=q.add(q.multiply(t,c[H][0]),q.multiply(y,c[H][1])),r[u]===e&&(r[u]=[]),r[u].push(z);u++}J=null;f!==e&&(J=f.getResult!==e?f.getResult():f);for(H=0;H<b;H++){f=0;for(u=c.length;f<u;f++)J?a.addPoint(m.vec3_multiply(r[H][f],J)):a.addPoint(r[H][f])}"string"===typeof d&&
(d=new h.Material(d));a.setFaceMaterial(d);for(f=0;f<b;f++){H=0;for(J=c.length-1;H<J;H++)m=H+c.length*f,r=H+c.length*((f+1)%b),q.equal(a.points[x+m],a.points[x+r])?a.addFace([x+m+1,x+r+1,x+r]):q.equal(a.points[x+m+1],a.points[x+r+1])?a.addFace([x+m,x+m+1,x+r]):a.addFace([x+m,x+m+1,x+r+1,x+r])}n!==e&&(c=null,n.apply!==e?c=n:n&&(c=new h.UVMapper(n)),null!==c&&(a.calcFaceNormals(),c.apply(a,d)))}function t(a,c,b,d,f){var g=h.mat4,c=0.5*c,n=a.points.length;"string"===typeof b&&(b=new h.Material(b));a.setFaceMaterial(b);
d!==e?(d=d.getResult!==e?d.getResult():d,a.addPoint([g.vec3_multiply([c,-c,0],d),g.vec3_multiply([c,c,0],d),g.vec3_multiply([-c,c,0],d),g.vec3_multiply([-c,-c,0],d)])):a.addPoint([[c,-c,0],[c,c,0],[-c,c,0],[-c,-c,0]]);a.addFace([[n+0,n+1,n+2,n+3],[n+3,n+2,n+1,n+0]]);f!==e&&(g=null,f.apply!==e?g=f:f&&(g=new h.UVMapper(f)),null!==g&&(a.calcFaceNormals(),g.apply(a,b)))}function m(a,c,b,d,f){var g=h.mat4,n,m;"object"===typeof c?(n=c[0]/2,m=c[1]/2,c=c[2]/2):n=m=c/=2;var q=a.points.length;"string"===typeof b&&
(b=new h.Material(b));a.setFaceMaterial(b);d!==e?(d=d.getResult!==e?d.getResult():d,a.addPoint([g.vec3_multiply([n,-m,c],d),g.vec3_multiply([n,m,c],d),g.vec3_multiply([-n,m,c],d),g.vec3_multiply([-n,-m,c],d),g.vec3_multiply([n,-m,-c],d),g.vec3_multiply([n,m,-c],d),g.vec3_multiply([-n,m,-c],d),g.vec3_multiply([-n,-m,-c],d)])):a.addPoint([[n,-m,c],[n,m,c],[-n,m,c],[-n,-m,c],[n,-m,-c],[n,m,-c],[-n,m,-c],[-n,-m,-c]]);a.addFace([[q+0,q+1,q+2,q+3],[q+7,q+6,q+5,q+4],[q+4,q+5,q+1,q+0],[q+5,q+6,q+2,q+1],[q+
6,q+7,q+3,q+2],[q+7,q+4,q+0,q+3]]);f!==e&&(g=null,f.apply!==e?g=f:f&&(g=new h.UVMapper(f)),null!==g&&(a.calcFaceNormals(),g.apply(a,b)))}function q(a,c,b,d,e,f,n,m){for(var q=[],b=b-c,c=c+b/2,r=g/e,y=0,t=0;t<=e;t++)q.push([c+Math.cos(y)*b,Math.sin(y)*b,0]),y+=r;h.genLatheObject(a,q,d,f,n,m)}function r(a,c,b,d,e,g,f){h.genLatheObject(a,[[0,-b/2,0],[c/2,-b/2,0],[0,b/2,0]],d,e,g,f)}function b(a,c,b,d,e,g,f){h.genLatheObject(a,[[0,-b/2,0],[c,-b/2,0],[c,b/2,0],[0,b/2,0]],d,e,g,f)}function f(a,c,b,d,e,
g,f){for(var m=[],d=(d/=2)|0,b=b|0,q=Math.PI/d,r=-n,y=0;y<=d;y++)m.push([Math.cos(r)*c,Math.sin(r)*c,0]),r+=q;h.genLatheObject(a,m,b,e,g,f)}function a(a){"string"===typeof a&&(a=h.get(a,h.Material));return a===e?new h.Material:a.use?a:"object"===typeof a?new h.Material(a):new h.Material}function c(a){if(a===e)return e;if("array"===typeof a)return a;if("object"===typeof a)return a.getResult?a.getResult():a.position||a.rotation||a.scale?h.mat4.transform(a.position,a.rotation,a.scale):e}function d(a){"string"===
typeof a&&(a=h.get(a));return a===e?e:a.apply?a:"object"===typeof a?new h.UVMapper(a):e}var e=h.undef,g=2*Math.PI,n=Math.PI/2;return{genPlaneObject:t,genBoxObject:m,genLatheObject:x,genTorusObject:q,genConeObject:r,genCylinderObject:b,genSphereObject:f,primitives:{lathe:function(b){var g,f,n,m;if(b.points==e)return null;g=b.mesh!==e?b.mesh:new h.Mesh(b.name!==e?b.name:e);f=a(b.material);n=c(b.transform);m=d(b.uvmapper||b.uv);x(g,b.points,b.divisions!==e?b.divisions:24,f,n,m);return g},box:function(b){var g,
f,n,v;g=b.mesh!==e?b.mesh:new h.Mesh(b.name!==e?b.name:e);f=a(b.material);n=c(b.transform);v=d(b.uvmapper||b.uv);m(g,b.size!==e?b.size:1,f,n,v);return g},plane:function(b){var g,f,n,m;g=b.mesh!==e?b.mesh:new h.Mesh(b.name!==e?b.name:e);f=a(b.material);n=c(b.transform);m=d(b.uvmapper||b.uv);t(g,b.size!==e?b.size:1,f,n,m);return g},sphere:function(b){var g,n,m,v;g=b.mesh!==e?b.mesh:new h.Mesh(b.name!==e?b.name:e);n=a(b.material);m=c(b.transform);v=d(b.uvmapper||b.uv);f(g,b.radius!==e?b.radius:1,b.lon!==
e?b.lon:24,b.lat!==e?b.lat:24,n,m,v);return g},torus:function(b){var g,f,n,m;g=b.mesh!==e?b.mesh:new h.Mesh(b.name!==e?b.name:e);f=a(b.material);n=c(b.transform);m=d(b.uvmapper||b.uv);q(g,b.innerRadius!==e?b.innerRadius:0.75,b.outerRadius!==e?b.outerRadius:1,b.lon!==e?b.lon:24,b.lat!==e?b.lat:24,f,n,m);return g},cone:function(b){var g,f,n,m;g=b.mesh!==e?b.mesh:new h.Mesh(b.name!==e?b.name:e);f=a(b.material);n=c(b.transform);m=d(b.uvmapper||b.uv);r(g,b.base!==e?b.base:1,b.height!==e?b.height:1,b.lon!==
e?b.lon:24,f,n,m);return g},cylinder:function(g){var f,n,m,v;f=g.mesh!==e?g.mesh:new h.Mesh(g.name!==e?g.name:e);n=a(g.material);m=c(g.transform);v=d(g.uvmapper||g.uv);b(f,g.radius!==e?g.radius:1,g.height!==e?g.height:1,g.lon!==e?g.lon:24,n,m,v);return f}}}});
CubicVR.RegisterModule("COLLADA",function(h){function x(f,a){function c(a){return!a.color?!1:(a=a.color)?e.floatDelimArray(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")," "):!1}function d(a){return!a["float"]?!1:a=(a=a["float"])?parseFloat(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")):0}var e=h.util,g,n,o,s,q,w;w="object"==typeof f?f:-1!=f.indexOf(".js")?e.getJSON(f):h.util.xml2badgerfish(e.getXML(f));var v,C,A,B,x,u,y,D,z,F,I,H,J,L,M,K,N,Y,ca,U,na,Q=w;w=null;if(!Q.COLLADA)throw Error(f+" does not appear to be a valid COLLADA file.");
var Q=Q.COLLADA,O={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(Q.asset){var Ma=Q.asset.up_axis.$;"X_UP"===Ma?O.up_axis=0:"Y_UP"===Ma?O.up_axis=1:"Z_UP"===Ma&&(O.up_axis=2)}var gb=O.up_axis;if(Q.library_images&&(Q.library_images.image&&!Q.library_images.image.length&&(Q.library_images.image=[Q.library_images.image]),Q.library_images.image.length))for(var hb=Q.library_images.image,Na=0,qb=hb.length;Na<qb;Na++){var Oa=hb[Na],ib=Oa["@id"],Ic=
Oa["@name"],ac=Oa.init_from;if(ac.$){var ra=ac.$;a!==t&&-1!==ra.lastIndexOf("/")&&(ra=ra.substr(ra.lastIndexOf("/")+1));a!==t&&-1!==ra.lastIndexOf("\\")&&(ra=ra.substr(ra.lastIndexOf("\\")+1));O.images[ib]={source:ra,id:ib,name:Ic}}}var jb,rb,bc,V,Pa,ka,Qa,da,P,W,S,Da,ha,Ra,Sa,Z,aa;if(Q.library_effects){var Ta=Q.library_effects.effect;Ta&&!Ta.length&&(Ta=[Ta]);rb=0;for(bc=Ta.length;rb<bc;rb++){var Db=Ta[rb];jb=Db["@id"];var T={};T.id=jb;T.surfaces=[];T.samplers=[];(da=Db.profile_COMMON.newparam)&&
!da.length&&(da=[da]);if(da){Y=0;for(ca=da.length;Y<ca;Y++){var sa=da[Y],Ua=sa["@sid"];if(sa.surface){T.surfaces[Ua]={};var cc=sa.surface.init_from.$;"object"===typeof O.images[cc]&&(T.surfaces[Ua].source=a+"/"+O.images[cc].source)}else if(sa.sampler2D&&(T.samplers[Ua]={},T.samplers[Ua].source=sa.sampler2D.source.$,sa.sampler2D.minfilter&&(T.samplers[Ua].minfilter=sa.sampler2D.minfilter.$),sa.sampler2D.magfilter))T.samplers[Ua].magfiter=sa.sampler2D.magfilter.$}}var va=Db.profile_COMMON.technique;
va&&!va.length&&(va=[va]);T.material={textures_ref:[]};V=0;for(Pa=va.length;V<Pa;V++){g=va[V].blinn;g||(g=va[V].phong);g||(g=va[V].lambert);if(g)for(var ea in g){var sb=g[ea],ta=c(sb),dc=d(sb),Eb;Eb=sb.texture?sb.texture["@texture"]:!1;!1!==ta&&3<ta.length&&ta.pop();"emission"==ea?!1!==ta&&(T.material.ambient=ta):"ambient"!=ea&&("diffuse"==ea?!1!==ta&&(T.material.color=ta):"specular"==ea?!1!==ta&&(T.material.specular=ta):"shininess"==ea&&!1!==dc&&(T.material.shininess=dc));if(!1!==Eb){var Va=T.surfaces[T.samplers[Eb].source].source;
"emission"==ea?T.material.textures_ref.push({image:Va,type:m.texture.map.AMBIENT}):"ambient"==ea?T.material.textures_ref.push({image:Va,type:m.texture.map.AMBIENT}):"diffuse"==ea?T.material.textures_ref.push({image:Va,type:m.texture.map.COLOR}):"specular"==ea?T.material.textures_ref.push({image:Va,type:m.texture.map.SPECULAR}):"shininess"!=ea&&("reflective"==ea?T.material.textures_ref.push({image:Va,type:m.texture.map.REFLECT}):"reflectivity"!=ea&&"transparent"==ea&&T.material.textures_ref.push({image:Va,
type:m.texture.map.ALPHA}))}}O.effects[jb]=T}}}var Fb=b.getAllOf(Q,"instance_geometry"),tb=[];if(Fb.length){u=0;for(D=Fb.length;u<D;u++){var ec=Fb[u],Gb=b.getAllOf(ec,"instance_material");if(Gb.length){U=0;for(na=Gb.length;U<na;U++){var fc=Gb[U],Jc=fc["@symbol"],Kc=fc["@target"].substr(1);tb[ec["@url"].substr(1)+":"+Jc]=Kc}}}}var Hb=Q.library_materials;if(Hb&&Hb.material){var Wa=Hb.material;Wa&&!Wa.length&&(Wa=[Wa]);F=0;for(I=Wa.length;F<I;F++){var Ib=Wa[F],Lc=Ib["@id"],Mc=Ib["@name"],gc=Ib.instance_effect;
gc&&(jb=gc["@url"].substr(1),O.materials.push({id:Lc,name:Mc,mat:O.effects[jb].material}))}}var hc=Q.library_geometries,Xa;if(hc){var ua=hc.geometry;ua&&!ua.length&&(ua=[ua]);if(ua.length)for(var kb=0,Nc=ua.length;kb<Nc;kb++){var ma={id:t,points:[],parts:[]},Ya=ua[kb].mesh;if(Ya){Xa=ua[kb]["@id"];q=ua[kb]["@name"];var Za=Ya.source;Za&&!Za.length&&(Za=[Za]);for(var R=[],Jb=0,Oc=Za.length;Jb<Oc;Jb++){var ub=Za[Jb];n=ub["@id"];var Pc=ub["@name"],Kb=ub.float_array;Kb&&(R[n]={id:n,name:Pc,data:e.floatDelimArray(Kb.$?
Kb.$:""," ")});var Lb=ub.technique_common.accessor;Lb&&(R[n].count=Lb["@count"]|0,R[n].stride=Lb["@stride"]|0,R[n].count&&(R[n].data=e.repackArray(R[n].data,R[n].stride,R[n].count)))}var Mb=Ya.vertices,lb=null,Nb=null,Ea=null,Fa=null,Ga=null;if(Mb&&(Nb=Mb["@id"],(P=Mb.input)&&!P.length&&(P=[P]),P)){ka=0;for(Qa=P.length;ka<Qa;ka++)W=P[ka],"POSITION"===W["@semantic"]&&(lb=W["@source"].substr(1))}var oa=Ya.triangles;oa&&!oa.length&&(oa=[oa]);if(oa){V=0;for(Pa=oa.length;V<Pa;V++){aa={material:0,faces:[],
normals:[],texcoords:[],colors:[]};var Qc=parseInt(oa[V]["@count"],10);(P=oa[V].input)&&!P.length&&(P=[P]);S=[];if(P.length){ka=0;for(Qa=P.length;ka<Qa;ka++)W=P[ka],Z=parseInt(W["@offset"],10),s=W["@source"].substr(1),"VERTEX"===W["@semantic"]?(s===Nb&&(s=lb),S[Z]=0):"NORMAL"===W["@semantic"]?(Ea=s,R[Ea].count&&(S[Z]=1)):"TEXCOORD"===W["@semantic"]?(Ga=s,R[Ga].count&&(S[Z]=2)):"COLOR"===W["@semantic"]?(Fa=s,R[Fa].count&&(S[Z]=3)):S[Z]=4}B=S.length;o=Xa+":"+oa[V]["@material"];null===o?aa.material=
0:tb[o]===t?(r("missing material ["+o+"]@"+Xa+"?"),aa.material=0):aa.material=tb[o];var ic=oa[V].p,wa=[];ic&&(wa=e.intDelimArray(ic.$," "));if(wa.length&&(x=wa.length/S.length/3,x===Qc)){0===ma.points.length&&(ma.points=R[lb].data);u=Z=0;D=wa.length;for(z=S.length;u<D;u+=3*z){v=[];C=[];A=[];ia=[];for(U=0;U<3*z;U++){var vb=U%z;0===S[vb]?C.push(wa[u+U]):1===S[vb]?v.push(wa[u+U]):2===S[vb]?A.push(wa[u+U]):3===S[vb]&&ia.push(wa[u+U])}C.length&&(aa.faces.push(C),3===v.length&&aa.normals.push([b.fixuaxis(O.up_axis,
R[Ea].data[v[0]]),b.fixuaxis(O.up_axis,R[Ea].data[v[1]]),b.fixuaxis(O.up_axis,R[Ea].data[v[2]])]),3===A.length&&aa.texcoords.push([R[Ga].data[A[0]],R[Ga].data[A[1]],R[Ga].data[A[2]]]),3===ia.length&&aa.colors.push([R[Fa].data[ia[0]],R[Fa].data[ia[1]],R[Fa].data[ia[2]]]))}}ma.parts.push(aa)}}var ja=Ya.polylist;ja||(ja=Ya.polygons);ja&&!ja.length&&(ja=[ja]);if(ja){V=0;for(Pa=ja.length;V<Pa;V++){aa={material:0,faces:[],normals:[],texcoords:[],colors:[]};var jc=parseInt(ja[V]["@count"],10);(P=ja[V].input)&&
!P.length&&(P=[P]);S=[];if(P.length){ka=0;for(Qa=P.length;ka<Qa;ka++){W=P[ka];var Ob=W["@offset"];null===Ob&&(Ob=W["@idx"]);Z=parseInt(Ob,10);s=W["@source"].substr(1);"VERTEX"===W["@semantic"]?(s===Nb&&(s=lb),S[Z]=0):"NORMAL"===W["@semantic"]?(Ea=s,S[Z]=1):"TEXCOORD"===W["@semantic"]?(Ga=s,S[Z]=2):"COLOR"===W["@semantic"]?(Fa=s,S[Z]=3):S[Z]=4}}var kc=ja[V].vcount,$a=[];kc&&($a=e.intDelimArray(kc.$," "));o=Xa+":"+ja[V]["@material"];aa.material=o===t?0:tb[o];var mb=ja[V].p;B=S.length;var xa=[];if(1<
mb.length&&!$a.length){Y=0;for(ca=mb.length;Y<ca;Y++){var lc=e.intDelimArray(mb[Y].$," ");$a[Y]=parseInt(lc.length/B,10);xa=xa.concat(lc)}}else mb&&(xa=e.intDelimArray(mb.$," "));if(xa.length)if(x=$a.length,x!==jc)r("poly vcount data doesn't add up, skipping object load: "+x+" !== "+jc);else{0===ma.points.length&&(ma.points=R[lb].data);u=Z=0;for(D=$a.length;u<D;u++){v=[];C=[];A=[];ia=[];U=0;for(na=$a[u]*B;U<na;U++)0===S[U%B]?C.push(xa[Z]):1===S[U%B]?v.push(xa[Z]):2===S[U%B]?A.push(xa[Z]):3===S[U%
B]&&ia.push(xa[Z]),Z++;var ab;if(C.length){aa.faces.push(C);if(v.length){$=[];H=0;for(J=v.length;H<J;H++)$.push(b.fixuaxis(O.up_axis,R[Ea].data[v[H]]));aa.normals.push($)}if(A.length){ab=[];H=0;for(J=A.length;H<J;H++)ab.push(R[Ga].data[A[H]]);aa.texcoords.push(ab)}if(ia.length){ab=[];H=0;for(J=ia.length;H<J;H++)ab.push(R[Fa].data[ia[H]]);aa.colors.push(ab)}}}}ma.parts.push(aa)}}if(1!==gb){u=0;for(D=ma.points.length;u<D;u++)ma.points[u]=b.fixuaxis(O.up_axis,ma.points[u])}ma.id=Xa;O.meshes.push(ma)}}}var mc=
Q.library_cameras;if(mc){(Ra=mc.camera)&&!Ra.length&&(Ra=[Ra]);L=0;for(M=Ra.length;L<M;L++){ha=Ra[L];var Rc=ha["@id"],wb=0,xb=0,yb=0;ha.optics&&(ha.optics.technique_common&&ha.optics.technique_common.perspective)&&(wb=ha.optics.technique_common.perspective.yfov,xb=ha.optics.technique_common.perspective.znear,yb=ha.optics.technique_common.perspective.zfar);var Pb,Qb,Rb;if(!wb&&!xb&&!yb){(da=ha.param)&&!da.length&&(da=[da]);u=0;for(D=da.length;u<D;u++){var Sb=da[u].$,Tb=da[u]["@name"];"YFOV"==Tb?Pb=
parseFloat(Sb):"ZNEAR"==Tb?Qb=parseFloat(Sb):"ZFAR"==Tb&&(Rb=parseFloat(Sb))}}else Pb=wb?parseFloat(wb.$):60,Qb=xb?parseFloat(xb.$):0.1,Rb=yb?parseFloat(yb.$):1E3;O.cameras.push({id:Rc,targeted:!1,fov:parseFloat(Pb),nearclip:parseFloat(Qb),farclip:parseFloat(Rb)})}}var nc=Q.library_lights,Ha;if(nc){var Ia=nc.light;Ia&&!Ia.length&&(Ia=[Ia]);var oc={point:"point",directional:"directional",spot:"spot"};if(Ia)for(var Ub=0,Sc=Ia.length;Ub<Sc;Ub++){Ha=Ia[Ub];var pc,nb,zb;for(zb in oc)if(Ha.technique_common[zb]){pc=
zb;nb=Ha.technique_common[zb];break}if(nb){var Tc=oc[pc]||"point",qc=Ha["@id"],rc=nb.intensity,Uc=rc?parseFloat(rc.$):1,sc=nb.distance,Vc=sc?parseFloat(sc.$):10,tc=nb.color,ia=[1,1,1];tc&&(ia=e.floatDelimArray(tc.$," "));O.lights.push({id:qc,name:qc,type:Tc,method:m.light.method.STATIC,diffuse:ia,specular:[0,0,0],distance:Vc,intensity:Uc})}}}var uc=Q.library_visual_scenes;if(uc){var bb=null;(bb=uc.visual_scene)&&!bb.length&&(bb=[bb]);for(var Vb=0,Wc=bb.length;Vb<Wc;Vb++){Sa=bb[Vb];var ya={id:Sa["@id"],
sceneObjects:[],cameras:[],lights:[],parentMap:[]},pa=[],cb=[],za,Wb,la,ba,$,vc=Q.library_nodes;if(vc){var db=vc.node;db&&!db.length&&(db=[db]);pa=[];u=0;for(D=db.length;u<D;u++)Wb=db[u],mnodeId=Wb["@id"],pa[la]=Wb;for(za=[Sa];za.length;){ba=za.pop();if(ba.node&&(($=ba.node)&&!$.length&&($=[$]),$)){u=0;for(D=$.length;u<D;u++)za.push($[u])}if(ba.instance_node){var eb=ba.instance_node;eb&&!eb.length&&(eb=[eb]);u=0;for(D=eb.length;u<D;u++){var Xb=eb[u]["@url"].substr(1);pa[Xb]&&(ba.node&&ba.node.length&&
(ba.node=[ba.node]),ba.node?ba.node.push(pa[Xb]):ba.node=[pa[Xb]])}}}}for(za=[Sa];za.length;)if(ba=za.pop(),ba.node&&(($=ba.node)&&!$.length&&($=[$]),$)){u=0;for(D=$.length;u<D;u++)$[u].parentNode=ba,cb.push($[u]),za.push($[u])}if(cb.length)for(var ob=0,Xc=cb.length;ob<Xc;ob++){var Aa=cb[ob],Ba=Aa.instance_geometry;Ha=cb[ob].instance_light;ha=cb[ob].instance_camera;la=Aa["@id"];var fa=Aa["@name"],ga=b.cl_getInitalTransform(O.up_axis,Aa);2===gb&&(ga.rotation=b.quaternionFilterZYYZ(ga.rotation,ha?[-90,
0,0]:t));var pb=null,X=null,fb;if(Ba){Ba&&!Ba.length&&(Ba=[Ba]);u=0;for(D=Ba.length;u<D;u++)if(q=Ba[u]["@url"].substr(1),X={},X.name=(fa?fa:la)+(u?u:""),X.id=(la?la:fa)+(u?u:""),X.meshId=Xa,X.meshName=q,pb||(X.position=ga.position,X.rotation=ga.rotation,X.scale=ga.scale,X.matrix=ga.matrix),ya.sceneObjects.push(X),pa[X.id]=!0,Aa.parentNode)(fb=Aa.parentNode["@id"])&&pa[fb]?ya.parentMap.push({parent:fb,child:X.id}):1<Ba.length&&(pb?pa[pb.id]&&ya.parentMap.push({parent:pb.id,child:X.id}):(pb=X,X={}))}else if(ha){var Yc=
ha["@url"].substr(1);ya.cameras.push({name:fa?fa:la,id:fa?fa:la,source:Yc,position:ga.position,rotation:ga.rotation})}else if(Ha){var Zc=Ha["@url"].substr(1);ya.lights.push({name:fa?fa:la,id:fa?fa:la,source:Zc,position:ga.position,rotation:ga.rotation||[0,0,0]})}else X={position:ga.position,rotation:ga.rotation,scale:ga.scale,matrix:ga.matrix},X.name=fa?fa:la,X.id=la?la:fa,ya.sceneObjects.push(X),pa[X.id]=!0,Aa.parentNode&&(fb=Aa.parentNode["@id"])&&pa[fb]&&ya.parentMap.push({parent:fb,child:X.id})}O.scenes.push(ya)}}var wc=
Q.library_animations,qa;if(wc){var Ja=wc.animation;Ja&&!Ja.length&&(Ja=[Ja]);if(Ja)for(var Yb=0,$c=Ja.length;Yb<$c;Yb++){var Ab=Ja[Yb];qa=Ab["@id"];O.animations[qa]={};O.animations[qa].sources=[];var Ka=Ab.source;Ka&&!Ka.length&&(Ka=[Ka]);if(Ka.length){K=0;for(N=Ka.length;K<N;K++){var Ca=Ka[K];n=Ca["@id"];var xc=Ca.technique_common,Bb=null,yc=null;Ca.name_array?Bb=e.textDelimArray(Ca.name_array.$," "):Ca.Name_array?Bb=e.textDelimArray(Ca.Name_array.$," "):Ca.float_array&&(yc=e.floatDelimArray(Ca.float_array.$,
" "));var Zb=0,zc="",Cb=1;if(xc){g=xc;var $b=g.accessor,Zb=parseInt($b["@count"],10),zc=$b["@source"].substr(1),Ac=$b["@stride"];Ac&&(Cb=parseInt(Ac,10))}O.animations[qa].sources[n]={data:Bb?Bb:yc,count:Zb,source:zc,stride:Cb};1!==Cb&&(O.animations[qa].sources[n].data=e.repackArray(O.animations[qa].sources[n].data,Cb,Zb))}}(Da=Ab.sampler)&&!Da.length&&(Da=[Da]);if(Da){O.animations[qa].samplers=[];K=0;for(N=Da.length;K<N;K++){var Bc=Da[K],ad=Bc["@id"];(P=Bc.input)&&!P.length&&(P=[P]);if(P){var Cc=
[];y=0;for(D=P.length;y<D;y++)W=P[y],Cc[W["@semantic"]]=W["@source"].substr(1);O.animations[qa].samplers[ad]=Cc}}}var La=Ab.channel;La&&!La.length&&(La=[La]);if(La){O.animations[qa].channels=[];L=0;for(M=La.length;L<M;L++){var Dc=La[L],bd=Dc["@source"].substr(1),Ec=Dc["@target"],Fc=Ec.split("/"),cd=Fc[0],Gc=Fc[1].split(".");O.animations[qa].channels.push({source:bd,target:Ec,targetName:cd,paramName:Gc[0],typeName:Gc[1]})}}}}var Hc=Q.scene;if(Hc&&(Sa=Hc.instance_visual_scene)){var dd=Sa["@url"].substr(1);
O.scene=dd}return O}var t=h.undef,m=h.enums,q=h.GLCore,r=h.log,b={fixuaxis:function(b,a){if(0===b)return[a[1],a[0],a[2]];if(1===b)return a;if(2===b)return[a[0],a[2],-a[1]]},fixscaleaxis:function(b,a){if(0===b)return[a[1],a[0],a[2]];if(1===b)return a;if(2===b)return[a[0],a[2],a[1]]},fixukaxis:function(b,a,c,d){return a===m.motion.POS&&c===m.motion.Z&&b===m.motion.Z?-d:d},getAllOf:function(b,a){for(var c=[b],d=[],e,g,n,o;c.length;)for(g in e=c.pop(),e)if(e.hasOwnProperty(g)){if(g===a)if(e[g].length){n=
0;for(o=e[g].length;n<o;n++)d.push(e[g][n])}else d.push(e[g]);if("object"==typeof e[g])if(e[g].length){n=0;for(o=e[g].length;n<o;n++)c.push(e[g][n])}else c.push(e[g])}return d},quaternionFilterZYYZ:function(b,a){var c=h.vec3,d=b,e=new h.Quaternion;a!==t&&(d=c.add(b,a));e.fromEuler(d[0],d[2],-d[1]);return e.toEuler()},cl_getInitalTransform:function(f,a){var c=h.util,d={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},e=a.translate,g=a.rotate,n=a.scale;if(a.matrix&&!e&&!g&&!n)return d;e&&e.$&&(d.position=
b.fixuaxis(f,c.floatDelimArray(e.$," ")));if(g)for(var e=0,o=g.length;e<o;e++){var m=g[e],q=m["@sid"],m=c.floatDelimArray(m.$," ");if("rotateX"==q||"rotationX"==q)d.rotation[0]=m[3];else if("rotateY"==q||"rotationY"==q)d.rotation[1]=m[3];else if("rotateZ"==q||"rotationZ"==q)d.rotation[2]=m[3]}n&&(d.scale=b.fixscaleaxis(f,c.floatDelimArray(n.$," ")));return d}};return{loadCollada:function(f,a,c){var a=x(f,a,c),d=a.up_axis,e=[],g,n,o,s,r,w,v,C;n=0;for(o=a.materials.length;n<o;n++){r=a.materials[n];
v=new h.Material(r.mat);v.name=r.name||null;w=0;for(s=r.mat.textures_ref.length;w<s;w++){C=r.mat.textures_ref[w];var A=null,A=void 0===h.Textures_ref[C.image]?new h.Texture(C.image,q.default_filter,c,f):h.Textures_obj[h.Textures_ref[C.image]];v.setTexture(A,C.type)}e[r.id]=v}w=[];n=0;for(o=a.meshes.length;n<o;n++){var A=a.meshes[n],B=new h.Mesh({name:A.id});B.points=A.points;var G=!1;v=0;for(C=A.parts.length;v<C;v++){var u=A.parts[v];0!==u.material&&((s=e[u.material])||(s=new h.Material({name:u.material})),
B.setFaceMaterial(s));var y=u.normals.length?!0:!1,D=u.texcoords.length?!0:!1,z=u.colors.length?!0:!1;z&&(e[u.material].color_map=!0);s=0;for(r=u.faces.length;s<r;s++){var F=B.addFace(u.faces[s]);y&&(B.faces[F].point_normals=u.normals[s]);D&&(B.faces[F].uvs=u.texcoords[s]);z&&(B.faces[F].point_colors=u.colors[s])}G|=y}B.faces.length&&(c?c.addMesh(f,f+":"+meshId,B):(G||B.calcNormals(),B.triangulateQuads(),B.compile()),w[A.id]=B)}o=[];f=0;for(s=a.cameras.length;f<s;f++)o[a.cameras[f].id]=a.cameras[f];
A=[];s=0;for(r=a.lights.length;s<r;s++)A[a.lights[s].id]=a.lights[s];c={};e={};n={};f={};v=0;for(C=a.scenes.length;v<C;v++){B=a.scenes[v];G=new h.Scene;s=0;for(r=B.sceneObjects.length;s<r;s++)u=B.sceneObjects[s],y=new h.SceneObject(u),y.obj=(w[u.meshName]?w[u.meshName]:w[u.meshId])||null,u.matrix&&y.setMatrix(u.matrix),c[u.id]=y,G.bindSceneObject(y);s=0;for(r=B.lights.length;s<r;s++)u=B.lights[s],y=new h.Light(A[u.source]),y.position=u.position,y.rotation=u.rotation,e[u.id]=y,G.bindLight(y);B.cameras.length&&
(s=B.cameras[0],r=new h.Camera(o[s.source]),r.position=s.position,r.rotation=s.rotation,n[s.id]=r,G.camera=r);s=0;for(r=B.parentMap.length;s<r;s++)u=B.parentMap[s],c[u.parent].bindChild(c[u.child]);f[B.id]=G}for(var I in a.animations)if(a.animations.hasOwnProperty(I)&&(w=a.animations[I],w.channels.length)){cCount=0;for(s=w.channels.length;cCount<s;cCount++){o=w.channels[cCount];u=w.samplers[o.source];r=w.sources[u.INPUT];v=w.sources[u.OUTPUT];C=w.sources[u.INTERPOLATION];var A=w.sources[u.IN_TANGENT],
B=w.sources[u.OUT_TANGENT],G=u.IN_TANGENT!==t,u=u.OUT_TANGENT!==t,y=null,z=c[o.targetName],D=n[o.targetName],H=e[o.targetName];z?(null===z.motion&&(z.motion=new h.Motion),y=z.motion):D?(null===D.motion&&(D.motion=new h.Motion),y=D.motion):H&&(null===H.motion&&(H.motion=new h.Motion),y=H.motion);if(null!==y){z=m.motion.POS;F=m.motion.X;2===d&&(y.yzflip=!0);g=o.paramName;if("rotateX"===g||"rotationX"===g)z=m.motion.ROT,F=m.motion.X;else if("rotateY"===g||"rotationY"===g)z=m.motion.ROT,F=m.motion.Y;
else if("rotateZ"===g||"rotationZ"===g)z=m.motion.ROT,F=m.motion.Z;else if("location"===g){if(z=m.motion.POS,"X"===o.typeName&&(F=m.motion.X),"Y"===o.typeName&&(F=m.motion.Y),"Z"===o.typeName)F=m.motion.Z}else if("translate"===g){if(z=m.motion.POS,"X"===o.typeName&&(F=m.motion.X),"Y"===o.typeName&&(F=m.motion.Y),"Z"===o.typeName)F=m.motion.Z}else if("LENS"===g)continue;else"FOV"===g?(z=m.motion.FOV,F=3):"ZNEAR"===g?(z=m.motion.NEARCLIP,F=3):"ZFAR"===g?(z=m.motion.FARCLIP,F=3):"intensity"===g&&(z=
m.motion.INTENSITY,F=3);H&&3>z&&(H.method=m.light.method.DYNAMIC);mCount=0;for(o=r.data.length;mCount<o;mCount++)if(k=null,"object"===typeof v.data[mCount]){i=0;for(iMax=v.data[mCount].length;i<iMax;i++)H=i,2===d&&2===i?H=1:2===d&&1===i&&(H=2),k=y.setKey(z,H,r.data[mCount],b.fixukaxis(a.up_axis,z,H,v.data[mCount][i])),C&&(g=C.data[mCount][i],"LINEAR"===g?k.shape=m.envelope.shape.LINE:"BEZIER"===g&&(k.shape=!G&&!u?m.envelope.shape.LINEAR:m.envelope.shape.BEZI))}else if(H=F,ofs=0,D&&z===m.motion.ROT&&
2===d&&0===H&&(ofs=-90),z===m.motion.ROT?k=y.setKey(z,H,r.data[mCount],v.data[mCount]+ofs):(2===d&&2===F?H=1:2===d&&1===F&&(H=2),k=y.setKey(z,H,r.data[mCount],b.fixukaxis(a.up_axis,z,H,v.data[mCount]))),C)if(g=C.data[mCount],"LINEAR"===g)k.shape=m.envelope.shape.LINE;else if("BEZIER"===g)if(!G&&!u)k.shape=m.envelope.shape.LINEAR,k.continutity=1;else{k.shape=m.envelope.shape.BEZ2;g=A.data[mCount][0];var J,L=B.data[mCount][0];z===m.motion.ROT?(J=A.data[mCount][1],H=B.data[mCount][1],k.param[0]=g-k.time,
k.param[1]=J-k.value+ofs,k.param[2]=L-k.time,k.param[3]=H-k.value+ofs):(J=b.fixukaxis(a.up_axis,z,H,A.data[mCount][1]),H=b.fixukaxis(a.up_axis,z,H,B.data[mCount][1]),k.param[0]=g-k.time,k.param[1]=J-k.value,k.param[2]=L-k.time,k.param[3]=H-k.value)}}}}I=null;return I=a.scene?f[a.scene]:f.pop()},parseCollada:x}});
CubicVR.RegisterModule("GML",function(h){function x(m){var h=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(m!==t){var m=h.getXML(m),r=m.getElementsByTagName("header");if(!r.length)return null;var b=r[0],r=m.getElementsByTagName("environment");if(!r.length)return null;this.name=null;b=b.getElementsByTagName("name");b.length&&(this.name=h.collectTextNode(b[0]));b=r[0].getElementsByTagName("screenBounds");b.length&&
(this.bounds=[parseFloat(h.collectTextNode(b[0].getElementsByTagName("x")[0])),parseFloat(h.collectTextNode(b[0].getElementsByTagName("y")[0])),parseFloat(h.collectTextNode(b[0].getElementsByTagName("z")[0]))]);b=r[0].getElementsByTagName("origin");b.length&&(this.origin=[parseFloat(h.collectTextNode(b[0].getElementsByTagName("x")[0])),parseFloat(h.collectTextNode(b[0].getElementsByTagName("y")[0])),parseFloat(h.collectTextNode(b[0].getElementsByTagName("z")[0]))]);r=r[0].getElementsByTagName("up");
r.length&&(this.upvector=[parseFloat(h.collectTextNode(r[0].getElementsByTagName("x")[0])),parseFloat(h.collectTextNode(r[0].getElementsByTagName("y")[0])),parseFloat(h.collectTextNode(r[0].getElementsByTagName("z")[0]))]);m=m.getElementsByTagName("drawing");r=0;for(b=m.length;r<b;r++)for(var f=m[r].getElementsByTagName("stroke"),a=0,c=0,d=0,e=0,g=0,n=f.length;g<n;g++){for(var o=f[g].getElementsByTagName("pt"),s=o.length,E=Array(s),w,v,C,A=0,B=s;A<B;A++)C=o[A],s=parseFloat(h.collectTextNode(C.getElementsByTagName("x")[0])),
w=parseFloat(h.collectTextNode(C.getElementsByTagName("y")[0])),v=parseFloat(h.collectTextNode(C.getElementsByTagName("z")[0])),C=parseFloat(h.collectTextNode(C.getElementsByTagName("time")[0])),1===this.upvector[0]?E[A]=[w!==w?0:w,s!==s?0:-s,v!==v?0:v,C]:1===this.upvector[1]?E[A]=[s!==s?0:s,w!==w?0:w,v!==v?0:v,C]:1===this.upvector[2]&&(E[A]=[s!==s?0:s,v!==v?0:-v,w!==w?0:w,C]),a<s&&(a=s),c<w&&(c=w),d<v&&(d=v),e<C&&(e=C);if(d>e){o=0;for(A=E.length;o<A;o++)s=E[o][3],E[o][3]=E[o][2],E[o][2]=s/this.bounds[2]}this.strokes[g]=
E}}}var t=h.undef;x.prototype={addStroke:function(m,h){var r=[];h===t&&(h=0.1);for(var b=0,f=m.length;b<f;b++){var a=[m[b][0],m[b][1],m[b][2]];this.manual_pos+=h;a.push(this.manual_pos);r.push(a)}this.strokes.push(r)},recenter:function(){var m=CubicVR.vec3,h=[0,0,0],r=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],b,f,a,c;a=0;for(c=this.strokes.length;a<c;a++){b=0;for(f=this.strokes[a].length;b<f;b++)h[0]>this.strokes[a][b][0]&&(h[0]=this.strokes[a][b][0]),h[1]>this.strokes[a][b][1]&&
(h[1]=this.strokes[a][b][1]),h[2]>this.strokes[a][b][2]&&(h[2]=this.strokes[a][b][2]),r[0]<this.strokes[a][b][0]&&(r[0]=this.strokes[a][b][0]),r[1]<this.strokes[a][b][1]&&(r[1]=this.strokes[a][b][1]),r[2]<this.strokes[a][b][2]&&(r[2]=this.strokes[a][b][2])}m=m.multiply(m.subtract(r,h),0.5);a=0;for(c=this.strokes.length;a<c;a++){b=0;for(f=this.strokes[a].length;b<f;b++)this.strokes[a][b][0]-=m[0],this.strokes[a][b][1]-=this.upvector[1]?m[1]:-m[1],this.strokes[a][b][2]-=m[2]}},generateObject:function(m,
h,r,b,f){var a=CubicVR.vec3;m===t&&(m=0);h===t&&(h=0);f===t&&(f=!1);b===t&&(b=0.02);r===t&&(r=0.015);for(var c=0!==h,d=0,e=0,g=new CubicVR.Mesh(this.name),n,o,s,E,w,v,C=0,A=this.strokes.length;C<A;C++){v=new CubicVR.Envelope;var B=new CubicVR.Envelope,x=new CubicVR.Envelope,u=this.strokes[C].length,y=[],D=[],z=0,F=this.strokes[C];for(w=0;w<u;w++){var I=F[w],H=v.addKey(I[3],I[0]),J=B.addKey(I[3],I[1]),L;L=f?x.addKey(I[3],I[2]):x.addKey(I[3],0);H.tension=0.5;J.tension=0.5;L.tension=0.5;0!==w?(n=I[0]-
n,o=I[1]-o,s=I[2]-s,E=I[3]-E,s=Math.sqrt(n*n+o*o+s*s),y[w-1]=s,D[w-1]=E):z=I[3];n=I[0];o=I[1];s=I[2];E=I[3]}u=g.points.length;for(w=0;w<y.length;w++){F=D[w];J=Math.ceil(3*(y[w]/b));I=z;H=z+F;for(J=F/J;I<H-J;I+=J){I===z&&(n=v.evaluate(I),o=B.evaluate(I),s=x.evaluate(I));var M,K;L=v.evaluate(I+J);M=B.evaluate(I+J);K=x.evaluate(I+J);var N=L-n,Y=M-o,ca=K-s;Math.sqrt(N*N+Y*Y+ca*ca);N=a.multiply(a.normalize(a.cross(this.viewvector,a.normalize([N,Y,ca]))),r/2);g.addPoint([n-N[0],-(o-N[1]),s-N[2]+(c?h/2:
0)]);g.addPoint([n+N[0],-(o+N[1]),s+N[2]+(c?h/2:0)]);n=L;o=M;s=K}z+=F}B=g.points.length;if(c){w=u;for(v=B;w<v;w++)g.addPoint([g.points[w][0],g.points[w][1],g.points[w][2]-(c?h/2:0)])}w=0;for(v=B-u;w<=v-4;w+=2){0===d%m&&e++;g.setSegment(e);x=[u+w,u+w+1,u+w+3,u+w+2];g.addFace(x);if(c&&(x=[x[3]+B-u,x[2]+B-u,x[1]+B-u,x[0]+B-u],g.addFace(x),x=[u+w,u+w+2,u+w+2+B-u,u+w+B-u],g.addFace(x),x=[u+w+1+B-u,u+w+3+B-u,u+w+3,u+w+1],g.addFace(x),0===w&&(x=[u+w+B-u,u+w+1+B-u,u+w+1,u+w],g.addFace(x)),w===v-4))x=[u+w+
2,u+w+3,u+w+3+B-u,u+w+2+B-u],g.addFace(x);d++}}g.calcFaceNormals();g.triangulateQuads();g.calcNormals();g.compile();return g}};return{GML:x}});
CubicVR.RegisterModule("PDF",function(){return{PDF:function(h){if(!h.src)throw"PDF Error: you must specify a src url for a PDF.";var x=h.src,t=h.callback||function(){},m,q=[],r=[];this.__defineGetter__("pages",function(){return m?m.numPages:0});this.getPage=function(b){var f=m.numPages,b=1>b?1:b;return q[(b>f?f:b)-1]};this.getPageTexture=function(b,f,a){b=this.getPage(b);f=f||b.width;a=a||b.height;return new CubicVR.PdfTexture(b,{width:f,height:a})};getPdf({url:x,error:function(){console.log("PDF Error: error loading pdf `"+
x+"`")}},function(b){m=new PDFDoc(b);for(var b=1,f=m.numPages;b<=f;b++){var a=m.getPage(b);q.push(a);r.push(a)}t()})}}});
CubicVR.RegisterModule("Particles",function(h){function x(m,h,b,f,a,c,d){m&&(this.last_particle=this.particles=null,this.pTex=b!==t?b:null,this.vWidth=f,this.vHeight=a,this.alpha=c!==t?c:!1,this.alphaCut=d!==t?d:0,this.pfunc=function(a,c){var b=c-a.start_time;if(0>b)return 0;if(b>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+b*a.velocity[0]+b*b*a.accel[0];a.pos[1]=a.startpos[1]+b*a.velocity[1]+b*b*a.accel[1];a.pos[2]=a.startpos[2]+b*a.velocity[2]+b*b*a.accel[2];null!==this.pgov&&this.pgov(a,
c);return 1},this.pgov=null,this.hasColor=h===t?!1:h,b=null!==this.pTex,this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",b?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",b?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",b?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n"),this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",b?"uniform sampler2D pMap;":"","varying vec4 color;",b?"varying vec2 screenPos;":"",b?"uniform vec3 screenDim;":"",b?"varying float pSize;":"","void main(void) {\nvec4 c = color;",b?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",b?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",b?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n"),this.maxPoints=m,this.numParticles=0,this.arPoints=new Float32Array(3*m),this.glPoints=null,h&&(this.arColor=new Float32Array(3*m),this.glColor=null),this.shader_particle=new CubicVR.Shader(this.vs,this.fs),this.shader_particle.use(),this.shader_particle.addVertexArray("aVertexPosition"),
this.hasColor&&this.shader_particle.addVertexArray("aColor"),this.shader_particle.addMatrix("uMVMatrix"),this.shader_particle.addMatrix("uPMatrix"),null!==this.pTex&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[f,a,0])),this.genBuffer())}var t=h.undef,m=h.GLCore;x.prototype={resizeView:function(m,h){this.vWidth=m;this.vHeight=h;null!==this.pTex&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[m,h,0]))},addParticle:function(m){null===this.last_particle?this.particles=m:this.last_particle.nextParticle=m;this.last_particle=m},genBuffer:function(){var h=m.gl;this.glPoints=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,this.glPoints);h.bufferData(h.ARRAY_BUFFER,this.arPoints,h.DYNAMIC_DRAW);this.hasColor&&(this.glColor=h.createBuffer(),h.bindBuffer(h.ARRAY_BUFFER,this.glColor),h.bufferData(h.ARRAY_BUFFER,this.arColor,h.DYNAMIC_DRAW))},updatePoints:function(){var h=m.gl;h.bindBuffer(h.ARRAY_BUFFER,
this.glPoints);h.bufferData(h.ARRAY_BUFFER,this.arPoints,h.DYNAMIC_DRAW)},updateColors:function(){var h=m.gl;this.hasColor&&(h.bindBuffer(h.ARRAY_BUFFER,this.glColor),h.bufferData(h.ARRAY_BUFFER,this.arColor,h.DYNAMIC_DRAW))},draw:function(h,r,b){var f=m.gl;this.shader_particle.use();null!==this.pTex&&this.pTex.use(f.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",h);this.shader_particle.setMatrix("uPMatrix",r);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null);f.bindBuffer(f.ARRAY_BUFFER,this.glPoints);
f.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,f.FLOAT,!1,0,0);f.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(f.bindBuffer(f.ARRAY_BUFFER,this.glColor),f.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,f.FLOAT,!1,0,0),f.enableVertexAttribArray(this.shader_particle.uniforms.aColor));if(b!==t){this.numParticles=0;if(null===this.particles){f.disable(f.BLEND);return}for(var h=this.particles,r=null,a=0;null!==h;){var c=3*this.numParticles,
d=this.pfunc(h,b);if(1===d){if(this.arPoints[c]=h.pos[0],this.arPoints[c+1]=h.pos[1],this.arPoints[c+2]=h.pos[2],null!==h.color&&this.arColor!==t&&(this.arColor[c]=h.color[0],this.arColor[c+1]=h.color[1],this.arColor[c+2]=h.color[2]),this.numParticles++,a++,this.numParticles===this.maxPoints)break}else-1===d?null!==r&&(r.nextParticle=h.nextParticle):0===d&&a++;r=h;h=h.nextParticle}a||(this.last_particle=this.particles=null);this.updatePoints();this.hasColor&&this.updateColors()}this.alpha&&(f.enable(f.BLEND),
f.enable(f.DEPTH_TEST),f.depthMask(0),f.blendFunc(f.ONE,f.ONE_MINUS_SRC_COLOR));f.drawArrays(f.POINTS,0,this.numParticles);this.alpha&&(f.disable(f.BLEND),f.depthMask(1),f.blendFunc(f.ONE,f.ONE));this.hasColor&&f.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}};return{ParticleSystem:x,Particle:function(h,m,b,f,a){this.startpos=new Float32Array(h);this.pos=new Float32Array(h);this.velocity=new Float32Array(f!==t?f:[0,0,0]);this.accel=new Float32Array(a!==t?a:[0,0,0]);this.start_time=
m!==t?m:0;this.life_time=b!==t?b:0;this.nextParticle=this.color=null}}});
CubicVR.RegisterModule("Lines",function(h){function x(h){h=h||{};this.color=h.color||[1,1,1];this.maxPoints=h.maxPoints||1024;this.vs="#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvoid main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);\ngl_Position = position;\n}";this.fs="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 color;\nvoid main(void) {\nvec4 c = vec4(color,1.0);\ngl_FragColor = c;\n}";this.arLines=
new Float32Array(6*this.maxPoints);this.glLines=null;this.lineLength=0;this.shader_line=new CubicVR.Shader(this.vs,this.fs);this.shader_line.use();this.shader_line.addVertexArray("aVertexPosition");this.shader_line.addVector("color",this.color);this.shader_line.addMatrix("uMVMatrix");this.shader_line.addMatrix("uPMatrix");this.genBuffer();this.newSegment=!1}var t=h.GLCore;x.prototype={genBuffer:function(){var h=t.gl;this.glLines=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,this.glLines);h.bufferData(h.ARRAY_BUFFER,
this.arLines,h.DYNAMIC_DRAW)},update:function(){var h=t.gl;h.bindBuffer(h.ARRAY_BUFFER,this.glLines);h.bufferData(h.ARRAY_BUFFER,this.arLines,h.DYNAMIC_DRAW)},addPoint:function(h){var q=this.lineLength;1<q&&(this.arLines[3*q]=this.arLines[3*(q-1)],this.arLines[3*q+1]=this.arLines[3*(q-1)+1],this.arLines[3*q+2]=this.arLines[3*(q-1)+2],this.lineLength++,q++);this.arLines[3*q]=h[0];this.arLines[3*q+1]=h[1];this.arLines[3*q+2]=h[2];this.lineLength++},addSegment:function(h){var q=this.lineLength;this.arLines[3*
q]=h[0];this.arLines[3*q+1]=h[1];this.arLines[3*q+2]=h[2];this.lineLength++},clear:function(){this.lineLength=0},render:function(h){var q=t.gl,r=h.mvMatrix,h=h.pMatrix;this.shader_line.use();this.shader_line.setMatrix("uMVMatrix",r);this.shader_line.setMatrix("uPMatrix",h);this.shader_line.setVector("color",this.color);q.bindBuffer(q.ELEMENT_ARRAY_BUFFER,null);q.bindBuffer(q.ARRAY_BUFFER,this.glLines);q.vertexAttribPointer(this.shader_line.uniforms.aVertexPosition,3,q.FLOAT,!1,0,0);q.enableVertexAttribArray(this.shader_line.uniforms.aVertexPosition);
q.drawArrays(q.LINES,0,this.lineLength)}};return{Lines:x}});
CubicVR.RegisterModule("HeightField",function(h){var x=h.undef,t=h.enums;t.heightfield={brush:{SINE:0,SQUARE:1},op:{ADD:0,REPLACE:1,SUBTRACT:2}};var m=function(b){b=b||{};this.operation=h.parseEnum(t.draw.op,b.operation||b.op)||t.draw.op.REPLACE;this.brushType=h.parseEnum(t.draw.brush,b.brushType)||t.draw.brush.SINE;this.brushSize=b.size||5;this.strength=b.strength||1};m.prototype={setOperation:function(b){this.operation=h.parseEnum(t.draw.op,b)},getOperation:function(){return this.operation},setBrushType:function(b){this.brushType=
h.parseEnum(t.draw.brush,b)||t.draw.brush.SINE},getBrushType:function(){return this.brushType},setSize:function(b){this.brushSize=b},getSize:function(){return this.brushSize},setStrength:function(b){this.strength=b},getStrength:function(){return this.strength}};var q=function(b){b=b||{};this.divX=b.divX||null;this.divZ=b.divZ||null;this.size=b.size||null;this.cellSize=this.sizeZ=this.sizeX=this.cellSize=this.hfFloatBuffer=this.hfUInt8Buffer=this.hfBuffer=null;this.ofsX=b.ofsX||-this.cellSize/2;this.ofsZ=
b.ofsZ||-this.cellSize/2;this.divX&&(this.divZ&&this.size)&&this.initBuffer(this.divX,this.divZ,this.size);this.areaBuffered=!1;this.drawArea={startX:0,startZ:0,endX:0,endZ:0}};q.prototype={initBuffer:function(b,f,a){this.hfBuffer=new ArrayBuffer(4*b*f);this.hfUInt8Buffer=new Uint8Array(this.hfBuffer);this.hfFloatBuffer=new Float32Array(this.hfBuffer);this.divX=b||null;this.divZ=f||null;this.size=a||null;this.divX>this.divZ?(this.sizeX=a,this.sizeZ=a/this.divX*this.divZ):(this.sizeX=this.divZ>this.divX?
a/this.divZ*this.divX:a,this.sizeZ=a);this.drawBuffer=[];this.cellSize=this.sizeX/this.divX;this.startX=-(this.sizeX/2)+this.ofsX;this.startZ=-(this.sizeZ/2)+this.ofsZ},setBrush:function(b){this.brush=b},getBrush:function(){return this.brush},draw:function(b,f,a){var c=this.brush||a,a=c.getOperation(),d=c.getSize(),e=c.getBrushType(),c=c.getStrength();if(this.areaBuffered){var g=b-d,n=f-d,h=b+d,m=f+d;g<this.drawArea.startX&&(this.drawArea.startX=g);n<this.drawArea.startZ&&(this.drawArea.startZ=n);
h>this.drawArea.endX&&(this.drawArea.endX=h);h>this.drawArea.endX&&(this.drawArea.endZ=m)}else this.drawArea={startX:b-d,startZ:f-d,endX:b+d,endZ:f+d},this.areaBuffered=!0;this.drawBuffer.push([b,f,a,d,e,c])},getDrawArea:function(){return!this.areaBuffered?!1:this.drawArea},clearDrawArea:function(){this.areaBuffered=!1},flush:function(){if(!this.drawBuffer.length)return!1;for(;this.drawBuffer.length;){var b=this.drawBuffer.pop();this.drawFunc(b[0],b[1],b[2],b[3],b[4],b[5])}return!0},needsFlush:function(){return 0!==
this.drawBuffer.length},drawFunc:function(b,f,a,c,d,e){for(var a=this.hfFloatBuffer,d=this.divX,g=this.divZ,c=c/this.cellSize,b=(b-this.startX)/this.cellSize,f=(f-this.startZ)/this.cellSize,n=parseInt(Math.floor(b-c),10),h=parseInt(Math.ceil(b+c),10);n<h;n++)for(var m=n-b,q=parseInt(Math.floor(f-c),10),r=parseInt(Math.ceil(f+c),10);q<r;q++)if(!(0>n||n>=d||0>q||q>=g)){var v=q-f,v=e*((1-Math.sqrt(m*m+v*v)/c)/2);0>v&&0<=e&&(v=0);0<v&&0>=e&&(v=0);a[q*d+n]+=v}},getUint8Buffer:function(){return this.hfUInt8Buffer},
getFloat32Buffer:function(){return this.hfFloatBuffer},getDivX:function(){return this.divX},getDivZ:function(){return this.divZ},getSizeX:function(){return this.sizeX},getSizeZ:function(){return this.sizeZ},getStartX:function(){return this.startX},getStartZ:function(){return this.startZ},getCellSize:function(){return this.cellSize},getSize:function(){return this.size},setRect:function(b){var b=b||{},f=b.value||0,a=b.src||b.func||null,c=b.startX||0,d=b.startZ||0,e=b.walkX,g=b.walkZ,b=this.hfFloatBuffer,
n,h=this.startX,m=this.startZ;if(c!==x&&d!==x&&e!==x&&g!==x){if(!(c>=this.divX)&&!(d>=this.divZ)&&(c+e>=this.divX&&(e=this.divX-1-c),d+g>=this.divZ&&(g=this.divZ-1-d),!(0>=e||0>=g))){n=c;for(c+=e;n<c;n++)for(var e=d,q=d+g;e<q;e++){var r=n+e*this.divX;b[r]=null===a?f:a(this.cellSize*n+h,this.cellSize*e+m,r)}}}else{n=0;for(c=this.hfFloatBuffer.length;n<c;n++)null===a?b[n]=f:(d=a(n%this.divX*this.cellSize+h,Math.floor(n/this.divX)*this.cellSize+m,n),b[n]=d)}},getIndicesAt:function(b,f){if("object"===
typeof b)return this.getIndicesAt(b[0],b[2]);var a=this.startX,c=this.startZ,d=Math.floor((b-a)/this.cellSize),e=Math.floor((f-c)/this.cellSize);if(0>d||d>=this.divX-1||0>e||e>=this.divZ-1)return-1;if(1<=Math.abs(f-((e+1)*this.cellSize+c))/Math.abs(b-(d*this.cellSize+a)))return a=[d+(e+1)*this.divX,d+1+e*this.divX,d+e*this.divX],[d,e,a,0];a=[d+(e+1)*this.divX,d+1+(e+1)*this.divX,d+1+e*this.divX];return[d,e,a,1]},getHeightValue:function(b,f){var a=h.triangle;if("object"===typeof b)return this.getHeightValue(b[0],
b[2]);var c=this.getIndicesAt(b,f);if(-1===c)return 0;var d=c[2],e=c[0]*this.cellSize+this.startX,g=c[1]*this.cellSize+this.startZ,n;n=0===c[3]?a.normal([e,this.hfFloatBuffer[d[0]],g+this.cellSize],[e+this.cellSize,this.hfFloatBuffer[d[1]],g],[e,this.hfFloatBuffer[d[2]],g]):a.normal([e,this.hfFloatBuffer[d[0]],g+this.cellSize],[e+this.cellSize,this.hfFloatBuffer[d[1]],g+this.cellSize],[e+this.cellSize,this.hfFloatBuffer[d[2]],g]);a=n[0];c=n[1];n=n[2];d=[e,this.hfFloatBuffer[d[0]],g+this.cellSize];
return(a*b+n*f+(-(a*d[0])-c*d[1]-n*d[2]))/-c},rayIntersect:function(b,f){var a=b.slice(0),c=this.startX,d=this.startZ,e=this.startX+this.sizeX,g=this.startZ+this.sizeZ,n=this.cellSize,o=h.vec2,m=h.vec3,q=m.normalize(f),r=[q[0],q[2]],v=[a[0],a[2]];if(a[0]<c||a[0]>e||a[2]<d||a[2]>g){var C=[[c,d],[e,d],[c,g],[e,g]],A=[];a[0]>=e&&A.push([C[1],C[3]]);a[0]<=c&&A.push([C[0],C[2]]);a[2]>=g&&A.push([C[2],C[3]]);a[2]<=d&&A.push([C[0],C[1]]);if(0!==A.length){a=[];e=0;for(g=A.length;e<g;e++)C=o.lineIntersect(v,
o.add(v,r),A[e][0],A[e][1]),!1!==C&&o.onLine(A[e][0],A[e][1],C)&&a.push(C);C=0;A=-1;e=0;for(g=a.length;e<g;e++){var B=o.length(a[e],v);0===e?(C=B,A=0):B<C&&(A=e,C=B)}if(-1!=A){if(u=C/o.length(r),a=[a[A][0],0,a[A][1]],a[1]=b[1]+q[1]*u,a[1]<=this.getHeightValue(a[0],a[2]))return!1}else return!1}v=[a[0],a[2]]}C=Math.floor((v[0]-c)/n);g=Math.floor((v[1]-d)/n);A=v[0]-(c+C*n);e=v[1]-(d+g*n);e=A<e?A/Math.abs(r[0]):e/Math.abs(r[1]);0===e?(A=v[0],e=v[1]):(A=v[0]+e*r[0],e=v[1]+e*r[1]);for(var C=A-(c+C*n),B=
e-(d+g*n),g=0<=r[0]?C:n-C,C=0<=r[1]?B:n-B,B=this.getFloat32Buffer(),t,u;;){var y=(n-g)/Math.abs(r[0]),x=(n-C)/Math.abs(r[1]),y=y<x?y:x;t=r[0]*y;var z=r[1]*y,g=g+Math.abs(t),C=C+Math.abs(z),y=(A+(A+t))/2,x=(e+(e+z))/2,A=A+t,e=e+z,y=Math.floor((y-c)/n),x=Math.floor((x-d)/n);if(g>=n)for(;g>=n;)g-=n;if(C>=n)for(;C>=n;)C-=n;u=o.length(v,[A,e])/o.length(r);t=o.length(v,[A-t,e-z])/o.length(r);u=a[1]+q[1]*u;t=a[1]+q[1]*t;if(y>this.divX||0>y||x>this.divZ||0>x)return!1;var z=B[x*this.divX+y],F=B[x*this.divX+
y+1],I=B[(x+1)*this.divX+y],H=B[(x+1)*this.divX+y+1];if(0>=u-z||0>=u-F||0>=u-I||0>=u-H||0>=t-z||0>=t-F||0>=t-I||0>=t-H){F=[y+(x+1)*this.divX,y+1+x*this.divX,y+x*this.divX];z=[y+(x+1)*this.divX,y+1+(x+1)*this.divX,y+1+x*this.divX];u=c+n*y;t=d+n*x;tmpNormA=h.triangle.normal([u,B[F[0]],t+n],[u+n,B[F[1]],t],[u,B[F[2]],t]);tmpNormB=h.triangle.normal([u,B[z[0]],t+n],[u+n,B[z[1]],t+n],[u+n,B[z[2]],t]);F=m.linePlaneIntersect(tmpNormA,[u,B[F[0]],t+n],a,m.add(a,q));y=Math.abs(d+(x+1)*n-F[0])/Math.abs(c+y*n-
F[2]);if(1<=y&&F[0]>=u-1.0E-8&&F[0]<=u+n+1.0E-8&&F[2]>=t-1.0E-8&&F[2]<=t+1.0E-8+n)return F;x=m.linePlaneIntersect(tmpNormB,[u,B[z[0]],t+n],a,m.add(a,q));if(1>y&&x[0]>=u-1.0E-8&&x[0]<=u+n+1.0E-8&&x[2]>=t-1.0E-8&&x[2]<=t+n+1.0E-8)return x}}}};var r=h.extendClassGeneral(h.Mesh,function(b){b=b||{};b.dynamic=!0;b.buildWireframe=!0;this.material=b.material;this._update=h.Mesh.prototype.update;h.Mesh.apply(this,[b]);this.hField=b.hField||null;this.divX=b.divX||null;this.divZ=b.divZ||null;this.viewX=b.viewX||
0;this.viewZ=b.viewZ||0;this.ofsX=b.ofsX||0;this.ofsZ=b.ofsZ||0;this.edgeX=b.edgeX||0;this.edgeZ=b.edgeZ||0;this.normalBuffer=[];this.genHeightfieldMesh()},{setIndexedHeight:function(b,f,a){this.points[b+f*this.divX][1]=a},genHeightfieldMesh:function(){var b,f,a=this.divX+this.edgeX,c=this.divZ+this.edgeZ,d=this.hField.getCellSize(),e=d*this.divX;b=d*this.divZ;0!==this.points.length&&this.clean();var g=-(b/2);for(f=0;f<c;f++){var n=-(e/2);for(b=0;b<a;b++)this.addPoint([n+this.ofsX,0,g+this.ofsZ]),
n+=d;g+=d}this.setFaceMaterial(this.material);b=-1/(a-1);f=1/(c-1);for(e=g=0;e<c-1;e++){n=1;for(d=0;d<a-1;d++)f1=this.addFace([d+(e+1)*a,d+1+e*a,d+e*a]),f2=this.addFace([d+(e+1)*a,d+1+(e+1)*a,d+1+e*a]),this.faces[f1].uvs=[[n,g+f],[n+b,g],[n,g]],this.faces[f2].uvs=[[n,g+f],[n+b,g+f],[n+b,g]],n+=b;g+=f}},recalcNormals:function(b){var f;if(b=b||this.normalMapRef){var b=this.divX+this.edgeX,a=this.divZ+this.edgeZ;if(!this.normalBuffer.length){for(f=0;f<this.points.length;f++)this.normalBuffer.push([0,
1,0]);var c=0;for(f=0;f<a-1;f++)for(k=0;k<b-1;k++)this.faces[c++].point_normals=[this.normalBuffer[k+(f+1)*b],this.normalBuffer[k+1+f*b],this.normalBuffer[k+f*b]],this.faces[c++].point_normals=[this.normalBuffer[k+(f+1)*b],this.normalBuffer[k+1+(f+1)*b],this.normalBuffer[k+1+f*b]]}a=this.hField;c=a.getFloat32Buffer();f=this.viewX||0;var d=(this.viewZ||0)*a.getDivX()+f;for(f=0;f<this.points.length;f++){var e=f%b,g=Math.floor(f/b),n=d+e+(g-1)*a.getDivX(),o=d+e+(g+1)*a.getDivX(),m=d+(e+1)+g*a.getDivX(),
q=d+(e-1)+g*a.getDivX(),e=d+e+g*a.getDivX(),n=c[n],o=c[o],m=c[m],q=c[q],e=c[e];n===x&&(n=e);o===x&&(o=e);m===x&&(m=e);q===x&&(q=e);q=h.vec3.normalize([(m-e+(e-q))/2,2,(n-e+(e-o))/2]);this.normalBuffer[f][0]=q[0];this.normalBuffer[f][1]=q[1];this.normalBuffer[f][2]=q[2]}return this}},update:function(){var b=this.viewX||0,f=this.viewZ||0,a=this.divX+this.edgeX,c=this.divZ+this.edgeZ,d=this.hField.getDivX();this.hField.getDivZ();for(var e=this.hField.getFloat32Buffer(),g=f,c=f+c;g<c;g++)for(var n=b,
h=b+a;n<h;n++)this.points[(g-f)*a+(n-b)][1]=e[g*d+n];this._update()}});return{HeightField:q,HeightFieldBrush:m,HeightFieldMesh:r}});
CubicVR.RegisterModule("Landscape",function(h){var x=h.undef,t=Math.PI/2;return{Landscape:h.extendClassGeneral(h.SceneObject,function(){if(1<arguments.length)this.hField=new h.HeightField({size:arguments[0],divX:arguments[1],divZ:arguments[2]}),this.hfMesh=new h.HeightFieldMesh({hField:this.hField,size:arguments[0],divX:arguments[1],divZ:arguments[2],material:arguments[3],ofsX:this.hField.getCellSize()/2,ofsZ:this.hField.getCellSize()/2}),this.hfMesh.prepare(),h.SceneObject.apply(this,[{mesh:this.hfMesh,
shadowCast:!1}]);else{var m=arguments[0]||{};this.size=m.size||128;this.divX=m.divX||128;this.divZ=m.divZ||128;this.tiles=[];this.tileMeshes=[];this.tileMaterials=[];this.tileSpats=[];this.tileX=m.tileX||this.divX;this.tileZ=m.tileZ||this.divZ;this.tileChanged=[];this.tileSpatChanged=[];this.hField=new h.HeightField({size:this.size,divX:this.divX,divZ:this.divZ});this.divX>this.divZ?(this.sizeX=this.size,this.sizeZ=this.size/this.divX*this.divZ):(this.sizeX=this.divZ>this.divX?this.size/this.divZ*
this.divX:this.size,this.sizeZ=this.size);this.cellSize=this.sizeX/this.divX;this.tileSize=this.cellSize*this.tileX;this.spatResolution=m.spatResolution||256;this.spats=m.spats||[];this.sourceSpats=m.spats.slice(0);h.SceneObject.apply(this,[{mesh:null,shadowCast:!1}]);for(var q=0,r=0,b=0;b<this.divZ;b+=this.tileZ){for(var f=q=0;f<this.divX;f+=this.tileX){var a=new h.DrawBufferTexture({width:this.spatResolution,height:this.spatResolution}),c=f+1!=this.tileX?1:0,d=b+1!=this.tileZ?1:0,e=new h.SpatMaterial({color:[1,
1,1],specular:[0.05,0.05,0.05],spats:this.sourceSpats,sourceTexture:a,spatResolution:this.spatResolution,spatOffset:[this.divX/(this.divX+c),this.divZ/(this.divZ+d),1]}),c=new h.HeightFieldMesh({hField:this.hField,size:this.tileSize,divX:this.tileX,divZ:this.tileZ,viewX:f,viewZ:b,edgeX:c,edgeZ:d,material:e});c.prepare();var d=new h.SceneObject({mesh:c}),g=this.hField.getStartX(),n=this.hField.getStartZ();d.position[0]=g+this.tileSize*q+this.tileSize/2;d.position[2]=n+this.tileSize*r+this.tileSize/
2;this.bindChild(d);this.tiles.push(d);this.tileMeshes.push(c);this.tileMaterials.push(e);this.tileSpats.push(a);this.tileChanged.push(!1);this.tileSpatChanged.push(!1);q++}r++}m.jsonData&&this.loadFromJSON(m,m.compress||!1)}},{loadFile:function(h){var q=new FileReader;q.onload=function(h){return function(b){b=JSON.parse(b.target.result);h.loadFromJSON(b,b.compress)}}(this);q.readAsText(h)},loadFromJSON:function(h,q){var q=q||h.compress,r=this.tileSpats,b=h.jsonData.tiles;if(q){h.jsonData.heightfield=
Iuppiter.decompress(Iuppiter.Base64.decode(Iuppiter.toByteArray(h.jsonData.heightfield),!0)).split(",");i=0;for(iMax=b.length;i<iMax;i++)b[i]=Iuppiter.decompress(Iuppiter.Base64.decode(Iuppiter.toByteArray(b[i]),!0)).split(",")}var f=this.hField.getUint8Buffer(),a=h.jsonData.heightfield;i=0;for(iMax=f.length;i<iMax;i++)f[i]=parseInt(a[i],10);i=0;for(iMax=b.length;i<iMax;i++){for(var f=b[i],a=r[i].getUint8Buffer(),c=0,d=f.length;c<d;c++)a[c]=parseInt(f[c],10);console.log(f);this.tileChanged[i]=!0;
this.tileSpatChanged[i]=!0}this.update()},saveToJSON:function(h,q){var h=h!==x?h:!0,q=q!==x?q:!1,r,b,f={divX:this.divX,divZ:this.divZ,tileX:this.tileX,tileZ:this.tileZ,spats:this.spats,spatResolution:this.spatResolution,compress:h,size:this.size,jsonData:{heightfield:[],tiles:[]}},a=this.hField.getUint8Buffer(),c=f.jsonData.heightfield;r=0;for(b=a.length;r<b;r++)c[r]=a[r];a=this.tileSpats;c=f.jsonData.tiles;r=0;for(b=a.length;r<b;r++){c[r]=[];for(var d=c[r],e=a[r].getUint8Buffer(),g=0,n=e.length;g<
n;g++)d[g]=e[g]}if(h){f.jsonData.heightfield=Iuppiter.Base64.encode(Iuppiter.compress(f.jsonData.heightfield.join(",")),!0);r=0;for(b=c.length;r<b;r++)f.jsonData.tiles[r]=Iuppiter.Base64.encode(Iuppiter.compress(c[r].join(",")),!0)}r=JSON.stringify(f);if(q)uriContent="data:text/x-download;charset=utf-8,"+encodeURIComponent(r),window.location.href=uriContent;else return r},update:function(){var h,q;this.hField.needsFlush()&&this.hField.flush();h=this.hField.getDrawArea();if(!1!==h){var r=this.getTileAt(h.startX-
this.cellSize,h.startZ-this.cellSize,h.endX-h.startX+this.cellSize,h.endZ-h.startZ,this.cellSize);!1!==r&&r.length===x&&(r=[r]);h=0;for(q=r.length;h<q;h++)this.tileChanged[r[h]]=!0;this.hField.clearDrawArea()}h=0;for(q=this.tiles.length;h<q;h++)if(this.tileChanged[h]&&(this.tileMeshes[h].update(),this.tileChanged[h]=!1),this.tileSpatChanged[h])this.tileSpats[h].update(),this.tileSpatChanged[h]=!1},getHeightField:function(){return this.hField},mapGen:function(h,q,r,b,f){this.hField.setRect({src:h,
startX:q,startZ:r,walkX:b,walkZ:f});this.hfMesh.update()},getFaceAt:function(h,q){return this.hField.getFaceAt([h,0,q])},getHeightValue:function(h,q){return this.hField.getHeightValue([h,0,q])},orient:function(h,q,r,b,f,a){a===x&&(a=0);var c,d,e=[];c=r/2;var g=b/2;d=Math.sqrt(g*g+c*c);g=Math.atan2(g,c);f*=Math.PI/180;c=h+Math.sin(f)*a;a=q+Math.cos(f)*a;e[0]=this.getHeightValue([c+d*Math.cos(-g-t+f),0,a+d*-Math.sin(-g-t+f)]);e[1]=this.getHeightValue([c+d*Math.cos(g-t+f),0,a+d*-Math.sin(g-t+f)]);e[2]=
this.getHeightValue([c+d*Math.cos(-g+t+f),0,a+d*-Math.sin(-g+t+f)]);e[3]=this.getHeightValue([c+d*Math.cos(g+t+f),0,a+d*-Math.sin(g+t+f)]);d=-Math.atan2(e[1]-e[2],r);a=-Math.atan2(e[0]-e[1],b);d+=-Math.atan2(e[0]-e[3],r);a+=-Math.atan2(e[3]-e[2],b);return[[h,(e[2]+e[3]+e[1]+e[0])/4,q],[d/2*(180/Math.PI),f,a/2*(180/Math.PI)]]},getTileAt:function(h,q,r,b){var r=r||0,b=b||0,f=this.hField.getStartX(),a=this.hField.getStartZ(),c=Math.floor(this.divX/this.tileX),d=Math.floor((h-f)/(this.tileX*this.tileSize)*
this.tileX),e=Math.floor((q-a)/(this.tileZ*this.tileSize)*this.tileZ),g=0;if(0===r&&0===b)return g=parseInt(d+e*c,10);h=Math.floor((h+r-f)/(this.tileX*this.tileSize)*this.tileX);q=Math.floor((q+b-a)/(this.tileZ*this.tileSize)*this.tileZ);for(b=[];e<=q;e++)for(a=d;a<=h;a++)g=e*(this.divX/this.tileX)+a,0<=g&&g<this.tiles.length&&b.push(g);return b},getSpatLocation:function(h,q,r){if(r===x)h=(1-(h/this.getHeightField().getSize()+0.5))*this.spatResolution*(this.divX/this.tileX)%this.spatResolution,q=
(1-(q/this.getHeightField().getSize()+0.5))*this.spatResolution*(this.divZ/this.tileZ)%this.spatResolution;else var b=this.divX/this.tileX,f=r%b,b=Math.floor(r/b),r=this.hField.getStartX(),b=this.hField.getStartZ()+b*this.tileSize,h=(1-(h-(r+f*this.tileSize))/this.tileSize)*this.spatResolution,q=(1-(q-b)/this.tileSize)*this.spatResolution;return{x:h,z:q}},drawSpat:function(h,q,r){var b=r.getSize()*(this.size/this.spatResolution),f=h-b/2,a=q-b/2,b=this.getTileAt(f,a,h+b/2-f,q+b/2-a);!1!==b&&b.length===
x&&(b=[b]);if(!1!==b){f=0;for(a=b.length;f<a;f++){var c=b[f],d=this.getSpatLocation(h,q,c);0<=c&&c<this.tileSpats.length&&(this.tileSpats[c].draw(d.x,d.z,r),this.tileSpatChanged[c]=!0)}}}})}});
CubicVR.RegisterModule("SpatMaterial",function(h){var x=h.undef,t;return{SpatMaterial:h.extendClassGeneral(h.Material,function(m){m=m||{};t||(t=new h.Texture);this.spats=m.spats||[t,t,t,t,t];this.sourceTex=m.sourceTexture||t;this.spatResolution=m.spatResolution||256;this.spatTexel=1/this.spatResolution;var q=this.spats,r;for(r in q){var b=q[r];"string"===typeof b&&(q[r]=h.Textures_ref[b]!==x?h.Textures_obj[h.Textures_ref[b]]:new h.Texture(b))}this.spatOffset=m.spatOffset||[1,1,1];this.spatShader=
new h.CustomShader({vertex:"void main(void) {\n  vertexTexCoordOut = cubicvr_texCoord();\n  gl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n  #if !LIGHT_DEPTH_PASS  // not needed if shadowing \n    vertexNormalOut = matrixNormal * cubicvr_normal();\n    cubicvr_lighting();\n  #endif // !LIGHT_DEPTH_PASS \n}",fragment:"uniform sampler2D spatImage;\nuniform sampler2D spat0;\nuniform sampler2D spat1;\nuniform sampler2D spat2;\nuniform sampler2D spat3;\nuniform sampler2D spat4;\nuniform vec3 spatOffset;\nuniform float spatTexel;\nvoid main(void) \n{  \nvec2 texCoord = cubicvr_texCoord();\nvec2 spatTexCoord = texCoord*30.0;\nvec4 color = texture2D(spat0,spatTexCoord);\nvec2 spatSourceCoord = vec2(texCoord.x*spatOffset.x,texCoord.y*spatOffset.y);\nif (spatSourceCoord.s<=spatTexel/2.0) {\n   spatSourceCoord.s=spatTexel/2.0;\n}\nif (spatSourceCoord.s>=1.0-spatTexel/2.0) {\n   spatSourceCoord.s=1.0-spatTexel/2.0;\n}\nif (spatSourceCoord.t<=spatTexel/2.0) {\n   spatSourceCoord.t=spatTexel/2.0;\n}\nif (spatSourceCoord.t>=1.0-spatTexel/2.0) {\n   spatSourceCoord.t=1.0-spatTexel/2.0;\n}\nvec4 spatSource = texture2D(spatImage,spatSourceCoord);\ncolor = mix(color,texture2D(spat1,spatTexCoord),spatSource.r);\ncolor = mix(color,texture2D(spat2,spatTexCoord),spatSource.g);\ncolor = mix(color,texture2D(spat3,spatTexCoord),spatSource.b);\ncolor = mix(color,texture2D(spat4,spatTexCoord),spatSource.a);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n}",
init:function(){},update:function(b){return function(a,c){var d=c.textureIndex;a.spatImage.set(d++,b.sourceTex);a.spatOffset.set(b.spatOffset);a.spatTexel.set(b.spatTexel);q[0]&&a.spat0.set(d++,q[0]);q[1]&&a.spat1.set(d++,q[1]);q[2]&&a.spat2.set(d++,q[2]);q[3]&&a.spat3.set(d++,q[3]);q[4]&&a.spat4.set(d++,q[4])}}(this)});m.shader=this.spatShader;h.Material.apply(this,[m])},{setSpats:function(h){this.spats=h},getSpats:function(){return this.spats},setSource:function(h){this.sourceTexture=h}})}});
CubicVR.RegisterModule("Octree",function(h){function x(a,b,e,g,f){var o=this._children=[];this._dirty=!1;o[0]=null;o[1]=null;o[2]=null;o[3]=null;o[4]=null;o[5]=null;o[6]=null;o[7]=null;this._child_index=f||-1;this._root=e||null;this._max_depth=b||0;a=this._size=a||0;g=this._position=g||[0,0,0];this._nodes=[];this._lights=[];this._static_lights=[];this._sphere=[g[0],g[1],g[2],Math.sqrt(3*(this._size/2*this._size/2))];b=this._bbox=[[0,0,0],[0,0,0]];e=h.aabb;e.reset(b,g);a/=2;e.engulf(b,[g[0]+a,g[1]+
a,g[2]+a]);e.engulf(b,[g[0]-a,g[1]-a,g[2]-a]);this._debug_visible=!1}function t(){this.position=[0,0,0];this.visible=!1;this._object=null}function m(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;6>a;++a)this._planes[a]=[0,0,0,0]}var q=h.undef,r=h.plane,b=h.sphere,f=h.enums;f.frustum={plane:{LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5}};f.octree={TOP_NW:0,TOP_NE:1,TOP_SE:2,TOP_SW:3,BOTTOM_NW:4,BOTTOM_NE:5,BOTTOM_SE:6,BOTTOM_SW:7};var a=function(a,b,e){e=a.slice((e||b)+1||a.length);
a.length=0>b?a.length+b:b;return a.push.apply(a,e)};x.prototype.destroy=function(){var a,b,e;a=0;for(b=this._static_lights.length;a<b;++a)e=this._static_lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;a=0;for(b=this._lights.length;a<b;++a)e=this._lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;this._lights=this._static_lights=null;a=0;for(b=this._children.length;a<b;++a)null!==this._children[a]&&this._children[a].destroy();a=0;for(b=this._nodes.length;a<
b;++a)e=this._nodes[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null,e.dynamic_lights=[],e.static_lights=[];this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._bbox=this._sphere=this._static_lights=this._lights=this._nodes=this._position=this._root=this._children=this._children[7]=null};x.prototype.toString=function(){return"[Octree: @"+this._position+", depth: "+
this._max_depth+", size: "+this._size+", nodes: "+this._nodes.length+", measured size:"+[this._bbox[1][0]-this._bbox[0][0],this._bbox[1][2]-this._bbox[0][2]]+"]"};x.prototype.remove=function(c){var b=!1,e=this._nodes.length,g;g=e-1;for(e=this._nodes.length;0<=g;--g)if(c===this._nodes[g]){a(this._nodes,g);this.dirty_lineage();b=!0;break}if(!b)for(g=e-1;0<=g;--g)if(c===this._lights[g]){a(this._lights,g);this.dirty_lineage();break}};x.prototype.dirty_lineage=function(){this._dirty=!0;null!==this._root&&
this._root.dirty_lineage()};x.prototype.cleanup=function(){for(var a=this._children.length,b=0,e=0;e<a;++e){var g=this._children[e];if(null!==g){var f=!0;!0===g._dirty&&(f=g.cleanup());f?++b:this._children[e]=null}}return 0===this._nodes.length&&(0===this._static_lights.length&&0===this._lights.length)&&(0===b||0===a)?!1:!0};x.prototype.insert_light=function(a){this.insert(a,!0)};x.prototype.propagate_static_light=function(a){var b,e;b=0;for(e=this._nodes.length;b<e;++b)-1===this._nodes[b].static_lights.indexOf(a)&&
this._nodes[b].static_lights.push(a);for(b=0;8>b;++b)null!==this._children[b]&&this._children[b].propagate_static_light(a)};x.prototype.collect_static_lights=function(a){var b,e;b=0;for(e=this._static_lights.length;b<e;++b)-1===a.static_lights.indexOf(this._static_lights[b])&&a.static_lights.push(this._static_lights[b]);for(b=0;8>b;++b)null!==this._children[b]&&this._children[b].collect_static_lights(a)};x.prototype.insert=function(a,b){function e(a,c,b,d){var e,g;if(b)if(c.method===f.light.method.STATIC){-1===
a._static_lights.indexOf(c)&&a._static_lights.push(c);b=0;for(e=a._nodes.length;b<e;++b)-1===a._nodes[b].static_lights.indexOf(c)&&a._nodes[b].static_lights.push(c);for(g=a._root;null!==g;){b=0;for(l=g._nodes.length;b<l;++b)e=g._nodes[b],-1===e.static_lights.indexOf(c)&&e.static_lights.push(c);g=g._root}}else-1===a._lights.indexOf(c)&&a._lights.push(c);else{a._nodes.push(c);b=0;for(e=a._static_lights.length;b<e;++b)-1===c.static_lights.indexOf(a._static_lights[b])&&c.static_lights.push(a._static_lights[b]);
for(g=a._root;null!==g;){b=0;for(e=g._static_lights.length;b<e;++b){var n=g._static_lights[b];-1===c.static_lights.indexOf(n)&&c.static_lights.push(n)}g=g._root}}c.octree_leaves.push(a);c.octree_common_root=d;d=h.aabb;d.engulf(c.octree_aabb,a._bbox[0]);d.engulf(c.octree_aabb,a._bbox[1])}b===q&&(b=!1);null===this._root&&(a.octree_leaves=[],a.octree_common_root=null);if(0===this._max_depth)e(this,a,b,this._root);else{var g=this._position,n,o,m,r,w,v,C;o=a.getAABB();C=[o[0][0],o[0][1],o[0][2]];var A=
[o[1][0],o[1][1],o[1][2]];n=C[0]<g[0]&&C[1]<g[1]&&C[2]<g[2];o=A[0]>g[0]&&C[1]<g[1]&&C[2]<g[2];w=C[0]<g[0]&&A[1]>g[1]&&C[2]<g[2];v=A[0]>g[0]&&A[1]>g[1]&&C[2]<g[2];m=C[0]<g[0]&&C[1]<g[1]&&A[2]>g[2];r=A[0]>g[0]&&C[1]<g[1]&&A[2]>g[2];C=C[0]<g[0]&&A[1]>g[1]&&A[2]>g[2];g=A[0]>g[0]&&A[1]>g[1]&&A[2]>g[2];if(n&&o&&w&&v&&m&&r&&C&&g)e(this,a,b,this),b?a.method==f.light.method.STATIC&&this.propagate_static_light(a):this.collect_static_lights(a);else{for(var A=0,t=this._static_lights.length;A<t;++A)a.static_lights===
q&&(a.static_lights=[]),-1===a.static_lights.indexOf(this._static_lights[A])&&a.static_lights.push(this._static_lights[A]);var A=this._size/2,t=this._size/4,G=0,u=this._position[0],y=this._position[1],D=this._position[2];n&&(n=[u-t,y-t,D-t],null===this._children[f.octree.TOP_NW]&&(this._children[f.octree.TOP_NW]=new x(A,this._max_depth-1,this,n,f.octree.TOP_NW)),this._children[f.octree.TOP_NW].insert(a,b),++G);o&&(n=[u+t,y-t,D-t],null===this._children[f.octree.TOP_NE]&&(this._children[f.octree.TOP_NE]=
new x(A,this._max_depth-1,this,n,f.octree.TOP_NE)),this._children[f.octree.TOP_NE].insert(a,b),++G);w&&(n=[u-t,y+t,D-t],null===this._children[f.octree.BOTTOM_NW]&&(this._children[f.octree.BOTTOM_NW]=new x(A,this._max_depth-1,this,n,f.octree.BOTTOM_NW)),this._children[f.octree.BOTTOM_NW].insert(a,b),++G);v&&(n=[u+t,y+t,D-t],null===this._children[f.octree.BOTTOM_NE]&&(this._children[f.octree.BOTTOM_NE]=new x(A,this._max_depth-1,this,n,f.octree.BOTTOM_NE)),this._children[f.octree.BOTTOM_NE].insert(a,
b),++G);m&&(n=[u-t,y-t,D+t],null===this._children[f.octree.TOP_SW]&&(this._children[f.octree.TOP_SW]=new x(A,this._max_depth-1,this,n,f.octree.TOP_SW)),this._children[f.octree.TOP_SW].insert(a,b),++G);r&&(n=[u+t,y-t,D+t],null===this._children[f.octree.TOP_SE]&&(this._children[f.octree.TOP_SE]=new x(A,this._max_depth-1,this,n,f.octree.TOP_SE)),this._children[f.octree.TOP_SE].insert(a,b),++G);C&&(n=[u-t,y+t,D+t],null===this._children[f.octree.BOTTOM_SW]&&(this._children[f.octree.BOTTOM_SW]=new x(A,
this._max_depth-1,this,n,f.octree.BOTTOM_SW)),this._children[f.octree.BOTTOM_SW].insert(a,b),++G);g&&(n=[u+t,y+t,D+t],null===this._children[f.octree.BOTTOM_SE]&&(this._children[f.octree.BOTTOM_SE]=new x(A,this._max_depth-1,this,n,f.octree.BOTTOM_SE)),this._children[f.octree.BOTTOM_SE].insert(a,b),++G);if(1<G||null===a.octree_common_root)a.octree_common_root=this}}};x.prototype.draw_on_map=function(a,b,e){function g(a,c,e,g,m){var v=a<e?a:e,s=c<g?c:g,a=a<e?e-a:a-e,c=c<g?g-c:c-g;b.save();void 0!==m&&
(b.fillStyle=m,b.fillRect(f+v,h+s,a,c));b.strokeRect(f+v,h+s,a,c);b.restore()}var f=a.width/2,h=a.height/2,m,r,w,v,t,A,B;if(e===q||"map"===e)b.save(),!1!==this._debug_visible?(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="#FF0000"):(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="rgba(0,0,0,0)"),b.beginPath(),t=this._size/2,m=this._position[0],r=this._position[2],b.moveTo(f+m-t,f+r-t),b.lineTo(f+m-t,f+r+t),b.lineTo(f+m+t,f+r+t),b.lineTo(f+m+t,f+r-t),b.stroke(),b.fill(),b.restore();if(e===q||"objects"===e){b.save();
t=0;for(B=this._nodes.length;t<B;++t)A=this._nodes[t],b.fillStyle="#5500FF",b.strokeStyle=!0===A.visible&&!1===A.culled?"#FFFFFF":"#000000",b.beginPath(),m=A.aabb[0][0],r=A.aabb[0][2],w=A.aabb[1][0]-m,v=A.aabb[1][2]-r,b.rect(f+m,h+r,w,v),b.stroke();b.restore()}if(e===q||"lights"===e){t=0;for(B=this._lights.length;t<B;++t)v=this._lights[t],b.fillStyle=!1===v.culled&&!0===v.visible?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FFFF00",b.beginPath(),A=v.distance,m=v.position[0],
r=v.position[2],b.arc(f+m,h+r,A,0,2*Math.PI,!0),b.closePath(),b.stroke(),b.fill(),b.beginPath(),m=v.aabb[0][0],r=v.aabb[0][2],w=v.aabb[1][0]-m,v=v.aabb[1][2]-r,b.rect(f+m,h+r,w,v),b.closePath(),b.stroke();t=0;for(B=this._static_lights.length;t<B;++t)v=this._static_lights[t],b.fillStyle=!1===v.culled&&!0===v.visible?"rgba(255, 255, 255, 0.01)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FF66BB",b.beginPath(),A=v.distance,m=v.position[0],r=v.position[2],b.arc(f+m,h+r,A,0,2*Math.PI,!0),b.closePath(),
b.stroke(),b.fill(),b.beginPath(),m=v.aabb[0][0],r=v.aabb[0][2],w=v.aabb[1][0]-m,v=v.aabb[1][2]-r,b.rect(f+m,h+r,w,v),b.closePath(),b.stroke()}if("lights"!=e&&"objects"!=e&&"map"!=e){b.save();m=this._nodes;t=0;for(v=m.length;t<v;++t)if(A=m[t],A.name==e){b.strokeStyle="#FFFF00";b.lineWidth=3;b.beginPath();m=A.aabb[0][0];r=A.aabb[0][2];w=A.aabb[1][0]-m;v=A.aabb[1][2]-r;b.rect(f+m,h+r,w,v);b.closePath();b.stroke();m=A.octree_aabb;b.strokeStyle="#0000FF";g(m[0][0],m[0][2],m[1][0],m[1][2]);b.lineWidth=
1;null!==A.common_root&&(b.strokeStyle="#00FF00");break}b.lineWidth=1;b.strokeStyle="#FFFF00";g(this._bbox[0][0],this._bbox[0][2],this._bbox[1][0],this._bbox[1][2],"#444444");b.fill();b.restore()}t=0;for(B=this._children.length;t<B;++t)null!==this._children[t]&&this._children[t].draw_on_map(a,b,e)};x.prototype.contains_point=function(a){return a[0]<=this._position[0]+this._size/2&&a[1]<=this._position[1]+this._size/2&&a[2]<=this._position[2]+this._size/2&&a[0]>=this._position[0]-this._size/2&&a[1]>=
this._position[1]-this._size/2&&a[2]>=this._position[2]-this._size/2};x.prototype.get_frustum_hits=function(a,d){var e={objects:[],lights:[]};if((d===q||!0===d)&&!this.contains_point(a.position)){if(!1===b.intersects(a.frustum.sphere,this._sphere))return e;var g=a.frustum.contains_sphere(this._sphere);if(-1===g)return this._debug_visible=!1,e;if(1===g)this._debug_visible=2,d=!1;else if(0===g){this._debug_visible=!0;g=a.frustum.contains_box(this._bbox);if(-1===g)return this._debug_visible=!1,e;1===
g&&(this._debug_visible=3,d=!1)}}var f,h,g=0;for(f=this._nodes.length;g<f;++g)h=this._nodes[g],e.objects.push(h),h.dynamic_lights=[].concat(this._lights),h.was_culled=h.culled,h.culled=!1,h.drawn_this_frame=!1;this._debug_visible=0<this._lights.length?4:this._debug_visible;g=0;for(f=this._lights.length;g<f;++g)h=this._lights[g],!0===h.visible&&(e.lights.push(h),h.was_culled=h.culled,h.culled=!1);g=0;for(f=this._static_lights.length;g<f;++g)h=this._static_lights[g],!0===h.visible&&(h.culled=!1);for(g=
0;8>g;++g)if(null!==this._children[g]){f=this._children[g].get_frustum_hits(a,d);var m;h=0;for(m=f.objects.length;h<m;++h){e.objects.push(f.objects[h]);for(var r=f.objects[h].dynamic_lights,w=0,v=this._lights.length;w<v;++w)0>r.indexOf(this._lights[w])&&r.push(this._lights[w])}h=0;for(m=f.lights.length;h<m;++h)0>e.lights.indexOf(f.lights[h])&&e.lights.push(f.lights[h])}return e};x.prototype.reset_node_visibility=function(){this._debug_visible=!1;var a,b;a=0;for(b=this._nodes.length;a<b;++a)this._nodes[a].culled=
!0;a=0;for(b=this._lights.length;a<b;++a)this._lights[a].culled=!0;a=0;for(b=this._static_lights.length;a<b;++a)this._static_lights[a].culled=!0;a=0;for(b=this._children.length;a<b;++a)null!==this._children[a]&&this._children[a].reset_node_visibility()};t.prototype.toString=function(){return"[OctreeNode "+this.position+"]"};t.prototype.attach=function(a){this._object=a};m.prototype.extract=function(a,b,e){var g=h.mat4,n=h.vec3;if(!(b===q||e===q)){g=g.multiply(e,b);b=this._planes;b[f.frustum.plane.LEFT][0]=
g[3]+g[0];b[f.frustum.plane.LEFT][1]=g[7]+g[4];b[f.frustum.plane.LEFT][2]=g[11]+g[8];b[f.frustum.plane.LEFT][3]=g[15]+g[12];b[f.frustum.plane.RIGHT][0]=g[3]-g[0];b[f.frustum.plane.RIGHT][1]=g[7]-g[4];b[f.frustum.plane.RIGHT][2]=g[11]-g[8];b[f.frustum.plane.RIGHT][3]=g[15]-g[12];b[f.frustum.plane.TOP][0]=g[3]-g[1];b[f.frustum.plane.TOP][1]=g[7]-g[5];b[f.frustum.plane.TOP][2]=g[11]-g[9];b[f.frustum.plane.TOP][3]=g[15]-g[13];b[f.frustum.plane.BOTTOM][0]=g[3]+g[1];b[f.frustum.plane.BOTTOM][1]=g[7]+g[5];
b[f.frustum.plane.BOTTOM][2]=g[11]+g[9];b[f.frustum.plane.BOTTOM][3]=g[15]+g[13];b[f.frustum.plane.NEAR][0]=g[3]+g[2];b[f.frustum.plane.NEAR][1]=g[7]+g[6];b[f.frustum.plane.NEAR][2]=g[11]+g[10];b[f.frustum.plane.NEAR][3]=g[15]+g[14];b[f.frustum.plane.FAR][0]=g[3]-g[2];b[f.frustum.plane.FAR][1]=g[7]-g[6];b[f.frustum.plane.FAR][2]=g[11]-g[10];b[f.frustum.plane.FAR][3]=g[15]-g[14];for(var o=0;6>o;++o)r.normalize(b[o]);o=-b[f.frustum.plane.NEAR][3];b=b[f.frustum.plane.FAR][3]-o;e=b*(1/e[5]);e=n.subtract([0,
0,o+0.5*b],[e,e,o+b]);e=n.length(e);g=[g[3],g[9],g[10]];o=n.length(g);g=n.multiply(g,1/o);a=[a.position[0],a.position[1],a.position[2]];a=n.add(a,n.multiply(g,0.5*b));a=n.add(a,n.multiply(g,1));this.sphere=[a[0],a[1],a[2],e]}};m.prototype.contains_sphere=function(a){for(var b=h.vec3,e=this._planes,g=0;6>g;++g){var f=e[g],f=b.dot([f[0],f[1],f[2]],[a[0],a[1],a[2]])+f.d;this.last_in[g]=1;if(f<-a[3])return-1;if(Math.abs(f)<a[3])return 0}return 1};m.prototype.draw_on_map=function(a,b){var e=a.width/2,
g=a.height/2;b.save();for(var f=this._planes,h=[0,1,4,5],m=0,q=h.length;m<q;++m){var r=f[h[m]];b.strokeStyle="#FF00FF";m<this.last_in.length&&this.last_in[m]&&(b.strokeStyle="#FFFF00");var v=-e,t=e,A=(-r[3]-r[0]*t)/r[2];b.moveTo(e+v,g+(-r[3]-r[0]*v)/r[2]);b.lineTo(e+t,g+A);b.stroke()}b.strokeStyle="#0000FF";b.beginPath();b.arc(e+this.sphere[0],g+this.sphere[2],this.sphere[3],0,2*Math.PI,!1);b.closePath();b.stroke();b.restore()};m.prototype.contains_box=function(a){var b=0,e=[];e[0]=a[0];e[1]=[a[0][0],
a[0][1],a[1][2]];e[2]=[a[0][0],a[1][1],a[0][2]];e[3]=[a[0][0],a[1][1],a[1][2]];e[4]=[a[1][0],a[0][1],a[0][2]];e[5]=[a[1][0],a[0][1],a[1][2]];e[6]=[a[1][0],a[1][1],a[0][2]];e[7]=a[1];for(var a=this._planes,g=0;6>g;++g){for(var f=8,h=1,m=0;8>m;++m)-1===r.classifyPoint(a[g],e[m])&&(h=0,--f);this.last_in[g]=h;if(0===f)return-1;b+=h}return 6===b?1:0};return{Frustum:m,Octree:x}});
CubicVR.RegisterModule("CVRXML",function(h){function x(a,b,g,f){var h=CubicVR.util,m=null,q=null;f.triangles&&(q=h.intDelimArray(c.getTextNode(f,"triangles")," "));if(q&&(f.segments&&(m=h.intDelimArray(c.getTextNode(f,"segments")," ")),null===m&&(m=[0,parseInt(q.length/3,10)]),f=0,a.setFaceMaterial(b),q.length)){p=0;for(pMax=m.length;p<pMax;p+=2){b=3*m[p+1];a.setSegment(m[p]);j=f;for(jMax=f+b;j<jMax;j+=3)h=a.addFace([q[j],q[j+1],q[j+2]]),g&&a.faces[h].setUV([g[j],g[j+1],g[j+2]]);f+=b}}}function t(a){var b=
CubicVR.util,g=new CubicVR.UVMapper,h=null,m=null;if(a.type)switch(h=c.getTextNode(a,"type"),h){case "planar":g.projection_mode=f.uv.projection.PLANAR;break;case "cylindrical":g.projection_mode=f.uv.projection.CYLINDRICAL;break;case "spherical":g.projection_mode=f.uv.projection.SPHERICAL;break;case "cubic":g.projection_mode=f.uv.projection.CUBIC}if(!h)return null;"uv"===h&&a.uv&&(m=c.getPoints(a,"uv"));if(a.axis)switch(c.getTextNode(a,"axis")){case "x":g.projection_axis=f.uv.axis.X;break;case "y":g.projection_axis=
f.uv.axis.Y;break;case "z":g.projection_axis=f.uv.axis.Z}a.center&&(g.center=b.floatDelimArray(c.getTextNode(a,"center")));a.rotation&&(g.rotation=b.floatDelimArray(c.getTextNode(a,"rotation")));a.scale&&(g.scale=b.floatDelimArray(c.getTextNode(a,"scale")));a.wrap_w&&(g.wrap_w_count=parseFloat(c.getTextNode(a,"wrap_w")));a.wrap_h&&(g.wrap_h_count=parseFloat(c.getTextNode(a,"wrap_h")));return""!==h&&"uv"!==h?g:m}function m(d,e){if(a[d]!==b)return a[d];var g=CubicVR.util,n,m,s,q;n=null;n="object"==
typeof d?d:-1!=d.indexOf(".js")?g.getJSON(d):CubicVR.util.xml2badgerfish(g.getXML(d));n.root&&(n=n.root);n.properties&&(n=n.properties);g=new CubicVR.Mesh;n.points&&(s=c.getPoints(n,"points"))&&g.addPoint(s);var r=n.material;r&&!r.length&&(r=[r]);var v=[];if(r){n=0;for(s=r.length;n<s;n++){var C=r[n],A;A=C;var B=e,G=new CubicVR.Material({name:A.name?A.name.$:null});A.shininess&&(G.shininess=c.getFloatNode(A,"shininess",G.shininess)/100);G.opacity=c.getFloatNode(A,"alpha",G.opacity);G.max_smooth=c.getFloatNode(A,
"max_smooth",G.max_smooth);G.color=c.getFloatDelimNode(A,"color",G.color);G.ambient=c.getFloatDelimNode(A,"ambient",G.ambient);G.diffuse=c.getFloatDelimNode(A,"diffuse",G.diffuse);G.specular=c.getFloatDelimNode(A,"specular",G.specular);m=void 0;if(m=c.getTextNode(A,"texture"))m=(B?B:"")+m,tex=h.Textures_ref[m]!==b?h.Textures_obj[h.Textures_ref[m]]:new CubicVR.Texture(m),G.setTexture(tex,f.texture.map.COLOR);if(m=c.getTextNode(A,"texture_luminosity"))m=(B?B:"")+m,tex=h.Textures_ref[m]!==b?h.Textures_obj[h.Textures_ref[m]]:
new CubicVR.Texture(m),G.setTexture(tex,f.texture.map.AMBIENT);if(m=c.getTextNode(A,"texture_normal"))m=(B?B:"")+m,tex=h.Textures_ref[m]!==b?h.Textures_obj[h.Textures_ref[m]]:new CubicVR.Texture(m),G.setTexture(tex,f.texture.map.NORMAL);if(m=c.getTextNode(A,"texture_specular"))m=(B?B:"")+m,tex=h.Textures_ref[m]!==b?h.Textures_obj[h.Textures_ref[m]]:new CubicVR.Texture(m),G.setTexture(tex,f.texture.map.SPECULAR);if(m=c.getTextNode(A,"texture_bump"))m=(B?B:"")+m,tex=h.Textures_ref[m]!==b?h.Textures_obj[h.Textures_ref[m]]:
new CubicVR.Texture(m),G.setTexture(tex,f.texture.map.BUMP);if(m=c.getTextNode(A,"texture_envsphere"))m=(B?B:"")+m,tex=h.Textures_ref[m]!==b?h.Textures_obj[h.Textures_ref[m]]:new CubicVR.Texture(m),G.setTexture(tex,f.texture.map.ENVSPHERE);if(m=c.getTextNode(A,"texture_alpha"))m=(B?B:"")+m,tex=h.Textures_ref[m]!==b?h.Textures_obj[h.Textures_ref[m]]:new CubicVR.Texture(m),G.setTexture(tex,f.texture.map.ALPHA);A=G;var u=null;m=B=null;C.uvmapper&&((B=t(C.uvmapper))&&!B.length?v.push([B,A]):m=B);(G=C.part)&&
!G.length&&(G=[G]);if(G&&G.length){var y=null,D=null;m=0;for(q=G.length;m<q;m++){var z=G[m],y=null;if(u=z.uvmapper)y=t(u),C.triangles&&(D=u=g.faces.length,y&&!y.length?(x(g,A,null,z),D=g.faces.length-1,g.calcFaceNormals(u,D),y.apply(g,A,b,u,D)):y&&y.length?x(g,A,y,z):B&&!B.length&&(x(g,A,null,z),D=g.faces.length-1,g.calcFaceNormals(u,D),B.apply(g,A,b,u,D)));if(z.procedural){(u=z.uvmapper)&&(y=t(u));var D=z.transform?c.getTransform(z.transform):b,u=b,z=z.procedural,F=c.getTextNode(z,"type");D&&(u=
new CubicVR.Transform,u.translate(D.position),u.pushMatrix(),u.rotate(D.rotation),u.pushMatrix(),u.scale(D.scale));B||(B=b);y={material:A,uvmapper:B||y};if("box"===F||"cube"===F)y.size=c.getFloatNode(z,"size"),g.booleanAdd(CubicVR.primitives.box(y),u);else if("sphere"===F)y.radius=c.getFloatNode(z,"radius"),y.lat=c.getIntNode(z,"lat"),y.lon=c.getIntNode(z,"lon"),g.booleanAdd(CubicVR.primitives.sphere(y),u);else if("cone"===F)y.base=c.getFloatNode(z,"base"),y.height=c.getFloatNode(z,"height"),y.lon=
c.getIntNode(z,"lon"),g.booleanAdd(CubicVR.primitives.cone(y),u);else if("plane"===F)y.size=c.getFloatNode(z,"size"),g.booleanAdd(CubicVR.primitives.plane(y),u);else if("cylinder"===F)y.radius=c.getFloatNode(z,"radius"),y.height=c.getFloatNode(z,"height"),y.lon=c.getIntNode(z,"lon"),g.booleanAdd(CubicVR.primitives.cylinder(y),u);else if("torus"===F)y.innerRadius=c.getFloatNode(z,"innerRadius"),y.outerRadius=c.getFloatNode(z,"outerRadius"),y.lat=c.getIntNode(z,"lat"),y.lon=c.getIntNode(z,"lon"),g.booleanAdd(CubicVR.primitives.torus(y),
u);else if("lathe"===F)y.points=c.getPoints(z,"p"),y.lon=c.getIntNode(z,"lon"),g.booleanAdd(CubicVR.primitives.lathe(y),u);else if("polygon"===F){D=c.getPoints(z,"p");D=new CubicVR.Polygon(D);(F=z.cut)&&!F.length&&(F=[F]);if(F.length){m=0;for(s=F.length;m<q;m++)D.cut(new CubicVR.Polygon(c.getPoints(F[m])))}y.front=0;y.back=0;y.frontShift=0;y.backShift=0;y.frontDepth=0;y.backDepth=0;if(z.extrude&&(z=z.extrude,y.front=c.getFloatNode(z,"front",0),y.back=c.getFloatNode(z,"back",0),y.frontShift=c.getFloatNode(z,
"frontBevelShift",0),y.backShift=c.getFloatNode(z,"backBevelShift",0),y.frontDepth=c.getFloatNode(z,"frontBevelDepth",0),y.backDepth=c.getFloatNode(z,"backBevelDepth",0),y.depth=c.getFloatNode(z,"depth",0),y.shift=c.getFloatNode(z,"shift",0),y.bevel=c.getFloatNode(z,"bevel",0),y.depth&&(!y.backDepth&&!y.frontDepth)&&(y.front=-y.depth/2,y.back=y.depth/2),y.shift&&(!y.backShift&&!y.frontShift)&&(y.frontShift=y.shift,y.backShift=y.shift),y.bevel&&!y.backDepth&&!y.frontDepth))y.frontDepth=y.bevel,y.backDepth=
y.bevel;z=D.toExtrudedBeveledMesh(new CubicVR.Mesh,y);z.setFaceMaterial(y.material);g.booleanAdd(z,u)}}}}else x(g,A,m,C)}}g.triangulateQuads();g.calcNormals();n=0;for(s=v.length;n<s;n++)v[n][0].apply(g,v[n][1]);g.compile();return a[d]=g}function q(a){return null===a?!1:a.getElementsByTagName("x").length||a.getElementsByTagName("y").length||a.getElementsByTagName("z").length||a.getElementsByTagName("fov").length}function r(a,c,g){var h=CubicVR.util,m=[];m[0]=a.getElementsByTagName("x");m[1]=a.getElementsByTagName("y");
m[2]=a.getElementsByTagName("z");m[3]=a.getElementsByTagName("fov");var s,q,r,v,t,A;for(A in m)if(m.hasOwnProperty(A)&&m[A]!==b&&m[A].length){s=m[A][0].getElementsByTagName("time");q=m[A][0].getElementsByTagName("value");r=m[A][0].getElementsByTagName("in");v=m[A][0].getElementsByTagName("out");t=m[A][0].getElementsByTagName("tcb");var B=null,x=null,u=null,y=a=null;r.length&&(a=h.collectTextNode(r[0]));v.length&&(y=h.collectTextNode(v[0]));s.length&&(B=h.floatDelimArray(h.collectTextNode(s[0])," "));
q.length&&(x=h.floatDelimArray(h.collectTextNode(q[0])," "));t.length&&(u=h.floatDelimArray(h.collectTextNode(t[0])," "));if(null!==B&&null!==x){s=0;for(q=B.length;s<q;s++)r=g.setKey(c,A,B[s],x[s]),u&&(r.tension=u[3*s],r.continuity=u[3*s+1],r.bias=u[3*s+2])}x=B=f.envelope.behavior.CONSTANT;if(a)switch(a){case "reset":B=f.envelope.behavior.RESET;break;case "constant":B=f.envelope.behavior.CONSTANT;break;case "repeat":B=f.envelope.behavior.REPEAT;break;case "oscillate":B=f.envelope.behavior.OSCILLATE;
break;case "offset":B=f.envelope.behavior.OFFSET;break;case "linear":B=f.envelope.behavior.LINEAR}if(y)switch(y){case "reset":x=f.envelope.behavior.RESET;break;case "constant":x=f.envelope.behavior.CONSTANT;break;case "repeat":x=f.envelope.behavior.REPEAT;break;case "oscillate":x=f.envelope.behavior.OSCILLATE;break;case "offset":x=f.envelope.behavior.OFFSET;break;case "linear":x=f.envelope.behavior.LINEAR}g.setBehavior(c,A,B,x)}}var b=h.undef,f=CubicVR.enums,a=[],c={getPoints:function(a,e,f){a=e?
c.getTextNode(a,e):a.$;if(!a)return b;a=a.split(" ");i=0;for(iMax=a.length;i<iMax;i++){a[i]=a[i].split(",");j=0;for(jMax=a[i].length;j<jMax;j++)a[i][j]=parseFloat(a[i][j]);f&&(a[i][2]=0)}return a},getTransform:function(a){var c=CubicVR.util;if(!a)return null;var b={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},f;postition=a.position;f=a.rotation;a=a.scale;f&&(b.rotation=c.floatDelimArray(f.$));a&&(b.scale=c.floatDelimArray(a.$));return f||a?b:null},getTextNode:function(a,c,b){a=a[c];if(!a)return b;
a.length&&(a=a[0]);return a.$?a.$:b},getFloatNode:function(a,b,f){return(a=c.getTextNode(a,b))?(a=parseFloat(a),a!=a?f:a):f},getIntNode:function(a,b,f){return(a=c.getTextNode(a,b))?(a=parseInt(a,10),a!=a?f:a):f},getFloatDelimNode:function(a,b,f,h){var m=CubicVR.util;return(a=c.getTextNode(a,b))?m.floatDelimArray(a,h):f},getIntDelimNode:function(a,b,f,h){var m=CubicVR.util;return(a=c.getTextNode(a,b))?m.intDelimArray(a,h):f}};return{loadMesh:m,loadScene:function(a,c,g){var h=CubicVR.util;c===b&&(c=
"");g===b&&(g="");for(var o=new CubicVR.Mesh,s=h.getXML(a),a=new CubicVR.Scene,t=[],w=s.getElementsByTagName("sceneobjects"),v,C,A,x=0,G=w[0].childNodes.length;x<G;x++){var u=w[0].childNodes[x];if("sceneobject"===u.tagName){var y="unnamed",D="",z="",o=u.getElementsByTagName("name");o.length&&(y=h.collectTextNode(o[0]));o=u.getElementsByTagName("parent");o.length&&(D=h.collectTextNode(o[0]));o=u.getElementsByTagName("model");o.length&&(z=h.collectTextNode(o[0]));A=C=v=null;o=u.getElementsByTagName("position");
o.length&&(v=o[0]);o=u.getElementsByTagName("rotation");o.length&&(C=o[0]);o=u.getElementsByTagName("scale");o.length&&(A=o[0]);o=null;""!==z&&(o=m(c+z,g));o=new CubicVR.SceneObject(o,y);q(v)?(o.motion||(o.motion=new CubicVR.Motion),r(v,f.motion.POS,o.motion)):v&&(o.position=h.floatDelimArray(h.collectTextNode(v)));q(C)?(o.motion||(o.motion=new CubicVR.Motion),r(C,f.motion.ROT,o.motion)):o.rotation=h.floatDelimArray(h.collectTextNode(C));q(A)?(o.motion||(o.motion=new CubicVR.Motion),r(A,f.motion.SCL,
o.motion)):o.scale=h.floatDelimArray(h.collectTextNode(A));a.bindSceneObject(o);""!==D&&t.push([o,D])}}for(var F in t)t.hasOwnProperty(F)&&a.getSceneObject(t[F][1]).bindChild(t[F][0]);c=s.getElementsByTagName("camera");c.length&&((C=v=null,g="",o=c[0].getElementsByTagName("name"),F=a.camera,s=null,o.length&&(g=o[0].firstChild.nodeValue),o=c[0].getElementsByTagName("target"),o.length&&(g=o[0].firstChild.nodeValue),""!==g&&(F.targetSceneObject=a.getSceneObject(g)),o=c[0].getElementsByTagName("position"),
o.length&&(v=o[0]),o=c[0].getElementsByTagName("rotation"),o.length&&(C=o[0]),o=c[0].getElementsByTagName("fov"),o.length&&(s=o[0]),q(v)?(F.motion||(F.motion=new CubicVR.Motion),r(v,f.motion.POS,F.motion)):v&&(F.position=h.floatDelimArray(v.firstChild.nodeValue)),q(C)?(F.motion||(F.motion=new CubicVR.Motion),r(C,f.motion.ROT,F.motion)):C&&(F.rotation=h.floatDelimArray(C.firstChild.nodeValue)),q(s))?(F.motion||(F.motion=new CubicVR.Motion),r(s,f.motion.FOV,F.motion)):s&&(F.fov=parseFloat(s.firstChild.nodeValue)));
return a}}});
CubicVR.RegisterModule("Worker",function(h){function x(a){var c=this;this.message=a.message||function(){};this.send=function(a,c){postMessage({message:a,data:c})};self.addEventListener("message",function(a){"init"!==a.data.message&&c.message(a.data)},!1)}function t(a){function c(a){setTimeout(function(){b.send("test",a)},1E3)}a&&c(a);var b=new x({message:c})}function m(a){function c(a){a=s.getURL(a);b.send("done",a.length)}var b;b=new x({message:function(a){c(a)}});a&&c(a)}function q(a){function c(a){a=s.getURL(a);
b.send("loaded",a)}var b,d;b=new x({message:function(a){if("parse"===a.message)d=new o,CubicVR.loadCollada("","",d,a.data),b.send("parsed");else if("getMesh"===a.message){if(a=d.meshMap[":"+a.data]){var c=a.triangulateQuads().compileVBO(a.compileMap());b.send("getMesh",{mesh:a,vbo:c})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});a&&c(a)}function r(c){function b(c){var e=new a,f;for(f in c)c.hasOwnProperty(f)&&(e[f]=c[f]);c=e.triangulateQuads().compileVBO(e.compileMap());d.send("done",
c)}var d;d=new x({message:function(a){b(a)}});c&&b(c)}try{window||(self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}})}catch(b){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}var f=h.undef,a=CubicVR.Mesh,c=CubicVR.Texture,d=CubicVR.Material,e=CubicVR.SceneObject,g=CubicVR.Motion,n=CubicVR.Envelope,o=CubicVR.DeferredBin,s=CubicVR.util;return{Worker:function(a){this.worker=new Worker(CubicVR.getScriptLocation()+"CubicVR.js");this.message=
a.message||function(){};this.error=a.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=a.type;var c=this;this.worker.onmessage=function(a){c.message(a.data)};this.worker.onerror=function(a){c.error(a)};this.init=function(a){c.send("init",{type:c.type,data:a})};this.send=function(a,b){c.worker.postMessage({message:a,data:b})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(a.data||a.autoStart)&&c.init(a.data)},ResourcePool:function(){function b(c){var d=c.parsed||
function(){},e={},f;c.url.match(/\.dae/)&&(f=new CubicVR.Worker({type:"sceneFile",data:c.url,message:function(c){if("loaded"===c.message){var c=(new DOMParser).parseFromString(c.data,"text/xml"),b=s.xml2badgerfish(c);console.log(c);f.send("parse",b)}else if("getMesh"===c.message){var b=new a,g;for(g in c.data.mesh)c.data.mesh.hasOwnProperty(g)&&(b[g]=c.data.mesh[g]);b.bindBuffer(b.bufferVBO(c.data.vbo));e.getMesh&&e.getMesh(b)}else"parsed"===c.message&&d()}}));this.getSceneObject=function(a,c){f.send("getMesh",
a);e.getMesh=c}}function f(a,c){for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c}var g=this,h={};this.createSceneFileManager=function(a){var c=new b({url:a.url,parsed:a.parsed});return h[a.url]=c};this.removeSceneFileManager=function(a){if("string"===typeof settings)delete h[settings];else for(var c in h)h[c]===a&&delete h[c]};this.createSceneObjectFromMesh=function(b){var h=b.scene,m=b.object,n=b.assetBase||"",o=g.createSceneFileManager({url:b.mesh,parsed:function(){m&&o.getSceneObject(m,
function(b){for(var b=f(b,new a),g=0,m=b.materials.length;g<m;++g){for(var o=f(b.materials[g],new d),v=0,q=o.textures.length;v<q;++v){var s=o.textures[g];o.textures[g]=new c(n+s.img_path,s.filter_type)}b.materials[g]=o}b=new e(b);h.bindSceneObject(b)})}})};this.loadFile=function(a,c){c=c||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){c(a.data)}})}},loadColladaWorker:function(b,h,m,o){var s;try{s=new Worker(CubicVR.getScriptLocation()+"collada.js")}catch(q){throw Error("Can't find collada.js");
}var r=[],u=[];s.onmessage=function(h){function s(a,c){for(var b in a)c[b]=a[b]}function q(a){if(a.motion){for(var c=a.motion.controllers,b=[],d=0,e=c.length;d<e;++d){var f=c[d];if(f){for(var h=[],m=0,o=f.length;m<o;++m){var v=f[m];if(v){var r=v.keys[0];1<v.keys.length&&(r.prev=null,r.next=v.keys[1],r=v.keys[1]);for(var u=1,t=v.keys.length-1;u<t;++u)r.prev=v.keys[u-1],r.next=v.keys[u+1],r=v.keys[u+1];1<v.keys.length&&(r=v.keys[v.keys.length-1],r.prev=v.keys[v.keys.length-2],r.next=null);v.firstKey=
v.keys[0];v.lastKey=v.keys[v.keys.length-1];v.keys=v.firstKey;r=new n;s(v,r);h[m]=r}else f[m]=null}b[d]=h}else c[d]=null}a.motion.controllers=b;c=new g;s(a.motion,c);a.motion=c}}function t(c){var d=new e;s(c,d);if(null!==c.obj){var g=u[c.obj.id];if(g===f)if(g=new a,s(c.obj,g),d.obj=g,u[c.obj.id]=g,o){if(0<g.points.length){o.addMesh(b,b+":"+g.id,g);for(var h=0,m=g.faces.length;h<m;++h){var n=g.faces[h],v=n.material;n.material=r[v]!==f?r[v]:0}}}else d.obj.triangulateQuads(),d.obj.calcNormals(),d.obj.compile(),
d.obj.clean();else d.obj=g}d.trans=new Transform;if(c.children&&0<c.children.length&&(d.children=[],c.children)){g=0;for(h=c.children.length;g<h;++g)m=t(c.children[g]),d.bindChild(m)}return d}var w;w=h.data.message;if("materials"==w){var A=JSON.parse(h.data.data),h=0;for(w=A.length;h<w;++h){var x=new d(A[h].name),B=x.material_id;s(A[h],x);x.material_id=B;r[A[h].material_id]=B;for(var B=0,M=A[h].textures.length;B<M;++B){var K=A[h].textures[B];if(K){var N=Texture_ref[K.img_path];N===f?(K=new c(K.img_path,
K.filter_type,o,b),x.textures[B]=K):x.textures[B]=Textures_obj[N]}else x.textures[B]=0}}}else if("scene"==w){A=JSON.parse(h.data.data);h=0;for(w=A.sceneObjects.length;h<w;++h)x=A.sceneObjects[h],null!==x.obj&&nop(),x.reassembled===f&&(q(x),x.reassembled=!0),A.sceneObjects[h]=t(x);x=new Scene;h=x.camera;w=h.transform;s(A.camera,h);s(A.camera.transform,w);q(h);x.camera=h;x.camera.transform=w;x.camera.frustum=new Frustum;h=0;for(w=A.sceneObjects.length;h<w;++h){B=A.sceneObjects[h];x.bindSceneObject(B);
try{B.getAABB()}catch(Y){}}h=0;for(w=A.lights.length;h<w;++h)B=new Light,s(A.lights[h],B),B.trans=new Transform,q(B),x.bindLight(B);m(x)}else console.log("message from collada worker:",h.data.message)};s.onerror=function(a){console.log("error from collada worker:",a.message)};s.postMessage({message:"start",params:{meshUrl:b,prefix:h,rootDir:CubicVR.getScriptLocation()}})},InitWorker:function(){var a={test:t,prepareMesh:r,file:m,sceneFile:q};self.addEventListener("message",function(c){if("init"===
c.data.message){var b=c.data.data.type;if(b in a)new a[b](c.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});
CubicVR.RegisterModule("Polygon",function(h){function x(a){var c=[],b=a.length;if(3>b)return null;var d=[],f;f=a.length;for(var h=0,m=f-1,q=0;q<f;m=q++)h+=a[m][0]*a[q][1]-a[q][0]*a[m][1];if(0<0.5*h)for(f=0;f<b;f++)d[f]=f;else for(f=0;f<b;f++)d[f]=b-1-f;q=2*b;h=0;for(f=b-1;2<b;){if(0>=q--)return null;var r=f;b<=r&&(r=0);f=r+1;b<=f&&(f=0);m=f+1;b<=m&&(m=0);var t;a:{t=a;var x=r,u=f,y=m,D=b,z=d,F=void 0,I=void 0,H=void 0,J=void 0,L=void 0,M=void 0,K=void 0,N=void 0,Y=void 0,I=t[z[x]][0],H=t[z[x]][1],
J=t[z[u]][0],L=t[z[u]][1],M=t[z[y]][0],K=t[z[y]][1];if(e>(J-I)*(K-H)-(L-H)*(M-I))t=!1;else{for(F=0;F<D;F++)if(!(F==x||F==u||F==y)){var N=t[z[F]][0],Y=t[z[F]][1],ca=void 0,U=void 0,na=void 0,Q=void 0,O=void 0,Ma=void 0,gb=void 0,hb=void 0,Na=void 0,qb=void 0,Oa=void 0,ib=void 0,ca=na=O=void 0,ca=M-J,U=K-L,na=I-M,Q=H-K,O=J-I,Ma=L-H,gb=N-I,hb=Y-H,Na=N-J,qb=Y-L,Oa=N-M,ib=Y-K,ca=ca*qb-U*Na,O=O*hb-Ma*gb,na=na*ib-Q*Oa;if(0<=ca&&0<=na&&0<=O){t=!1;break a}}t=!0}}if(t){q=d[r];r=d[f];m=d[m];c.push(q);c.push(r);
c.push(m);h++;m=f;for(q=f+1;q<b;m++,q++)d[m]=d[q];b--;q=2*b}}return c}function t(a,c,b){b===d&&(b=0);var e;e=x(c);var f=CubicVR.util.repackArray(e,3,e.length/3),h=[],m=a.points.length;e=0;for(iMax=c.length;e<iMax;e++)h.push([c[e][0],c[e][1],b]);a.addPoint(h);e=0;for(iMax=f.length;e<iMax;e++)a.addFace([f[e][0]+m,f[e][1]+m,f[e][2]+m])}function m(a,c){var b=c[0]-a[0],d=c[1]-a[1];return Math.sqrt(b*b+d*d)}function q(a,c){var b,d,e=[],f=a.length,h=c.length,q=[];for(b=0;b<f;b++)for(d=0;d<h;d++){var r=m(a[b],
c[d]);e.push([r,b,d])}e.sort(function(a,c){return a[0]>c[0]});for(b=0;5>b;b++)for(d=0;d<e.length;d++)b!=d&&e[b][1]!=e[d][1]&&e[b][2]!=e[d][2]&&e[b][1]<e[d][1]&&e[b][2]<e[d][2]&&4>Math.abs(e[b][1]-e[d][1])&&4>Math.abs(e[b][2]-e[d][2])&&q.push([b,d]);q.sort(function(a,c){return e[a[0]][0]+e[a[1]][0]>e[c[0]][0]+e[c[1]][0]});10<q.length&&(q.length=10);d=[];for(b=0;b<q.length;b++)d.push([e[q[b][0]],e[q[b][1]]]);return d}function r(a,c){var b=q(a,c),d;if(!b.length)return null;d=b[0][0];var e=b[0][1],b=
e[1]-d[1],e=e[2]-d[2],f=a.slice(d[1]),f=f.concat(a.slice(0,d[1])),h=c.slice(d[2]),h=h.concat(c.slice(0,d[2])),m=[];for(d=b;d<f.length;d++)m.push(f[d]);m.push(f[0]);for(d=e;d<h.length;d++)m.push(h[d]);m.push(h[0]);var r=[];for(d=0;d<=b;d++)r.push(f[d]);for(d=0;d<=e;d++)r.push(h[d]);return[m,r]}function b(a){for(var c=[0,0],b=0;b<a.length;b++)c[0]+=a[b][0],c[1]+=a[b][1];c[0]/=a.length;c[1]/=a.length;return c}function f(a,c,b){for(var d=[],e=0;e<a.length;e++){var f=[a[e][0]-c[0],a[e][1]-c[1]],h=Math.sqrt(f[0]*
f[0]+f[1]*f[1])+b,f=Math.atan2(f[1],f[0]);d[e]=[c[0]+Math.cos(f)*h,c[1]+Math.sin(f)*h]}return d}function a(a,c,b,d,e){var f,h=a.points.length;if(c.length!=b.length)return null;var m=c.length;for(f=0;f<m;f++)a.addPoint([c[f][0],c[f][1],d]);for(f=0;f<m;f++)a.addPoint([b[f][0],b[f][1],e]);for(f=0;f<m-1;f++)a.addFace([h+f,h+f+1,h+(f+m+1),h+(f+m)]);f=m-1;a.addFace([h+f,h,h+m,h+(f+m)])}function c(a){this.points=a;this.cuts=[];this.result=[]}var d=h.undef,e=1.0E-10;c.prototype={cut:function(a){this.cuts.push(a)},
toMesh:function(a){if(0!==this.points.length){var c;a||(a=new CubicVR.Mesh);this.result=[this.points];for(c=0;c<this.cuts.length;c++){var b=this.cuts[c].points.slice(0),b=b.reverse(),b=r(this.result[0],b);this.result[0]=b[0];this.result.push(b[1])}for(c=0;c<this.result.length;c++)t(a,this.result[c]);a.removeDoubles();return a}},toExtrudedMesh:function(c,b,e){if(0!==this.points.length){var f,h;b===d&&(b=0);e===d&&(e=0);var m=b!=e;c||(c=new CubicVR.Mesh);this.result=[this.points];for(h=0;h<this.cuts.length;h++)f=
this.cuts[h].points.slice(0),f=f.reverse(),f=r(this.result[0],f),this.result[0]=f[0],this.result.push(f[1]);f=new CubicVR.Mesh;for(h=0;h<this.result.length;h++)t(f,this.result[h],e);c.booleanAdd(f);f.flipFaces();if(m)for(h=0;h<f.points.length;h++)f.points[h][2]=b;c.booleanAdd(f);if(m){a(c,this.points,this.points,b,e);for(h=0;h<this.cuts.length;h++)f=this.cuts[h].points.slice(0),f=f.reverse(),a(c,f,f,b,e)}c.removeDoubles();return c}},toExtrudedBeveledMesh:function(c,d,e,h,m,q,v){var x=[],A=[],B,G,
u,y;if(0!==this.points.length){"object"===typeof d&&(v=d,d=v.front||0,e=v.back||0,h=v.frontDepth||0,m=v.frontShift||0,q=v.backDepth||0,v=v.backShift||0);var D=d!==e,z=0!==q,F=0!==h;c||(c=new CubicVR.Mesh);F?(G=b(this.points),G=f(this.points,G,-m),this.result=[G.slice(0)]):this.result=[this.points.slice(0)];for(y=0;y<this.cuts.length;y++)u=b(this.cuts[y].points),u=f(this.cuts[y].points,u,m),u=u.reverse(),x.push(u),u=r(this.result[0],u),this.result[0]=u[0],this.result.push(u[1]);m=new CubicVR.Mesh;
for(y=0;y<this.result.length;y++)t(m,this.result[y],d-h);m.flipFaces();c.booleanAdd(m);if(z||F){B=b(this.points);B=f(this.points,B,-v);this.result=[B.slice(0)];for(y=0;y<this.cuts.length;y++)u=b(this.cuts[y].points),u=f(this.cuts[y].points,u,v),u=u.reverse(),A.push(u),u=r(this.result[0],u),this.result[0]=u[0],this.result.push(u[1]);m=new CubicVR.Mesh;for(y=0;y<this.result.length;y++)t(m,this.result[y],e+q)}else{for(y=0;y<m.points.length;y++)m.points[y][2]=e;m.flipFaces()}c.booleanAdd(m);F&&a(c,G,
this.points,d-h,d);D&&a(c,this.points,this.points,d,e);z&&a(c,this.points,B,e,e+q);for(y=0;y<x.length;y++)u=this.cuts[y].points.slice(0).reverse(),F&&a(c,x[y],u,d-h,d),D&&a(c,u,u,d,e),z&&a(c,u,A[y],e,e+q);c.removeDoubles();return c}}};return{polygon:{triangulate2D:x,toMesh:t,findNearPair:function(a,c){for(var b=[0,0],d=m(a[0],c[0]),e=a.length,f=c.length,h=0;h<e;h++)for(var q=0;q<f;q++){var r=m(a[h],c[q]);r<d&&(b[0]=h,b[1]=q,d=r)}return b},subtract:r,addOffset:function(a,c){for(var b=[],d=0,e=a.length;d<
e;d++){var f=a[d];b.push([f[0]+c[0],f[1]+c[1]])}return b}},Polygon:c}});
CubicVR.RegisterModule("ScenePhysics",function(h){function x(a,c){c.setX(a[0]);c.setY(a[1]);c.setZ(a[2])}function t(a,c){c.setX(a.x);c.setY(a.y);c.setZ(a.z);c.setW(a.w)}function m(a,c){c.x=a.x();c.y=a.y();c.z=a.z();c.w=a.w()}function q(a){return new Ammo.btVector3(a[0],a[1],a[2])}function r(a){var c=new Ammo.btQuaternion;c.setEulerZYX(a[2]*(Math.PI/180),a[1]*(Math.PI/180),a[0]*(Math.PI/180));return c}function b(a){return[a.x(),a.y(),a.z()]}function f(a){this.setManifold(a)}var a=h.undef,c=h.enums;
c.physics={body:{STATIC:0,DYNAMIC:1,GHOST:2,SOFT:3},constraint:{P2P:0},collision_flags:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32},rigid_flags:{DISABLE_WORLD_GRAVITY:1},collision_types:{COLLISION_OBJECT:1,RIGID_BODY:2,GHOST_OBJECT:3,SOFT_BODY:4,HF_FLUID:5},collision_states:{ACTIVE_TAG:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5}};var d,e,g,n,o,s=function(a,c,b){var d;
!a.position&&a.sceneObject&&(d=a,a=a.sceneObject,c=d.properties,b=d.collision);d=h.get(d)||{};this.properties=new h.RigidProperties(c?h.get(c):{collision:b});this.collisionEvents=[];this.parent=null;this.init_position=a.position.slice(0);this.init_rotation=a.rotation.slice(0);this.init_linearVelocity=this.linearVelocity=d.linearVelocity||[0,0,0];this.init_angularVelocity=this.angularVelocity=d.angularVelocity||[0,0,0];this.init_impulse=this.impulse=d.impulse||[0,0,0];this.init_impulsePosition=this.impulsePosition=
d.impulsePosition||[0,0,0];this.collision_flags=this.rigid_flags=null;this.sceneObject=a;this.transform=new Ammo.btTransform;this.transform.setIdentity();this.transform.setOrigin(q(this.init_position));this.transform.setRotation(r(this.init_rotation));this.shape=null;this.motionState=new Ammo.btDefaultMotionState(this.transform);this.localInertia=new Ammo.btVector3(0,0,0);this.ghost=this.body=this.bodyInit=null;this.noDeactivate=!1};s.prototype={getProperties:function(){return this.properties},getSceneObject:function(){return this.sceneObject},
getInitialPosition:function(){return this.init_position},getInitialRotation:function(){return this.init_rotation},setInitialPosition:function(){this.init_position=init_position_in},setInitialRotation:function(){this.init_rotation=init_rotation_in},getType:function(){return this.properties.type},getMass:function(){return this.properties.mass},getRestitution:function(){return this.properties.restitution},getCollisionMap:function(){return this.properties.collision},setMass:function(a){this.properties.mass=
a;this.body&&this.body.setMassProps(a,this.localInertia)},setRestitution:function(a){this.restitution=a},getBody:function(){if(!this.body&&!this.ghost){var a=this.getCollisionShape();this.getType()===c.physics.body.GHOST?(this.body=null,this.ghost=new Ammo.btGhostObject,this.ghost.setCollisionShape(a),this.ghost.setWorldTransform(this.transform),this.ghost._cvr_rigidbody=this):(this.getMass()&&a.calculateLocalInertia(this.getMass(),this.localInertia),this.bodyInit=new Ammo.btRigidBodyConstructionInfo(this.getMass(),
this.motionState,a,this.localInertia),this.friction&&this.bodyInit.set_m_friction(this.friction),this.body=new Ammo.btRigidBody(this.bodyInit),this.getRestitution()&&this.body.setRestitution(this.getRestitution()),x(this.linearVelocity,n),this.body.setLinearVelocity(n),x(this.angularVelocity,n),this.body.setAngularVelocity(n),h.vec3.equal([0,0,0],this.impulse)||(x(this.impulse,n),x(this.impulsePosition,o),this.body.applyImpulse(n,o)),this.rigid_flags&&this.body.setFlags(this.rigid_flags),this.collision_flags&&
this.body.setFlags(this.collision_flags),this.body._cvr_rigidbody=this)}return this.body||this.ghost},updateSceneObject:function(a){if(this.body&&(this.body.isActive()||a))return this.body.getMotionState().getWorldTransform(d),a=d.getOrigin(),a.x!=a.x?console.log("origin is NaN"):(this.sceneObject.position[0]=a.x(),this.sceneObject.position[1]=a.y(),this.sceneObject.position[2]=a.z()),a=d.getRotation(),e.x=a.x(),e.y=a.y(),e.z=a.z(),e.w=a.w(),e.x!=e.x?console.log("rotation is NaN"):(a=e.toEuler(),
this.sceneObject.rotation[0]=a[0],this.sceneObject.rotation[1]=a[1],this.sceneObject.rotation[2]=a[2]),!0},reset:function(){if(this.body){var a=this.body.getWorldTransform().getOrigin();x(this.init_position,a);this.body.getWorldTransform().getRotation();this.resetMotion();a=this.init_rotation;e.fromEuler(a[0],a[1],a[2]);a=[e.x,e.y,e.z,e.w];g.setX(a[0]);g.setY(a[1]);g.setZ(a[2]);g.setW(a[3]);this.body.getWorldTransform().setRotation(g);this.activate()}},resetMotion:function(){x(this.init_linearVelocity,
n);this.body.setLinearVelocity(n);x(this.init_angularVelocity,n);this.body.setAngularVelocity(n);h.vec3.equal([0,0,0],this.init_impulse)||(x(this.init_impulse,n),x(this.init_impulsePosition,o),this.body.applyImpulse(n,o))},getCollisionShape:function(){if(!this.shape){var a;a=this.getCollisionMap();if(a.getResult())a=a.getResult();else{var b=a.getShapes(),e,f,g,m,n,o,s,t=[],w=null;f=0;for(g=b.length;f<g;f++){e=b[f];w=null;if(e.type===c.collision.shape.BOX)w=new Ammo.btBoxShape(new Ammo.btVector3(e.size[0]/
2,e.size[1]/2,e.size[2]/2));else if(e.type===c.collision.shape.SPHERE)w=new Ammo.btSphereShape(e.radius);else if(e.type===c.collision.shape.CAPSULE)w=new Ammo.btCapsuleShape(e.radius,e.height);else if(e.type===c.collision.shape.CYLINDER)w=new Ammo.btCylinderShape(new Ammo.btVector3(e.size[0]/2,e.size[1]/2,e.size[2]/2));else if(e.type===c.collision.shape.CONE)w=new Ammo.btConeShape(e.radius,e.height);else if(e.type===c.collision.shape.MESH){s=e.mesh;w=new Ammo.btTriangleMesh;o=e.size;var E=new Ammo.btVector3(0,
0,0),J=new Ammo.btVector3(0,0,0),L=new Ammo.btVector3(0,0,0),M=s.getMaterials();m=0;for(n=s.faces.length;m<n;m++){var K=s.faces[m];M[K.material].collision&&3===K.points.length&&(E.setValue(s.points[K.points[0]][0]*o[0],s.points[K.points[0]][1]*o[1],s.points[K.points[0]][2]*o[2]),J.setValue(s.points[K.points[1]][0]*o[0],s.points[K.points[1]][1]*o[1],s.points[K.points[1]][2]*o[2]),L.setValue(s.points[K.points[2]][0]*o[0],s.points[K.points[2]][1]*o[1],s.points[K.points[2]][2]*o[2]),w.addTriangle(E,J,
L))}0===this.getMass()||this.getType()==c.physics.body.STATIC||this.getType()==c.physics.body.GHOST?(this.setMass(0),w=new Ammo.btBvhTriangleMeshShape(w,!0)):w=new Ammo.btConvexTriangleMeshShape(w,!0)}else if(e.type===c.collision.shape.CONVEX_HULL){s=e.mesh;o=e.size;E=new Ammo.btVector3(0,0,0);w=new Ammo.btConvexHullShape;m=0;for(n=s.points.length;m<n;m++)x([s.points[m][0]*o[0],s.points[m][1]*o[1],s.points[m][2]*o[2]],E),w.addPoint(E)}else if(e.type===c.collision.shape.HEIGHTFIELD){var J=E=s=o=0,
N;e.landscape&&!e.getHeightField&&e.landscape instanceof h.HeightField?e.heightfield=e.landscape:e.landscape&&e.landscape instanceof h.Landscape&&(o=e.landscape.getHeightField().getDivX(),E=e.landscape.getHeightField().getDivZ(),s=e.landscape.getHeightField().getSizeX(),J=e.landscape.getHeightField().getSizeZ(),N=e.landscape.getMesh().points,e.landscape.getHeightField());e.heightfield&&e.heightfield instanceof h.HeightField&&(o=e.heightfield.getDivX(),E=e.heightfield.getDivZ(),s=e.heightfield.getSizeX(),
J=e.heightfield.getSizeZ(),N=e.getMesh().points);w=Ammo.allocate(4*N.length,"float",Ammo.ALLOC_NORMAL);m=0;for(n=o*E;m<n;m++)Ammo.setValue(w+(m<<2),N[m][1],"float");w=new Ammo.btHeightfieldTerrainShape(o,E,w,1,-100,100,1,0,!1);w.setUseDiamondSubdivision(!0);m=new Ammo.btVector3(s/o,1,J/E);w.setLocalScaling(m)}w&&(0!==e.margin&&w.setMargin(e.margin),t.push({cShape:e,btShape:w}))}b=null;if(1===t.length)b=t[0].btShape;else if(1<t.length){d=new Ammo.btTransform;b=new Ammo.btCompoundShape(!1);f=0;for(g=
t.length;f<g;f++)d.setIdentity(),d.setOrigin(q(t[f].cShape.position)),d.setRotation(r(t[f].cShape.rotation)),b.addChildShape(d,t[f].btShape)}a.setResult(b);a=b}this.shape=a}return this.shape},setAngularVelocity:function(a){this.angularVelocity=a;this.body&&(x(a,n),this.body.setAngularVelocity(n))},setGravity:function(a){this.gravity=a;this.body&&(x(a,n),this.body.setGravity(n))},getGravity:function(){return this.gravity&&!this.body?this.gravity:b(this.body.getGravity())},setLinearVelocity:function(a){this.linearVelocity=
a;this.body&&(x(a,n),this.body.setLinearVelocity(n))},applyImpulse:function(a,c){this.impulse=a||[0,0,0];this.impulsePosition=c||[0,0,0];this.body&&!h.vec3.equal([0,0,0],a)&&(x(this.impulse,n),x(this.impulsePosition,o),this.body.applyImpulse(n,o))},applyForce:function(a,c){this.body&&!h.vec3.equal([0,0,0],a)&&(x(a,n),x(c,o),this.body.applyImpulse(n,o))},getAngularVelocity:function(){return b(this.body.getAngularVelocity())},getLinearVelocity:function(){return b(this.body.getLinearVelocity())},activate:function(a){this.noDeactivate=
a||!1;this.body&&(this.noDeactivate&&this.body.setActivationState(c.physics.collision_states.DISABLE_DEACTIVATION),this.body.activate())},setAngularFactor:function(c){this.body&&c!==a&&(c.length||(c=[c,c,c]),x(c,n),this.body.setAngularFactor(n))},isActive:function(){return this.body?this.body.isActive():!1},isStatic:function(){return this.properties.type==c.physics.body.STATIC},setRigidFlags:function(a){this.rigid_flags=a;this.body&&this.body.setFlags(a)},setCollisionFlags:function(a){this.collision_flags=
a=h.parseEnum(c.physics.collision_flags,a);this.body&&this.body.setCollisionFlags(a)},setPosition:function(a){this.position=a;if(this.body||this.ghost)x(a,n),this.body&&this.body.getCenterOfMassTransform().setOrigin(n),this.ghost&&this.ghost.getWorldTransform().setOrigin(n)},getRotation:function(){if(!this.body&&!this.ghost)return this.init_rotation;this.body&&this.body.getCenterOfMassTransform().getRotation(g);this.ghost&&this.ghost.getWorldTransform().getRotation(g);var a=new h.Quaternion;m(g,a);
return a},setRotation:function(a){this.rotation=a.toEuler();if(this.body||this.ghost)t(a,g),this.body&&this.body.getCenterOfMassTransform().setRotation(g),this.ghost&&this.ghost.getWorldTransform().setRotation(g)},getRotationEuler:function(){if(!this.body&&!this.ghost)return this.init_rotation;var a=new h.Quaternion;this.body&&this.body.getCenterOfMassTransform().getRotation(g);this.ghost&&this.ghost.getWorldTransform().getRotation(g);m(g,a);return a.toEuler()},setRotationEuler:function(a){this.rotation=
a;g.setEuler(this.rotation[2]*(Math.PI/180),this.rotation[1]*(Math.PI/180),this.rotation[0]*(Math.PI/180));this.body&&this.body.getCenterOfMassTransform().setRotation(g);this.ghost&&this.body.getWorldTransform().setRotation(g)}};var E=function(b){b=b||{};this.ctype=h.parseEnum(c.physics.constraint,b.ctype)||c.physics.constraint.P2P;this.strength=b.strength||0.1;this.maxImpulse=b.maxImpulse||0;this.rigidBodyA=b.rigidBodyA||b.rigidBody||null;this.rigidBodyB=b.rigidBodyB||null;this.positionA=b.positionA||
[0,0,0];this.positionB=b.positionB||b.position||[0,0,0];this.damping=b.damping!=a?b.damping:1;this.btConstraint=null;this.localPivotA=q(this.positionA);this.localPivotB=q(this.positionB)};E.prototype={getConstraint:function(){if(!this.btConstraint){if(!this.rigidBodyA)return!1;this.ctype===c.physics.constraint.P2P&&(this.btConstraint=this.rigidBodyA&&this.rigidBodyB?new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.rigidBodyB.getBody(),this.localPivotA,this.localPivotB):new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),
this.localPivotA),this.btConstraint.get_m_setting().set_m_tau(this.strength),this.btConstraint.get_m_setting().set_m_damping(this.damping),this.maxImpulse&&this.btConstraint.get_m_setting().set_m_impulseClamp(this.maxImpulse),this.btConstraint===Ammo.NULL&&(this.btConstraint=null))}return this.btConstraint},setStrength:function(a){this.strength=a;this.btConstraint&&this.btConstraint.get_m_setting().set_m_tau(this.strength)},setDamping:function(a){this.damping=a;this.btConstraint&&this.btConstraint.get_m_setting().set_damping(this.damping)},
setMaxImpulse:function(a){this.maxImpulse=a;this.btConstraint&&this.btConstraint.get_m_setting().set_impulseClamp(this.maxImpulse)},getStrength:function(){return this.strength},setPosition:function(a){this.positionB=a;this.btConstraint&&(x(this.positionB,this.localPivotB),this.btConstraint.setPivotB(this.localPivotB))},getPosition:function(){return this.positionB}};f.prototype={getContact:function(){var a=this.manifold.getContactPoint(j);return a===Ammo.NULL?null:{impulse:a.getAppliedImpulse(),lifetime:a.getLifeTime(),
friction:a.get_m_combinedFriction(),positionA:b(a.getPositionWorldOnA()),positionB:b(a.getPositionWorldOnB())}},setManifold:function(a){this.numContacts=a.getNumContacts();this.manifold=a}};var w=function(){this.rigidObjects=[];this.ghostObjects=[];this.contactObjects=[];this.collisionObjects=[];this.active_count=0;this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;
this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);this.dynamicsWorld.setGravity(new Ammo.btVector3(0,-10,0));this.overlappingPairCache.getOverlappingPairCache().setInternalGhostPairCallback(new Ammo.btGhostPairCallback);if(!d||!e)n=new Ammo.btVector3,o=new Ammo.btVector3,d=new Ammo.btTransform,e=new h.Quaternion,g=new Ammo.btQuaternion};w.prototype={addConstraint:function(a){var c=
a.getConstraint();return c?(this.dynamicsWorld.addConstraint(c),a.rigidBodyA.activate(!0),!0):!1},removeConstraint:function(a){return(a=a.getConstraint())?(this.dynamicsWorld.removeConstraint(a),!0):!1},setGravity:function(a){x(a,n);this.dynamicsWorld.setGravity(n)},bindSceneObject:function(a,c){var b=new h.RigidBody(a,c);this.rigidObjects.push(b);b.getBody();b.activate();this.dynamicsWorld.addRigidBody(b.getBody());b.updateSceneObject(!0);return b},bind:function(a){a instanceof h.Vehicle?a.initBody(this):
a instanceof h.RigidBody&&this.bindRigidBody(a)},remove:function(a){a instanceof h.RigidBody&&this.removeRigidBody(a)},bindRigidBody:function(a){if(a.getType()===c.physics.body.GHOST){if(-1!==this.ghostObjects.indexOf(a))return;this.ghostObjects.push(a);var b=a.getBody();a.properties.blocker||b.setCollisionFlags(b.getCollisionFlags()+c.physics.collision_flags.NO_CONTACT_RESPONSE);this.dynamicsWorld.addCollisionObject(b)}else{if(-1!==this.rigidObjects.indexOf(a))return;this.rigidObjects.push(a);b=
a.getBody();a.activate();this.dynamicsWorld.addRigidBody(b);a.updateSceneObject(!0)}var d,e;if((d=a.getSceneObject())&&(e=d.getEventHandler()))e.hasEvent(c.event.CONTACT)&&this.contactObjects.push(a),e.hasEvent(c.event.COLLIDE)&&this.collisionObjects.push(a)},removeRigidBody:function(a){if(a.getType()===c.physics.body.GHOST){if(-1===this.ghostObjects.indexOf(a))return;this.ghostObjects.splice(this.ghostObjects.indexOf(a),1);this.dynamicsWorld.removeCollisionObject(a.getBody())}else{if(-1===this.rigidObjects.indexOf(a))return;
this.rigidObjects.splice(this.rigidObjects.indexOf(a),1);this.dynamicsWorld.removeRigidBody(a.getBody())}var b,d;if((b=a.getSceneObject())&&(d=b.getEventHandler()))d.hasEvent(c.event.CONTACT)&&-1!==this.contactObjects.indexOf(a)&&this.contactObjects.splice(this.contactObjects.indexOf(a),1),d.hasEvent(c.event.COLLIDE)&&-1!==this.collisionObjects.indexOf(a)&&this.collisionObjects.splice(this.collisionObjects.indexOf(a),1)},getActiveCount:function(){return this.active_count},stepSimulation:function(a,
c){this.dynamicsWorld.stepSimulation(a,c||2);for(var b=0,d=0,e=this.rigidObjects.length;d<e;d++)this.rigidObjects[d].updateSceneObject()&&b++;this.active_count=b},triggerEvents:function(){var a,b,d,e,g=this.dynamicsWorld;if(this.contactObjects.length){var h=g.getDispatcher().getNumManifolds();for(a=0;a<h;a++){var m=g.getDispatcher().getManifoldByIndexInternal(a),n=Ammo.wrapPointer(m.getBody0(),Ammo.btRigidBody)._cvr_rigidbody||null,o=Ammo.wrapPointer(m.getBody1(),Ammo.btRigidBody)._cvr_rigidbody||
null;if(n&&(e=n.getSceneObject())&&(b=e.getEventHandler())&&b.hasEvent(c.event.CONTACT))d=b.triggerEvent(c.event.CONTACT),d.self=n,d.other=o,d.contacts?d.contacts.setManifold(m):d.contacts=new f(m);else if(o&&o.isStatic()&&(e=o.getSceneObject())&&(b=e.getEventHandler())&&b.hasEvent(c.event.CONTACT))d=b.triggerEvent(c.event.CONTACT),d.other=n,d.self=o,d.contacts?d.contacts.setManifold(m):d.contacts=new f(m)}}g=this.collisionObjects.length;for(a=0;a<g;a++)if(n=this.collisionObjects[a],(e=n.getSceneObject())&&
(b=e.getEventHandler())&&b.hasEvent(c.event.COLLIDE))if(d=b.getProperties(c.event.COLLIDE),m=d.collidesWith,d.mf=d.mf||[],d.alg=d.alg||[],m&&m.length){h=[];n=n.getBody();a=0;for(iMax=m.length;a<iMax;a++){var o=m[a],q=o.getBody();d.mf[a]||(d.mf[a]=new Ammo.btManifoldResult(n,q));d.alg[a]||(d.alg[a]=this.dynamicsWorld.getDispatcher().findAlgorithm(n,q));d.alg[a].processCollision(n,q,this.dynamicsWorld.getDispatchInfo(),d.mf[a]);0<d.mf[a].getPersistentManifold().getNumContacts()&&(h.push(o),this.dynamicsWorld.getDispatcher().clearManifold(d.mf[a].getPersistentManifold()))}if(h.length&&
(d=b.triggerEvent(c.event.COLLIDE)))d.collisions=h}g=this.ghostObjects.length;for(a=0;a<g;a++)if(d=this.ghostObjects[a],e=d.getSceneObject())if((b=e.getEventHandler())&&b.hasEvent(c.event.CONTACT_GHOST))if(e=d.getBody(),h=e.getNumOverlappingObjects()){d=b.triggerEvent(c.event.CONTACT_GHOST);d.contacts=d.contacts||[];d.contacts.length>h&&(d.contacts.length=h);for(b=0;b<h;b++)m=Ammo.btRigidBody.prototype.upcast(e.getOverlappingObject(b)),d.contacts[b]=m._cvr_rigidbody||null}},reset:function(){for(var a=
0,c=this.rigidObjects.length;a<c;a++)this.rigidObjects[a].reset()},getRayHit:function(a,c,d,e){var f,a=q(a);f=q(c);d=d||!1;e=e||!1;c=new Ammo.ClosestRayResultCallback(a,f);this.dynamicsWorld.rayTest(a,f,c);if(c.hasHit()&&(body=Ammo.btRigidBody.prototype.upcast(c.get_m_collisionObject()),body!==Ammo.NULL&&!(body.isStaticObject()&&!d||body.isKinematicObject()&&!e))){d=body;e=c.get_m_hitPointWorld();a=d.getCenterOfMassTransform().inverse().op_mul(e);if(f=d._cvr_rigidbody)return Ammo.destroy(c),{position:b(e),
localPosition:b(a),rigidBody:f,ammoBody:d};Ammo.destroy(c);return{position:b(e),localPosition:b(a),rigidBody:null,ammoBody:d}}Ammo.destroy(c)}};return{ScenePhysics:w,Constraint:E,RigidProperties:function(b){this.type=h.parseEnum(c.physics.body,b.type);this.mass=b.mass!==a?b.mass:this.type?1:0;this.size=b.size||[1,1,1];this.restitution=b.restitution||(this.type?0:1);this.friction=b.friction||1;if((this.collision=b.collision)&&!this.collision.getShapes)this.collision=new h.CollisionMap(this.collision);
this.blocker=b.blocker||!1},RigidBody:s,vec3bt_copy:x,btvec3_copy:function(a,c){c[0]=a.x();c[1]=a.y();c[2]=a.z()},quatbt_copy:t,btquat_copy:m}});
CubicVR.RegisterModule("CollisionMap",function(h){var x=h.enums;x.collision={shape:{BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,MESH:5,HEIGHTFIELD:6,CONVEX_HULL:7}};var t=function(h){this.shapes=[];this.result=null;if(h){h&&!h.length&&(h=[h]);for(var q=0,r=h.length;q<r;q++)this.addShape(h[q])}};t.prototype={addShape:function(m){m.type=h.parseEnum(x.collision.shape,m.type);m.position=m.position||[0,0,0];m.rotation=m.rotation||[0,0,0];m.size=m.size||[1,1,1];m.radius=m.radius||1;m.height=m.height||1;
m.margin=m.margin||0;m.mesh=m.mesh||null;this.shapes.push(m)},getShapes:function(){return this.shapes},setResult:function(h){this.result=h},getResult:function(){return this.result}};return{CollisionMap:t}});
CubicVR.RegisterModule("RigidVehicle",function(h){var x=h.undef,t=h.enums,m,q,r=function(b){var b=h.get(b)||{},a=b.mesh,c=b.collision;this.maxEngineForce=b.maxEngineForce||2E3;this.maxBreakingForce=b.maxBreakingForce||125;this.steeringClamp=b.steeringClamp||0.51;this.mass=b.mass||400;this.rightIndex=this.gVehicleSteering=this.gBreakingForce=this.gEngineForce=0;this.upIndex=1;this.forwardIndex=2;this.m_tuning=this.m_vehicle=this.m_vehicleRayCaster=null;this.wheelDirectionCS0=new Ammo.btVector3;this.wheelAxleCS=
new Ammo.btVector3;this.wheels=[];this.bodyMesh=a;this.bodyCollision=new h.CollisionMap(c);this.sceneObject=new h.SceneObject(this.bodyMesh);if(!m||!q)new Ammo.btVector3,new Ammo.btVector3,m=new Ammo.btTransform,q=new h.Quaternion,new Ammo.btQuaternion;if(b.wheels!=x){a=0;for(c=b.wheels.length;a<c;a++){var d=b.wheels[a];d instanceof h.VehicleWheel?this.addWheel(d):this.addWheel(new h.VehicleWheel(d))}}};r.prototype={getSceneObject:function(){return this.sceneObject},initBody:function(b){this.body=
new h.RigidBody(this.sceneObject,{collision:this.bodyCollision,mass:this.mass,restitution:0.1});h.vec3bt_copy([0,-1,0],this.wheelDirectionCS0);h.vec3bt_copy([-1,0,0],this.wheelAxleCS);this.gVehicleSteering=0;this.body.setLinearVelocity([0,0,0]);this.body.setAngularVelocity([0,0,0]);this.m_vehicleRayCaster=new Ammo.btDefaultVehicleRaycaster(b.dynamicsWorld);this.m_tuning=new Ammo.btVehicleTuning;this.m_vehicle=new Ammo.btRaycastVehicle(this.m_tuning,this.body.getBody(),this.m_vehicleRayCaster);this.body.getBody().setActivationState(t.physics.collision_states.DISABLE_DEACTIVATION);
this.m_vehicle.setCoordinateSystem(this.rightIndex,this.upIndex,this.forwardIndex);for(var a=new Ammo.btVector3,c=0;c<this.wheels.length;c++)h.vec3bt_copy(this.wheels[c].getWheelPosition(),a),this.m_vehicle.addWheel(a,this.wheelDirectionCS0,this.wheelAxleCS,this.wheels[c].getSuspensionRest(),this.wheels[c].getWheelRadius(),this.m_tuning,this.wheels[c].getSteering());b.dynamicsWorld.addVehicle(this.m_vehicle);b.bind(this.body);this.updateSuspension()},evaluate:function(){for(var b=this.m_vehicle.getNumWheels(),
a=0;a<b;a++){this.wheels[a].isSteering()&&this.m_vehicle.setSteeringValue(this.gVehicleSteering,a);this.wheels[a].isBraking()&&this.m_vehicle.setBrake(this.gBrakingForce,a);this.wheels[a].isDriving()&&this.m_vehicle.applyEngineForce(this.gEngineForce,a);this.m_vehicle.updateWheelTransform(a,!0);var c=this.m_vehicle.getWheelTransformWS(a),d=c.getOrigin();this.wheels[a].wheelObj.position[0]=d.x();this.wheels[a].wheelObj.position[1]=d.y();this.wheels[a].wheelObj.position[2]=d.z();c=c.getRotation();q.x=
c.x();q.y=c.y();q.z=c.z();q.w=c.w();c=q.toEuler();this.wheels[a].wheelObj.rotation[0]=c[0];this.wheels[a].wheelObj.rotation[1]=c[1];this.wheels[a].wheelObj.rotation[2]=c[2]}this.body.isActive()||this.body.activate();this.updateSceneObject(!0)},getRigidBody:function(){return this.body},updateSceneObject:function(b){if(this.body&&(this.body.isActive()||b))return this.body.getBody().getMotionState().getWorldTransform(m),b=m.getOrigin(),b.x!=b.x?console.log("origin is NaN"):(this.sceneObject.position[0]=
b.x(),this.sceneObject.position[1]=b.y(),this.sceneObject.position[2]=b.z()),b=m.getRotation(),q.x=b.x(),q.y=b.y(),q.z=b.z(),q.w=b.w(),q.x!=q.x?console.log("rotation is NaN"):(b=q.toEuler(),this.sceneObject.rotation[0]=b[0],this.sceneObject.rotation[1]=b[1],this.sceneObject.rotation[2]=b[2]),!0},setEngineForce:function(b){this.gEngineForce=b;this.gEngineForce>this.maxEngineForce&&(this.gEngineForce=this.maxEngineForce);this.gEngineForce<-this.maxEngineForce&&(this.gEngineForce=-this.maxEngineForce)},
getEngineForce:function(){return this.gEngineForce},incEngine:function(b){this.setEngineForce(this.getEngineForce()+b)},decEngine:function(b){this.setEngineForce(this.getEngineForce()-b)},setSteering:function(b){this.gVehicleSteering=b},getSteering:function(){return this.gVehicleSteering},incSteering:function(b){this.gVehicleSteering+=b;this.gVehicleSteering>this.steeringClamp&&(this.gVehicleSteering=this.steeringClamp);this.gVehicleSteering<-this.steeringClamp&&(this.gVehicleSteering=-this.steeringClamp)},
setBrake:function(b){this.gBreakingForce=b},getWheelGroundPosition:function(b){return this.wheels[b].wheelObj.getWorldPosition()-[0,wheels[b].getWheelRadius(),0]},getWheelSkid:function(b){return this.m_vehicle.getWheelInfo(b).get_m_skidInfo()},getRigidGround:function(b){this.m_vehicle.getWheelInfo(b)},addWheel:function(b,a){a===x&&(a=this.wheels.length);this.wheels[a]=b},getWheel:function(b){return this.wheels[b]},bindToScene:function(b){for(var a=this.wheels.length,c=0;c<a;c++)b.bind(this.getWheelObj(c));
b.bind(this.getSceneObject())},getWheelObj:function(b){return this.getWheel(b).wheelObj},updateSuspension:function(){var b,a=this.m_vehicle.getNumWheels();for(b=0;b<a;b++){var c=this.m_vehicle.getWheelInfo(b);c.set_m_suspensionStiffness(this.wheels[b].getSuspensionStiffness());c.set_m_suspensionRestLength1(this.wheels[b].getSuspensionRest());c.set_m_wheelsDampingRelaxation(this.wheels[b].getDampingRelaxation());c.set_m_wheelsDampingCompression(this.wheels[b].getDampingCompression());c.set_m_frictionSlip(this.wheels[b].getFrictionSlip());
c.set_m_rollInfluence(this.wheels[b].getRollInfluence())}if(this.m_vehicle){this.m_vehicle.resetSuspension();for(b=0;b<a;b++)this.m_vehicle.updateWheelTransform(b,!0)}},getMass:function(){return this.mass},setMass:function(b){this.mass=b;this.body&&this.body.setMass(this.mass)}};var b=function(b){b=h.get(b)||{};this.wheelRef=new h.SceneObject;this.wheelObj=new h.SceneObject;this.wheelRef.scale=b.scale||[1,1,1];this.wheelRadius=b.radius||0;this.wheelWidth=b.width||0;b.mesh!=x&&this.setModel(b.mesh);
this.suspensionStiffness=b.suspensionStiffness||40;this.suspensionRest=b.suspensionRest||0.05;this.dampingRelaxation=b.dampingRelaxation||2.3;this.dampingCompression=b.dampingCompression||2.4;this.frictionSlip=b.frictionSlip||0.94;this.rollInfluence=b.rollInfluence||0.5;this.wheelPosition=b.position||[0,0,0];this.wheelRotation=[0,0,0];this.steering=b.steering||!1;this.braking=b.braking||!1;this.driving=b.driving||!1};b.prototype={setModel:function(b,a,c){this.wheelModel=b;this.wheelRadius=a||0;this.wheelWidth=
c||0;0===this.wheelRadius&&(this.wheelRadius=(this.wheelModel.bb[1][1]-this.wheelModel.bb[0][1])/2,this.wheelRadius+=(this.wheelModel.bb[1][2]-this.wheelModel.bb[0][2])/2,this.wheelRadius/=2);0===this.wheelWidth&&(this.wheelWidth=this.wheelModel.bb[1][0]-this.wheelModel.bb[0][0]);this.wheelRef.obj=this.wheelModel;this.wheelObj.bindChild(this.wheelRef)},setSuspensionStiffness:function(b){this.suspensionStiffness=b},getSuspensionStiffness:function(){return this.suspensionStiffness},setSuspensionRest:function(b){this.suspensionRest=
b},getSuspensionRest:function(){return this.suspensionRest},setDampingRelaxation:function(b){this.dampingRelaxation=b},getDampingRelaxation:function(){return this.dampingRelaxation},setDampingCompression:function(b){this.dampingCompression=b},getDampingCompression:function(){return this.dampingCompression},setFrictionSlip:function(b){this.frictionSlip=b},getFrictionSlip:function(){return this.frictionSlip},setRollInfluence:function(b){this.rollInfluence=b},getRollInfluence:function(){return this.rollInfluence},
setWheelRadius:function(b){this.wheelRadius=b},getWheelRadius:function(){return this.wheelRadius},setWheelWidth:function(b){this.wheelWidth=b},getWheelWidth:function(){return this.wheelWidth},setWheelRotation:function(b){this.wheelRotation=b;this.wheelRef.setRotation(wheelRotation)},getWheelRotation:function(){return this.wheelRotation},setWheelPosition:function(b){this.wheelPosition=b;this.wheelObj.position=wheelPosition},getWheelPosition:function(){return this.wheelPosition},setSteering:function(b){this.steering=
b},getSteering:function(){return this.steering},isSteering:function(){return this.steering},setBraking:function(){this.braking=this.braking_in},isBraking:function(){return this.braking},setDriving:function(b){this.driving=b},isDriving:function(){return this.driving}};return{Vehicle:r,VehicleWheel:b}});window.CubicVRShader.CubicVRCoreVS="attribute vec3 vertexPosition;\nattribute vec3 vertexNormal;\nattribute vec2 vertexTexCoord;\n#if VERTEX_COLOR\nattribute vec3 vertexColor;\nvarying vec3 vertexColorOut;\n#endif\n#if VERTEX_MORPH\nattribute vec3 vertexMorphPosition;\nattribute vec3 vertexMorphNormal;\nuniform float materialMorphWeight;\n#endif\nvarying vec2 vertexTexCoordOut;\nuniform vec2 materialTexOffset;\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#endif\nuniform mat4 matrixModelView;\nuniform mat4 matrixProjection;\nuniform mat4 matrixObject;\nuniform mat3 matrixNormal;\nvarying vec3 vertexNormalOut;\nvarying vec4 vertexPositionOut;\n#if !LIGHT_DEPTH_PASS\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform mat4 lightShadowMatrix[LIGHT_COUNT];\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#endif \nvoid cubicvr_normalMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( vertexNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( vertexNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(vertexNormal, tangent);\nbinormal = normalize(binormal);\nmat4 uMVOMatrix = matrixModelView * matrixObject;\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (vertexNormal, 0.0)))\n);\nenvEyeVectorOut = vec3(uMVOMatrix * vec4(vertexPosition,1.0)) * TBNMatrix;\n#endif\n#endif\n}\nvoid cubicvr_environmentMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nenvTexCoordOut = normalize( vertexPositionOut.xyz );\n#else\nvec3 ws = (matrixModelView * vec4(vertexPosition,1.0)).xyz;\nvec3 r = reflect(ws, vertexNormalOut );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nenvTexCoordOut.s = r.x/m + 0.5;\nenvTexCoordOut.t = r.y/m + 0.5;\n#endif\n#endif\n#if VERTEX_COLOR\nvertexColorOut = vertexColor;\n#endif\n#endif\n}\nvoid cubicvr_shadowMap() {\n#if (LIGHT_IS_SPOT||LIGHT_IS_AREA) && LIGHT_SHADOWED\nfor (int i = 0; i < LIGHT_COUNT; i++)\n{\n#if LIGHT_SHADOWED\n#if VERTEX_MORPH\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0));\n#else\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n}\nvoid cubicvr_lighting() {\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),vertexNormalOut),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),vertexNormalOut),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(vertexNormalOut, normalize(l)));\nfloat NdotH = max(0.0, dot(vertexNormalOut, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\nspec2 = lightSpecular[i] * materialSpecular * power;\nspecTotal += spec2*spotEffect;\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#endif \ncubicvr_normalMap();\ncubicvr_shadowMap();\ncubicvr_environmentMap();\n}\nvec2 cubicvr_texCoord() {\nreturn vertexTexCoord + materialTexOffset;\n}\nvec4 cubicvr_transform() {\n#if LIGHT_DEPTH_PASS\nvertexNormalOut = vec3(0.0,0.0,0.0);\n#endif\n#if VERTEX_MORPH\nvec4 vPos = matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0);\n#else\nvec4 vPos = matrixObject * vec4(vertexPosition, 1.0);\n#endif\nvertexPositionOut = matrixModelView * vPos;\nreturn vPos;\n}\nvec3 cubicvr_normal() {\n#if VERTEX_MORPH\nreturn normalize(matrixObject*vec4(vertexNormal+(vertexMorphNormal-vertexNormal)*materialMorphWeight,0.0)).xyz;\n#else\nreturn normalize(matrixObject*vec4(vertexNormal,0.0)).xyz;\n#endif\n}\n#define customShader_splice 1\nvoid main(void)\n{\nvertexTexCoordOut = cubicvr_texCoord();\ngl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n#if !LIGHT_DEPTH_PASS  \nvertexNormalOut = matrixNormal * cubicvr_normal();\ncubicvr_lighting();\n#endif \n}\n";
window.CubicVRShader.CubicVRCoreFS="#ifdef GL_ES\n#if LIGHT_PERPIXEL\nprecision highp float;\n#else\nprecision lowp float;\n#endif\n#endif\n#if FOG_ENABLED\nuniform vec3 fogColor;\nuniform float fogDensity;\nuniform float fogNear;\nuniform float fogFar;\n#endif\nuniform vec3 materialAmbient;\nuniform vec3 lightAmbient;\nuniform vec3 materialColor;\n#if LIGHT_PERPIXEL\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\n#endif\n#if LIGHT_IS_PROJECTOR\nuniform sampler2D lightProjectionMap[LIGHT_COUNT];\n#endif\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform sampler2D lightShadowMap[LIGHT_COUNT];\nuniform vec3 lightDepthClip[LIGHT_COUNT];\n#endif\n#else \nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif  \nvarying vec3 vertexNormalOut;\nvarying vec2 vertexTexCoordOut;\n#if VERTEX_COLOR\nvarying vec3 vertexColorOut;\n#endif\n#if FX_DEPTH_ALPHA||LIGHT_DEPTH_PASS||LIGHT_SHADOWED\nuniform vec3 postDepthInfo;\nfloat ConvertDepth3(float d) { return (postDepthInfo.x*postDepthInfo.y)/(postDepthInfo.y-d*(postDepthInfo.y-postDepthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - postDepthInfo.x ) / ( postDepthInfo.y - postDepthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if LIGHT_DEPTH_PASS\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if LIGHT_SHADOWED\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if LIGHT_SHADOWED_SOFT\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\nuniform sampler2D textureColor;\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#if TEXTURE_BUMP\nuniform sampler2D textureBump;\n#endif\n#if TEXTURE_ENVSPHERE\nuniform sampler2D textureEnvSphere;\nuniform float materialEnvironment;\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_REFLECT\nuniform sampler2D textureReflect;\n#endif\n#if TEXTURE_NORMAL\nuniform sampler2D textureNormal;\n#endif\nuniform float materialAlpha;\n#if TEXTURE_AMBIENT\nuniform sampler2D textureAmbient;\n#endif\n#if TEXTURE_SPECULAR\nuniform sampler2D textureSpecular;\n#endif\n#endif \n#if TEXTURE_ALPHA\nuniform sampler2D textureAlpha;\n#endif\nvarying vec4 vertexPositionOut;\nvec2 cubicvr_texCoord() {\n#if LIGHT_DEPTH_PASS\nreturn vertexTexCoordOut;\n#else\n#if TEXTURE_BUMP\nfloat height = texture2D(textureBump, vertexTexCoordOut.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(envEyeVectorOut);\nreturn vertexTexCoordOut.xy + (eye.xy * v);\n#else\nreturn vertexTexCoordOut;\n#endif\n#endif\n}\nvec3 cubicvr_normal(vec2 texCoord) {\n#if TEXTURE_NORMAL && !LIGHT_DEPTH_PASS\nvec3 bumpNorm = vec3(texture2D(textureNormal, texCoord));\nvec3 n = (vec4(normalize(vertexNormalOut),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nreturn normalize((n+bumpNorm)/2.0);\n#else\nreturn normalize(vertexNormalOut);\n#endif\n}\n#if FOG_ENABLED\nvec4 apply_fog(vec4 color) {\nvec4 outColor = color;\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n#if USE_FOG_EXP\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\n#if USE_FOG_LINEAR\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\nreturn outColor;\n}\n#endif\nvec4 cubicvr_color(vec2 texCoord) {\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\n#if !(LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA)\ncolor = texture2D(textureColor, texCoord).rgba;\ncolor.rgb *= materialColor;\n#else\ncolor = texture2D(textureColor, texCoord).rgba;\n#if !TEXTURE_ALPHA\nif (color.a<=0.9) {\ndiscard;\n}\n#endif\ncolor.rgb *= materialColor;\n#endif\n#if VERTEX_COLOR\ncolor *= vec4(vertexColorOut,1.0);\n#endif\n#else\n#if VERTEX_COLOR\ncolor = vec4(vertexColorOut,1.0);\n#else\ncolor = vec4(materialColor,1.0);\n#endif\n#endif\n#if TEXTURE_ALPHA\ncolor.a = texture2D(textureAlpha, texCoord).r;\n#if FX_DEPTH_ALPHA\nif (color.a < 0.9) discard;\n#else\n#if MATERIAL_ALPHA\nif (color.a == 0.0) discard;\n#else\nif (color.a < 0.9) discard;\n#endif\n#endif\n#else\n#if MATERIAL_ALPHA\ncolor.a = materialAlpha;\n#endif\n#endif\n#endif\nreturn color;\n}\nvec4 cubicvr_lighting(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\nvec3 accum = lightAmbient;\n#if LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nvec3 spec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_AREA\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\naccum += shadow * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#else\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if LIGHT_SHADOWED\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\n#if !LIGHT_IS_PROJECTOR\natt *= spotEffect;\n#endif\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\natt = att * shadow;\n#endif\n#if LIGHT_IS_PROJECTOR && LIGHT_SHADOWED\nif (shadowCoord.s >= 0.0&&shadowCoord.s <= 1.0 && shadowCoord.t >= 0.0 && shadowCoord.t <= 1.0 && spotDot > cos((90.0)*(3.14159/180.0))) {\nvec3 projTex = texture2D(lightProjectionMap[i],shadowCoord.st).rgb;\naccum += att * projTex * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n}\n#else\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lightSpecular[i] * materialSpecular * power;\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if LIGHT_SHADOWED\n#endif\n#endif\n#else\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb *= lightColorOut;\ncolor.rgb += lightSpecularOut;\n#endif\n#endif \n#if TEXTURE_AMBIENT\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb += texture2D(textureAmbient, texCoord).rgb*(vec3(1.0,1.0,1.0)+materialColor*materialAmbient);\n#else\ncolor.rgb = color.rgb*texture2D(textureAmbient, texCoord).rgb;\n#endif\n#else\n#if TEXTURE_COLOR\ncolor.rgb += materialAmbient*texture2D(textureColor, texCoord).rgb;\n#else\ncolor.rgb += materialColor*materialAmbient;\n#endif\n#endif\n#endif\n#if FOG_ENABLED\nreturn apply_fog(color);\n#else\nreturn color;\n#endif\n}\nvec4 cubicvr_environment(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_REFLECT\nfloat environmentAmount = texture2D( textureReflect, texCoord).r;\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvec3 r = reflect( envTexCoordOut, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * materialEnvironment;\n#endif\n#else\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * materialEnvironment;\n#endif\n#endif\n#endif \n#endif \n#if FX_DEPTH_ALPHA\n#if !MATERIAL_ALPHA\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\nreturn color;\n}\n#if LIGHT_DEPTH_PASS\nvec4 cubicvr_depthPack(vec2 texCoord) {\n#if TEXTURE_ALPHA\nfloat alphaVal = texture2D(textureAlpha, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\nreturn packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n}\n#endif\n#define customShader_splice 1\nvoid main(void)\n{\nvec2 texCoord = cubicvr_texCoord();\n#if !LIGHT_DEPTH_PASS\nvec4 color = cubicvr_color(texCoord);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n#else \ngl_FragColor = cubicvr_depthPack(texCoord);\n#endif\n}\n";
